<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Support â€” TrustDollar</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
<style>
:root {
  --green:#00c853;
  --green-dark:#00bfa5;
  --bg:#f2f5f9;
  --card:#fff;
  --muted:#777;
}
body{font-family:'Poppins',sans-serif;background:var(--bg);display:flex;flex-direction:column;height:100vh;margin:0;}
.header{background:linear-gradient(145deg,var(--green),var(--green-dark));color:#fff;padding:14px 20px;display:flex;align-items:center;justify-content:space-between;}
.header h1{margin:0;font-size:18px;}
.status{font-size:13px;opacity:0.8;}
.chat-container{flex:1;overflow-y:auto;padding:15px;display:flex;flex-direction:column;}
.msg{max-width:70%;padding:10px 14px;border-radius:12px;margin-bottom:10px;font-size:14px;word-wrap:break-word;}
.user-msg{background:var(--green);color:#fff;align-self:flex-end;border-bottom-right-radius:3px;}
.admin-msg{background:var(--card);color:#222;align-self:flex-start;border-bottom-left-radius:3px;box-shadow:0 1px 4px rgba(0,0,0,0.05);}
.seen{font-size:11px;text-align:right;color:#fff;margin-top:4px;}
.footer{display:flex;padding:10px;background:#fff;box-shadow:0 -2px 6px rgba(0,0,0,0.05);}
.footer input{flex:1;padding:10px;border:1px solid #ddd;border-radius:10px;font-size:14px;}
.footer button{margin-left:8px;background:var(--green);color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:600;}
.footer button:hover{opacity:0.9;}
.typing{font-size:13px;color:#666;margin:6px auto;text-align:center;font-style:italic;}
.chat-container::-webkit-scrollbar{width:6px;}
.chat-container::-webkit-scrollbar-thumb{background:var(--green);border-radius:10px;}
</style>
</head>
<body>

<div class="header">
  <div>
    <h1>Support</h1>
    <div id="adminStatus" class="status">Checking admin...</div>
  </div>
</div>

<div id="chatBox" class="chat-container"></div>
<div id="typing" class="typing" style="display:none;">Admin is typing...</div>

<div class="footer">
  <input type="text" id="msgInput" placeholder="Type your message...">
  <button id="sendBtn"><i class='bx bx-send'></i></button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore, collection, addDoc, doc, setDoc, updateDoc, query, orderBy, onSnapshot, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey:"AIzaSyDEQYPJFxQv8yFHptrTqoLHOn2L0PpgVhc",
  authDomain:"btcinvest-c0e25.firebaseapp.com",
  projectId:"btcinvest-c0e25",
  storageBucket:"btcinvest-c0e25.firebasestorage.app",
  messagingSenderId:"204937458487",
  appId:"1:204937458487:web:cc27ece1249999279f60b2"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const msgInput=document.getElementById("msgInput");
const sendBtn=document.getElementById("sendBtn");
const chatBox=document.getElementById("chatBox");
const typingEl=document.getElementById("typing");
const adminStatus=document.getElementById("adminStatus");

let currentUser=null;
let typingTimeout;

onAuthStateChanged(auth, async (user)=>{
  if(!user){ location.href="login.html"; return; }
  currentUser=user;
  await setDoc(doc(db,"supportChats",user.uid),{
    name:user.displayName||"User",
    email:user.email,
    online:true,
    typing:false,
    lastActive:serverTimestamp()
  },{merge:true});
  listenAdminStatus();
  listenChat(user.uid);
});

function listenAdminStatus(){
  onSnapshot(doc(db,"supportStatus","admin"),(snap)=>{
    if(!snap.exists()) return;
    const data=snap.data();
    adminStatus.textContent=data.online?"Admin online":"Admin offline";
    typingEl.style.display=data.typing?"block":"none";
  });
}

function listenChat(uid){
  const q=query(collection(db,"supportChats",uid,"messages"),orderBy("createdAt","asc"));
  onSnapshot(q,(snapshot)=>{
    chatBox.innerHTML="";
    snapshot.forEach(docSnap=>{
      const d=docSnap.data();
      const msg=document.createElement("div");
      msg.className="msg "+(d.from==="user"?"user-msg":"admin-msg");
      msg.innerHTML=`${d.text}${d.from==="user"?`<div class="seen">${d.seen?" Seen":" Not Seen"}</div>`:""}`;
      chatBox.appendChild(msg);
      if(d.from==="admin"&&!d.seen){
        updateDoc(docSnap.ref,{seen:true});
      }
    });
    chatBox.scrollTop=chatBox.scrollHeight;
  });
}

msgInput.addEventListener("input",()=>{
  updateDoc(doc(db,"supportChats",currentUser.uid),{typing:true});
  clearTimeout(typingTimeout);
  typingTimeout=setTimeout(()=>updateDoc(doc(db,"supportChats",currentUser.uid),{typing:false}),1000);
});

sendBtn.addEventListener("click",sendMessage);
msgInput.addEventListener("keypress",e=>{if(e.key==="Enter")sendMessage();});

async function sendMessage(){
  const text=msgInput.value.trim();
  if(!text)return;
  await addDoc(collection(db,"supportChats",currentUser.uid,"messages"),{
    text,from:"user",createdAt:serverTimestamp(),seen:false
  });
  msgInput.value="";
}
</script>
</body>
</html>
