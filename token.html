<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TrustDollar Exchange â€” Token Live</title>
  <style>
    :root{
      --bg:#f8fafc;--card:#fff;--muted:#64748b;
      --green:#16a34a;--red:#dc2626;--accent:#0ea5a4;
}
*{box-sizing:border-box;margin:0;padding:0;font-family:'Poppins',sans-serif;}
body{background:var(--bg);color:#0f172a;padding:12px;display:flex;justify-content:center;}
.card{width:100%;max-width:900px;background:var(--card);border-radius:16px;
box-shadow:0 6px 16px rgba(0,0,0,0.06);padding:18px;}

.logout{background:#0ea5a4;color:#fff;padding:10px 14px;border:none;border-radius:10px;
cursor:pointer;font-weight:700;font-size:14px;width:100%;margin-top:22px;}

.top{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;}
.left{display:flex;gap:10px;align-items:center;}
.symbol{width:54px;height:54px;border-radius:12px;
background:linear-gradient(135deg,#e0f2fe,#ecfdf5);
display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700;}
.title{font-size:18px;font-weight:700;}
.priceBig{font-size:24px;font-weight:800;}
.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
.btn{padding:8px 10px;border-radius:8px;border:none;cursor:pointer;font-weight:700;font-size:13px;}
.buy{background:var(--green);color:#fff;}
.sell{background:var(--red);color:#fff;}
.stake{background:var(--accent);color:#fff;}

.chart{margin-top:12px;height:160px;border-radius:10px;
background:linear-gradient(180deg,#ffffff,#f1f5f9);
display:flex;justify-content:center;align-items:center;color:var(--muted);font-weight:600;font-size:13px;}

.metaGrid{margin-top:14px;display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px;}
.meta{background:#f9fafb;padding:10px;border-radius:10px;text-align:center;}
.small{font-size:11px;color:#64748b;}

.wallet-box{margin-top:16px;background:#fff;border-radius:10px;
padding:12px;box-shadow:0 3px 10px rgba(0,0,0,0.05);}
.wallet-header{display:flex;justify-content:space-between;align-items:center;}
.wallet-total{font-size:1.1rem;font-weight:700;color:#0ea5a4;}
.trade-history{margin-top:16px;background:#fff;border-radius:10px;
box-shadow:0 3px 10px rgba(0,0,0,0.05);padding:10px;}
table{width:100%;border-collapse:collapse;margin-top:8px;}
th,td{padding:6px;text-align:left;font-size:0.78rem;border-bottom:1px solid #f1f5f9;}
th{color:#64748b;font-weight:600;}

/* Modal */
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);
display:none;justify-content:center;align-items:center;z-index:1000;}
.modal-content{background:#fff;border-radius:14px;width:90%;max-width:420px;
box-shadow:0 6px 25px rgba(0,0,0,0.3);overflow:hidden;}
.modal-header{background:linear-gradient(135deg,#0ea5a4,#06b6d4);color:#fff;
font-weight:700;font-size:1.1rem;padding:12px 16px;text-align:center;}
.modal-body{padding:18px;}
.modal-info{display:flex;justify-content:space-between;margin-bottom:12px;font-size:14px;}
.modal-input label{display:block;margin-bottom:6px;font-size:13px;color:#475569;text-align:left;}
.modal-input input{width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:8px;
font-size:15px;font-weight:600;text-align:center;}
.modal-total{display:flex;justify-content:space-between;align-items:center;
background:#f9fafb;padding:10px 14px;border-radius:10px;margin-top:10px;font-size:14px;}
.modal-actions{display:flex;justify-content:space-between;padding:14px;background:#f8fafc;}
.confirm{background:#16a34a;color:#fff;padding:10px 16px;border:none;border-radius:8px;cursor:pointer;font-weight:700;width:48%;}
.cancel{background:#e2e8f0;color:#0f172a;padding:10px 16px;border:none;border-radius:8px;cursor:pointer;font-weight:700;width:48%;}
.error{margin-top:8px;color:#dc2626;font-weight:600;text-align:center;}

#alertBox{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
background:#fff;padding:18px 24px;border-radius:12px;box-shadow:0 5px 20px rgba(0,0,0,0.2);
font-weight:700;font-size:15px;color:#0f172a;display:none;z-index:2000;text-align:center;}
#alertBox.success{border-left:6px solid #16a34a;}
#alertBox.error{border-left:6px solid #dc2626;}

/* ðŸ”¹ Fullscreen Overlay */
#loadingScreen {
position: fixed;
top: 0; left: 0;
width: 100%; height: 100%;
background: linear-gradient(135deg, #f0fdf4, #ecfeff);
display: flex;
justify-content: center;
align-items: center;
z-index: 2000;
}

/* ðŸ”¹ Glassy Box */
.loader-box {
background: rgba(255, 255, 255, 0.8);
backdrop-filter: blur(12px);
border-radius: 16px;
padding: 30px 50px;
box-shadow: 0 8px 24px rgba(0,0,0,0.1);
text-align: center;
animation: fadeIn 0.6s ease-in-out;
}

/* ðŸ”¹ Smooth Spinner */
.spinner {
width: 50px;
height: 50px;
border: 5px solid #e2e8f0;
border-top: 5px solid #0ea5a4;
border-radius: 50%;
margin: 0 auto 18px;
animation: spin 1s linear infinite;
}

/* ðŸ”¹ Text Style */
.loader-box p {
font-size: 15px;
color: #0f172a;
font-weight: 600;
letter-spacing: 0.3px;
}

/* ðŸ”¹ Animations */
@keyframes spin {
from { transform: rotate(0deg); }
to { transform: rotate(360deg); }
}

@keyframes fadeIn {
from { opacity: 0; transform: scale(0.95); }
to { opacity: 1; transform: scale(1); }
}
/* you can buy max mini */
#modalTotal {
  color: #16a34a;
  transition: all 0.2s ease;
  font-weight: 700;
}

@media (max-height: 700px) {
  .modal-content {
    transform: translateY(-50px);
  }
}

 /*green red pop up butun color */

.confirm {
  position: relative;
  overflow: hidden;
}
.confirm::after {
  content: "";
  position: absolute;
  top: 0; left: -100%;
  width: 100%; height: 100%;
  background: rgba(255,255,255,0.2);
  transform: skewX(-20deg);
  transition: 0.4s;
}
.confirm:hover::after {
  left: 100%;
}
.modal-content {
  transition: transform 0.3s ease;
}


</style>
</head>
<body>

<div class="card" id="mainCard" style="display:none;">
<div class="top">
<div class="left">
<div class="symbol" id="symbol">--</div>
<div><div class="title" id="t_name">Token</div></div>
</div>
<div class="controls">
<div class="priceBig" id="t_price">$0.00</div>
<button class="btn buy" id="btnBuy">Buy</button>
<button class="btn sell" id="btnSell">Sell</button>
<button class="btn stake">Stake</button>
</div>
</div>


<div class="chart" id="chart">
<canvas id="earningChart" style="width:100%;height:180px;"></canvas>
</div>

<div class="metaGrid">
<div class="meta"><div class="small">Your Tokens</div><div id="userBalance">0.00</div></div>
<div class="meta"><div class="small">Staked</div><div id="userStaked">0.00</div></div>
</div>

<div class="wallet-box">
<div class="wallet-header">
<div><strong>ðŸ’¼ Wallet Balance:</strong></div>
<div class="wallet-total" id="walletTotal">$0.00</div>
</div>
</div>

<div class="trade-history">
<h3> Live Trade History</h3>
<table id="tradeTable">
<thead><tr><th>Time</th><th>Token</th><th>Action</th><th>Qty</th><th>Price</th></tr></thead>
<tbody></tbody>
</table>
</div>



<!-- ðŸŸ¢ My Profit History -->
<div class="trade-history" id="profitHistoryBox">
  <h3>My Profit History</h3>
  <table id="profitHistoryTable">
    <thead>
      <tr>
        <th>Date</th>
        <th>Token</th>
        <th>Staked</th>
        <th>Profit</th>
        <th>Total Return</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>


<button id="logoutBtn" class="logout">Logout</button>

</div>

<div id="alertBox"></div>

<!-- Modal -->
<div class="modal" id="tradeModal">
<div class="modal-content">
<div class="modal-header" id="modalHeader">Trade</div>
<div class="modal-body">
<div class="modal-info">
<div><strong>Current Price:</strong> <span id="modalPrice">$0.00</span></div>
<div><strong>Available:</strong> <span id="modalWallet">$0.00</span></div>
</div>
<div class="modal-input">
<label for="modalQty">Enter Quantity</label>
<input type="number" id="modalQty" placeholder="0.00" min="0" />
</div>
<p id="maxBuyInfo" style="font-size:12px;color:#64748b;margin-top:4px;">
  You can buy 0 tokens max
</p>

<div class="modal-total"><span>Total:</span><strong id="modalTotal">$0.00</strong></div>
<div class="error" id="modalError"></div>
</div>
<div class="modal-actions">
<button class="confirm" id="confirmTrade">Confirm</button>
<button class="cancel" id="cancelTrade">Cancel</button>
</div>
</div>
</div>

<!-- âœ… Modern Professional Loader -->
<div id="loadingScreen">
<div class="loader-box">
<div class="spinner"></div>
<p>Verifying session... please wait</p>
</div>
</div>
<!-- Chart.js for smooth animated graph -->
 <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
import { 
  getFirestore, doc, getDoc, setDoc, updateDoc, addDoc, 
  collection, query, orderBy, onSnapshot, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDEQYPJFxQv8yFHptrTqoLHOn2L0PpgVhc",
  authDomain: "btcinvest-c0e25.firebaseapp.com",
  projectId: "btcinvest-c0e25",
  storageBucket: "btcinvest-c0e25.firebasestorage.app",
  messagingSenderId: "204937458487",
  appId: "1:204937458487:web:cc27ece1249999279f60b2",
  measurementId: "G-HG0Q8ZHT6G"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser, token, walletBalance = 0, currentPrice = 0;
const perMinuteRate = 0.015 / (24 * 60); // 1.5% daily

function showAlert(msg, type = "info") {
  const b = document.getElementById("alertBox");
  b.textContent = msg;
  b.className = type;
  b.style.display = "block";
  setTimeout(() => b.style.display = "none", 2000);
}

// ðŸ”¹ Auth
onAuthStateChanged(auth, async (u) => {
  if (!u) return (window.location.href = "login.html");
  currentUser = u;
  document.getElementById("loadingScreen").style.display = "none";
  document.getElementById("mainCard").style.display = "block";

  await loadUser();

  // âœ… FIX: wait a bit to ensure user & Firestore ready
  setTimeout(() => {
    loadProfitHistory();
  }, 1000);
});

async function loadUser() {
  const userRef = doc(db, "users", currentUser.uid);
  const userSnap = await getDoc(userRef);
  if (!userSnap.exists()) return;

  const data = userSnap.data();
  walletBalance = data.walletBalance ?? 0;
  document.getElementById("walletTotal").textContent = `$${walletBalance.toFixed(2)}`;

  const stored = localStorage.getItem("selectedToken");
  if (!stored) return;

  token = JSON.parse(stored);
  window.token = token;
  document.getElementById("symbol").textContent = token.name.slice(0, 4);
  document.getElementById("t_name").textContent = token.name;

  if (token.price) {
    currentPrice = parseFloat(token.price);
    document.getElementById("t_price").textContent = `$${currentPrice.toFixed(2)}`;
  }

  const priceRef = doc(db, "prices", token.name);
  onSnapshot(priceRef, (snap) => {
    if (snap.exists()) {
      currentPrice = snap.data().price;
      document.getElementById("t_price").textContent = `$${currentPrice.toFixed(2)}`;
      updateMaxBuyInfo();
    }
  });

  await loadTokenData();
  loadTradeHistory();
}

function updateMaxBuyInfo() {
  const info = document.getElementById("maxBuyInfo");
  if (!info) return;
  if (walletBalance <= 0) {
    info.textContent = "Insufficient balance to buy tokens";
    return;
  }
  if (currentPrice <= 0 || isNaN(currentPrice)) {
    info.textContent = "Price not available yet";
    return;
  }
  const maxTokens = (walletBalance / currentPrice).toFixed(2);
  info.textContent = `You can buy ${maxTokens} tokens max`;
}

// ðŸ”¹ Token-specific data
async function loadTokenData() {
  const ref = doc(db, "byTokens", currentUser.uid, "tokens", token.name);
  const snap = await getDoc(ref);
  if (!snap.exists()) await setDoc(ref, { totalOwned: 0, totalStaked: 0, totalProfit: 0 });

  const data = snap.data() || { totalOwned: 0, totalStaked: 0, totalProfit: 0 };
  document.getElementById("userBalance").textContent = data.totalOwned.toFixed(2);
  document.getElementById("userStaked").innerHTML = `
    ${data.totalStaked.toFixed(2)}
    <div id="stakeInfo" style="font-size:12px;color:#0ea5a4;margin-top:4px;">
      Live Profit: $${data.totalProfit.toFixed(4)}
    </div>
    <button id="releaseBtn" style="margin-top:5px;padding:4px 10px;font-size:12px;
      background:#16a34a;color:#fff;border:none;border-radius:6px;cursor:pointer;">
      Release
    </button>`;
  
  startProfitEngine(ref, data.totalStaked, data.totalProfit);
  document.getElementById("releaseBtn").onclick = () => releaseStake(ref);
}

// ðŸ”¹ Profit auto engine
function startProfitEngine(ref, staked, profit) {
  clearInterval(window.profitTimer);
  updateEarningChart(profit);
  let counter = 0;
  window.profitTimer = setInterval(async () => {
    if (staked > 0) {
      profit += staked * perMinuteRate;
      counter++;
      const stakeInfo = document.getElementById("stakeInfo");
      if (stakeInfo) stakeInfo.innerHTML = `Live Profit: $${profit.toFixed(4)}`;
      updateEarningChart(profit);
      if (counter % 5 === 0) {
        try {
          await updateDoc(ref, { totalProfit: profit });
        } catch (err) {
          console.warn("Firestore sync skipped:", err);
        }
      }
    }
  }, 60000);
}

// ðŸ”¹ Release with 3-level referral
async function releaseStake(ref) {
  const snap = await getDoc(ref);
  const data = snap.data();
  if (!data || data.totalStaked <= 0) return showAlert("Nothing to release!", "error");

  showAlert("Processing release...", "info");
  const profit = data.totalProfit;
  const staked = data.totalStaked;
  const totalReturn = staked * currentPrice + profit * 0.70;
  walletBalance += totalReturn;
  await updateDoc(doc(db, "users", currentUser.uid), { walletBalance });
  await updateDoc(ref, { totalStaked: 0, totalProfit: 0 });

  const userSnap = await getDoc(doc(db, "users", currentUser.uid));
  const upline1 = userSnap.data()?.upline1 || null;
  const upline2 = userSnap.data()?.upline2 || null;
  const upline3 = userSnap.data()?.upline3 || null;

  async function creditUpline(uid, percent) {
    if (!uid) return;
    const uRef = doc(db, "users", uid);
    const s = await getDoc(uRef);
    if (!s.exists()) return;
    const data = s.data();
    const newBal = (data.walletBalance ?? 0) + profit * percent;
    await updateDoc(uRef, { walletBalance: newBal });
    await addDoc(collection(db, "transactions"), {
      from: currentUser.uid,
      to: uid,
      amount: profit * percent,
      levelPercent: percent * 100,
      type: "UPLINE_REWARD",
      timestamp: serverTimestamp()
    });
  }

  await creditUpline(upline1, 0.17);
  await creditUpline(upline2, 0.08);
  await creditUpline(upline3, 0.05);

  // ðŸŸ¢ Profit History Entry
  await addDoc(collection(db, "users", currentUser.uid, "profitHistory"), {
    token: token.name,
    staked: staked,
    profit: profit * 0.70,
    totalReturn: staked * currentPrice + profit * 0.70,
    timestamp: serverTimestamp()
  });

  document.getElementById("walletTotal").textContent = `$${walletBalance.toFixed(2)}`;
  document.getElementById("userStaked").textContent = "0.00";
  showAlert("Released successfully!", "success");
  updateMaxBuyInfo();
}

// ðŸ”¹ Profit History
function loadProfitHistory() {
  const historyRef = collection(db, "users", currentUser.uid, "profitHistory");
  const q = query(historyRef, orderBy("timestamp", "desc"));
  const tb = document.querySelector("#profitHistoryTable tbody");

  onSnapshot(q, (snapshot) => {
    tb.innerHTML = "";
    if (snapshot.empty) {
      tb.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#64748b;">No profit history yet</td></tr>`;
      return;
    }
    snapshot.forEach(docSnap => {
      const d = docSnap.data();
      const date = d.timestamp?.toDate().toLocaleString() || "--";
      tb.innerHTML += `
        <tr>
          <td>${date}</td>
          <td>${d.token}</td>
          <td>${d.staked?.toFixed(2) ?? 0}</td>
          <td>$${d.profit?.toFixed(2) ?? 0}</td>
          <td>$${d.totalReturn?.toFixed(2) ?? 0}</td>
        </tr>
      `;
    });
  });
}
</script>
</body>
</html>
