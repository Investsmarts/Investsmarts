 <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
  <!-- ✅ Firebase + Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, getDoc, serverTimestamp, query, orderBy, doc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";


    const firebaseConfig = {
      apiKey: "AIzaSyDEQYPJFxQv8yFHptrTqoLHOn2L0PpgVhc",
      authDomain: "btcinvest-c0e25.firebaseapp.com",
      projectId: "btcinvest-c0e25",
      storageBucket: "btcinvest-c0e25.firebasestorage.app",
      messagingSenderId: "204937458487",
      appId: "1:204937458487:web:cc27ece1249999279f60b2",
      measurementId: "G-HG0Q8ZHT6G"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const popupOverlay = document.getElementById("popupOverlay");
    const depositAddressEl = document.getElementById("depositAddress");
    const qrCodeEl = document.getElementById("qrcode");
    const historyList = document.getElementById("historyList");
    const thankyouPopup = document.getElementById("thankyouPopup");
    const errorPopup = document.getElementById("errorPopup");
    const instructionEl = document.getElementById("amountInstruction");

    function generateOrderId() {
      const randomNum = Math.floor(1000000000 + Math.random() * 9000000000);
      return "DPBHGR" + randomNum + "G";
    }

    const depositAddresses = [
      "0x6cf5f8F9564205C6AB3dE1694F54374e70dD135A",
      "0x9ad288c9835Cfe30141677444A0A637a434Cd9bC",
      "0x9d6Dc16a1E5aC1CC3b4e7F500f4BdB51D8fBc301",
      "0x1E807c2AeC3165C37A8b47034839654033bD8cf2"
      ];

    let currentDepositAddress = "";
    let currentUserId = null;
    let currentDepositId = null;

    function showError(msg) {
      errorPopup.textContent = msg;
      errorPopup.style.display = "block";
      setTimeout(() => { errorPopup.style.display = "none"; }, 1500);
    }

// ✅ QR Code ko update karne ka function
    function updateQRCode() {
      const amountInput = document.getElementById("depositAmount");
      const amount = parseFloat(amountInput.value) || 0;
      let qrText = `${currentDepositAddress}`;


      if (amount > 0) {
        if (amount < 200) {
      // ❌ Agar 200 se kam hai → red border + error
          amountInput.style.border = "2px solid red";
      qrCodeEl.innerHTML = ""; // QR mat banao
      return;
    } else {
      // ✅ Agar 200 ya zyada hai → green border + QR with amount
      amountInput.style.border = "2px solid green";
      qrText += `?value=${amount}`;
    }
  } else {
    // Default border grey
    amountInput.style.border = "1px solid #ccc";
  }

  qrCodeEl.innerHTML = ""; // purana QR clear karo
  new QRCode(qrCodeEl, { text: qrText, width: 180, height: 180 });
}

window.openPopup = function() {
  popupOverlay.style.display = "flex";
  const amountInput = document.getElementById("depositAmount");
  amountInput.value = "";
  amountInput.disabled = false;
  amountInput.style.border = "1px solid #ccc"; // reset border
  instructionEl.style.display = "none";

  // ✅ Random deposit address set karo
  currentDepositAddress = depositAddresses[Math.floor(Math.random() * depositAddresses.length)];
  depositAddressEl.textContent = currentDepositAddress;

  // ✅ Default QR (sirf address)
  updateQRCode();

  // ✅ Jab user amount type kare to QR update hota rahe
  amountInput.addEventListener("input", updateQRCode);

  // ❌ Yahan ab koi entry Firestore me create nahi hogi
  currentDepositId = null; // reset kar do, jab tak user pay na kare
};

// ❌ Cancel: kuch bhi Firebase me save mat karo
window.cancelDeposit = function() {
  popupOverlay.style.display = "none";
  qrCodeEl.innerHTML = "";
  currentDepositId = null; // clear current deposit id
};

// ✅ Copy address as usual
window.copyAddress = function() {
  navigator.clipboard.writeText(currentDepositAddress);
  showError("Address copied!");
};

// ✅ Entry tabhi create karo jab user "I Have Paid" dabaye
window.markPaid = async function () {
  const amountInput = document.getElementById("depositAmount");
  const amount = parseFloat(amountInput.value) || 0;

  if (amount <= 0) {
    showError("Enter valid amount");
    return;
  }
  if (amount < 200) {
    showError("Minimum is $200");
    amountInput.style.border = "2px solid red";
    return;
  }

  amountInput.disabled = true;
  instructionEl.style.display = "block";
  instructionEl.textContent = `Send the exact amount you entered: $${amount}`;

  popupOverlay.style.display = "none";
  qrCodeEl.innerHTML = "";

  if (currentUserId) {
    const orderId = generateOrderId();

    // ✅ Ab entry yahin create hogi jab user "I Have Paid" click kare
    const ref = await addDoc(collection(db, "users", currentUserId, "deposits"), {
      amount: amount,
      address: currentDepositAddress,
      date: serverTimestamp(),
      status: "I Have Paid",
      orderId: orderId
    });

    currentDepositId = ref.id;

    // ✅ Status watcher chalao (admin complete kare to reward mile)
    watchDepositStatus(currentUserId, currentDepositId);

    // ✅ History reload
    loadDepositHistory(currentUserId);
  }

  // ✅ Thank you popup show karo
  thankyouPopup.style.display = "block";
  setTimeout(() => {
    thankyouPopup.style.display = "none";
  }, 2000);
};


// ✅ Referral Commission + Wallet Reward Logic (UID Based)
async function giveReferralCommission(userId, depositAmount) {
  try {
    const userRef = doc(db, "users", userId);
    const userSnap = await getDoc(userRef);
    if (!userSnap.exists()) return;

    const userData = userSnap.data();

    // ✅ Upline chain (UIDs)
    const uplines = [userData.upline1, userData.upline2, userData.upline3].filter(Boolean);

    // ✅ Step 1: Check if this is user's FIRST successful deposit
    const depositsSnap = await getDocs(collection(db, "users", userId, "deposits"));
    const successful = depositsSnap.docs.filter(d => {
      const s = (d.data().status || "").toLowerCase();
      return s === "completed" || s === "success";
    });

    if (successful.length > 1) return; // ❌ Not first deposit

    // ✅ Step 2: 3-Level Commission
    const commissionRates = [0.03, 0.02, 0.01]; // 3%, 2%, 1%

    for (let level = 0; level < uplines.length; level++) {
      const refUID = uplines[level];
      if (!refUID) continue;

      const refUserRef = doc(db, "users", refUID);
      const refUserSnap = await getDoc(refUserRef);
      if (!refUserSnap.exists()) continue;

      const refData = refUserSnap.data();
      const commission = depositAmount * commissionRates[level];

      // ✅ Add record in referrer's commission history
      await addDoc(collection(db, "users", refUID, "commissions"), {
        fromUser: userId,
        level: level + 1,
        amount: commission.toFixed(2),
        date: serverTimestamp(),
        note: `Level ${level + 1} reward from ${userId}'s first deposit`,
      });

      // ✅ Add reward to referrer's wallet and total lifetime income
      const currentWallet = parseFloat(refData.walletBalance || 0);
      const newWallet = currentWallet + commission;

      const totalReferral = parseFloat(refData.lifetimeReferralIncome || 0);
      const newTotalReferral = totalReferral + commission;

      await updateDoc(refUserRef, {
        walletBalance: newWallet,
        lifetimeReferralIncome: newTotalReferral,
      });

      console.log(
        `✅ Level ${level + 1} Reward: $${commission.toFixed(
          2
        )} added to ${refUID}'s wallet`
      );
    }
  } catch (e) {
    console.error("Commission reward error:", e);
  }
}

// ✅ Listen for status change to "completed"
function watchDepositStatus(userId, depositId) {
  const depositRef = doc(db, "users", userId, "deposits", depositId);

// ✅ Listen for status change to "completed" OR "approved"
onSnapshot(depositRef, async (snap) => {
  const data = snap.data();
  if (!data) return;

  const status = (data.status || "").toLowerCase();

  // ✅ Trigger referral if deposit is completed OR approved
  if ((status === "completed" || status === "approved") && !data.rewardGiven) {
    console.log("✅ Deposit approved/completed! Giving referral reward...");

    await updateDoc(depositRef, { rewardGiven: true }); // lock reward
    await giveReferralCommission(userId, data.amount);
  }
});


}

window.manualRefresh = function() {
  if (currentUserId) loadDepositHistory(currentUserId);
};


async function loadDepositHistory(userId) {
  historyList.innerHTML = "<p style='text-align:center; color:#666;'>Loading...</p>";
  try {
    const q = query(collection(db, "users", userId, "deposits"), orderBy("date", "desc"));
    const querySnapshot = await getDocs(q);
    if (querySnapshot.empty) {
      historyList.innerHTML = "<p style='text-align:center; color:#666;'>No deposits yet.</p>";
      return;
    }
    historyList.innerHTML = "";
    querySnapshot.forEach(docSnap => {
      const data = docSnap.data();
      const dateStr = data.date ? new Date(data.date.seconds*1000).toLocaleString() : "-";
      const statusClass = (data.status || "Pending").toLowerCase();
      historyList.innerHTML += `
      <div class="history-card">
      <div class="history-card-header">
      <span class="badge">Deposit</span>
      <span class="status ${statusClass}">${data.status || "Pending"}</span>
      </div>
      <div class="history-card-row"><span class="label">Balance</span><span class="value">$${data.amount || 0}</span></div>
      <div class="history-card-row"><span class="label">Type</span><span>BEP20</span></div>
      <div class="history-card-row"><span class="label">Time</span><small>${dateStr}</small></div>
      <div class="history-card-row"><span class="label"> ID</span>
      <span><small id="order-${docSnap.id}">${data.orderId || docSnap.id}</small>
      <button onclick="copyOrderId('${data.orderId || docSnap.id}')">Copy</button></span>
      </div>
      </div>`;
    });
  } catch (err) {
    console.error("Error:", err);
    historyList.innerHTML = "<p style='text-align:center; color:red;'>Error loading history</p>";
  }
}

onAuthStateChanged(auth, (user) => {
  if (!user) {
    window.location.href = "login.html";
  } else {
    currentUserId = user.uid;
    loadDepositHistory(user.uid);
    watchTotalDeposit(user.uid); // ✅ live updates (no refresh needed)
  }
});


window.copyOrderId = function(orderId) {
  navigator.clipboard.writeText(orderId);
  showError("Order ID copied!");
};
      // ✅ Navbar Highlight Logic
document.querySelectorAll(".wave-nav a").forEach(link => {
  if (link.href === window.location.href) {
    link.classList.add("active");
  } else {
    link.classList.remove("active");
  }
});

// ✅ Real-time Total + Lifetime Deposit + Level Updater
function watchTotalDeposit(userId) {
  const depositsRef = collection(db, "users", userId, "deposits");
  const userRef = doc(db, "users", userId);

  onSnapshot(depositsRef, async (snapshot) => {
    let total = 0;

    snapshot.forEach((docSnap) => {
      const data = docSnap.data();
      const status = (data.status || "").toLowerCase();

      // ✅ Count only completed / approved / success deposits
      if (
        (status === "completed" || status === "approved" || status === "success") &&
        data.amount
      ) {
        total += parseFloat(data.amount);
      }
    });

    // 🧠 Update UI live
    document.getElementById("totalDeposit").textContent = total.toFixed(2);

    // 🧠 Fetch existing lifetimeDeposit
    const userSnap = await getDoc(userRef);
    const userData = userSnap.exists() ? userSnap.data() : {};
    const currentLifetime = parseFloat(userData.lifetimeDeposit || 0);

    // 🔄 Update lifetimeDeposit only if it increased
    const updatedLifetime = Math.max(currentLifetime, total);

    // 🏅 Determine Level
    let level = "No Level";
    if (updatedLifetime >= 1000) level = "Gold";
    else if (updatedLifetime >= 500) level = "Silver";
    else if (updatedLifetime >= 200) level = "Bronze";

    // 🧩 Firestore Update
    await updateDoc(userRef, {
      totalDeposit: total,
      lifetimeDeposit: updatedLifetime,
      userLevel: level,
    });

    // 🧠 Update level in UI
    document.getElementById("userLevel").textContent = `My Level: ${level}`;

    // ✅ (optional) If you have a lifetimeDeposit span in HTML:
    const lifeEl = document.getElementById("lifetimeDeposit");
    if (lifeEl) lifeEl.textContent = updatedLifetime.toFixed(2);

    console.log(
      `✅ Live Update: Total=$${total}, Lifetime=$${updatedLifetime}, Level=${level}`
    );
  });
}


  // 🚫 Disable right click, select, drag
  document.addEventListener("contextmenu", e => e.preventDefault());
  document.addEventListener("selectstart", e => e.preventDefault());
  document.addEventListener("dragstart", e => e.preventDefault());

  // 🚫 Disable keyboard shortcuts (copy, paste, inspect, etc.)
  document.addEventListener("keydown", e => {
    if (
      e.key === "F12" ||
      (e.ctrlKey && e.shiftKey && (e.key === "I" || e.key === "J")) ||
      (e.ctrlKey && (e.key === "U" || e.key === "C" || e.key === "X" || e.key === "V" || e.key === "S"))
    ) {
      e.preventDefault();
      return false;
    }
  });

  // 🔒 Silent DevTools detection (no popup)
  (function() {
    const devtools = /./;
    devtools.toString = function() {
      return ""; // no alert or console log
    };
    console.log("%c", devtools);
  })();

  // 🔐 Detect DevTools using resize trick (no popup)
  setInterval(() => {
    const threshold = 160;
    const widthDiff = window.outerWidth - window.innerWidth > threshold;
    const heightDiff = window.outerHeight - window.innerHeight > threshold;
    if (widthDiff || heightDiff) {
      // Optional: silently redirect or blank the page
      document.body.innerHTML = "";
    }
  }, 1000);

  // 🧱 Disable copy/paste/cut
  ["copy", "paste", "cut"].forEach(evt =>
    document.addEventListener(evt, e => e.preventDefault())
  );

  // 🔁 Freeze console methods silently
  Object.freeze(console);
  Object.freeze(window.console);




</script>
</body>
</html>
