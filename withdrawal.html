<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Withdraw</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  
  <style>
    /* General Reset */
    html, body {
      margin: 0;
      padding: 0;
      overflow-x: hidden;   /* ✅ horizontal scroll off */
      font-family: 'Poppins', sans-serif;
      background: #f5f7fa;
      color: #333;
    }

    * {
      box-sizing: border-box;   /* ✅ border/padding overflow fix */
      max-width: 100%;          /* ✅ kisi element ko overflow karne se rokta hai */
    }

    body {
      padding-bottom: 100px;
    }

    /* Dashboard Wrapper */
    .dashboard {
      max-width: 420px;
      margin: 20px auto;
      padding: 0 15px;
    }

    /* Info Card */
    .info-card {
      background: #fff;
      border-radius: 16px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      text-align: center;
    }

    .info-card h3 {
      margin-bottom: 12px;
      color: #ff00d9;
    }

    .info-text-box {
      border: 1.8px solid #28a745;
      background: #f9fffa;
      color: #28a745;
      padding: 12px 14px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      margin: 12px 0 18px 0;
      text-align: center;
      line-height: 1.5;
    }

    /* Button */
    .btn-withdraw {
      background: #28a745;
      color: #fff;
      padding: 12px 20px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      transition: 0.3s;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .btn-withdraw:hover { background: #218838; }

    /* History Header Box */
    .history-header-box {
      background: #fff;
      border-radius: 12px;
      padding: 12px 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      border: 1.5px solid #c3e6cb;
    }
    .history-header-box .title {
      color: #28a745;
      font-size: 17px;
      font-weight: 600;
    }
    .refresh-btn {
      background: #17a2b8;
      color: #fff;
      padding: 6px 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .refresh-btn:hover { background: #138496; }

    /* Popup Overlay */
    .popup-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      overflow-x: hidden;  /* ✅ popup me bhi horizontal scroll off */
    }
    .popup {
      background: #fff;
      border-radius: 12px;
      padding: 10px;
      width: 90%;
      max-width: 360px;   /* ✅ thoda safe margin */
      text-align: center;
      box-shadow: 0 6px 15px rgba(0,0,0,0.25);
      animation: fadeIn 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    @keyframes fadeIn {
      from {opacity: 0; transform: scale(0.9);}
      to {opacity: 1; transform: scale(1);}
    }

    .popup label {
      font-size: 13px;
      font-weight: 600;
      color: #333;
      align-self: flex-start;
      margin-top: 8px;
    }
    .amount-input, .address-input {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 14px;
      outline: none;
      text-align: center;
    }

    /* Action Buttons */
    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 14px;
      width: 100%;
    }
    .action-buttons button {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      font-size: 13px;
      color: #fff;
    }
    .close-btn { background: #dc3545; }
    .submit-btn { background: #28a745; }

    /* Success & Error Popups */
    .thankyou-popup, .error-popup {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%,-50%);
      padding: 12px 20px;
      border-radius: 10px;
      font-weight: bold;
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
      z-index: 3000;
      display: none;
      animation: fadeInOut 1.5s ease forwards;
    }
    .thankyou-popup { background: #28a745; color: #fff; }
    .error-popup { background: #dc3545; color: #fff; }
    @keyframes fadeInOut {
      0% {opacity: 0; transform: translate(-50%,-50%) scale(0.9);}
      20% {opacity: 1; transform: translate(-50%,-50%) scale(1);}
      80% {opacity: 1;}
      100% {opacity: 0; transform: translate(-50%,-50%) scale(0.9);}
    }

    /* Bottom Nav */
    .bottom-nav {
      position: fixed;
      bottom: 0; left: 0;
      width: 100%; height: 70px;
      background: #fff;
      display: flex;
      justify-content: space-around;
      align-items: center;
      border-top: 2px solid #28a745;
      z-index: 100;
    }
    .nav-item {
      flex: 1;
      text-align: center;
      font-size: 12px;
      color: #333;
      text-decoration: none;
      transition: 0.3s;
      position: relative;
      padding: 10px 0;
    }
    .nav-item i {
      font-size: 22px;
      display: block;
      margin-bottom: 3px;
      color: #28a745;
    }
    .nav-item:hover { color: #28a745; }
    .nav-item:hover i { color: #218838; }
    .nav-item:not(:last-child)::after {
      content: "";
      position: absolute;
      right: 0; top: 20%; bottom: 20%;
      width: 1px; background: #e0e0e0;
    }
    /* ✅ Balance Card (Withdraw Page) */
.balance-card {
  max-width: 480px;
  margin: 0 auto 20px;
  background: linear-gradient(135deg,#28a745,#34d058); /* Green gradient */
  color: #fff;
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.12);
  display: flex;
  align-items: center;
  gap: 15px;
}

/* Left Icon */
.balance-card .balance-icon {
  font-size: 40px;
  color: #fff;
  flex-shrink: 0;
}

/* Right Info Section */
.balance-card .balance-info {
  flex: 1;
}

.balance-card .balance-info h3 {
  font-size: 15px;
  font-weight: 600;
  margin: 0 0 6px;
  opacity: 0.95;
}

.balance-card .balance-info .amount {
  font-size: 26px;
  font-weight: 700;
  margin: 0 0 6px;
  display: flex;
  align-items: center;
  gap: 4px;
}

.balance-card .balance-info small {
  font-size: 13px;
  font-weight: 500;
  opacity: 0.85;
}


  /* Clean Buttons - Smaller Version */
.clean-buttons {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
  margin: 15px 0;
}

.clean-btn {
  background: #fff;
  border-radius: 12px;
  padding: 16px 8px;  /* 🔥 button height kam */
  box-shadow: 0 3px 8px rgba(0,0,0,0.06);
  text-align: center;
  cursor: pointer;
  transition: 0.3s;
}

.clean-btn:hover {
  box-shadow: 0 6px 12px rgba(0,0,0,0.1);
  transform: translateY(-2px);
}

.clean-btn i {
  font-size: 22px;   /* 🔥 icon size kam */
  color: #28a745;
  margin-bottom: 6px;
  display: block;
}

.clean-btn p {
  margin: 0;
  font-size: 13px;   /* 🔥 text size thoda chhota */
  font-weight: 500;
  color: #333;
}


/* Withdraw History Card */
.withdraw-card {
  background: #fff;
  border-radius: 14px;
  padding: 16px;
  margin-bottom: 15px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  font-size: 14px;
}

.withdraw-card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.withdraw-card-header .badge {
  background: #dc3545;  /* 🔴 Withdraw ke liye red badge */
  color: #fff;
  font-weight: 600;
  font-size: 12px;
  padding: 5px 12px;
  border-radius: 6px;
}

.withdraw-status {
  font-size: 13px;
  font-weight: 600;
  text-transform: capitalize;
}

/* Status Colors */
.withdraw-status.pending { color: #ffc107; }
.withdraw-status.completed { color: #28a745; }
.withdraw-status.failed { color: #dc3545; }

.withdraw-row {
  display: flex;
  justify-content: space-between;
  margin: 8px 0;
}

.withdraw-row .label {
  font-weight: 600;
  color: #444;
}

.withdraw-row .value,
.withdraw-row small {
  color: #555;
}

.copy-btn {
  background: #007bff;
  border: none;
  color: #fff;
  padding: 3px 10px;
  font-size: 12px;
  border-radius: 6px;
  cursor: pointer;
  margin-left: 5px;
}
.copy-btn:hover { background: #0056b3; }

/* ✅ Multiple Wallet ka CSS */
.popup-multiple {
  background: #fff;
  border-radius: 14px;
  padding: 20px;
  width: 100%;
  max-width: 420px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.15);
  text-align: center;
}

h2 { margin-bottom: 15px; font-size: 20px; color: #28a745; }
label { font-size: 14px; font-weight: 600; display: block; text-align: left; margin-top: 12px; }

input {
  width: 100%; padding: 14px; margin-top: 6px;
  border: 1.5px solid #ccc; border-radius: 8px;
  font-size: 15px; outline: none; box-sizing: border-box;
}
input::placeholder { color: #888; }

.dropdown-container { position: relative; margin-top: 6px; }
.dropdown-btn {
  width: 100%; padding: 12px;
  border: 1.5px solid #ccc; border-radius: 8px;
  font-size: 15px; text-align: left; cursor: pointer;
  background: #fff; box-sizing: border-box;
}
.dropdown-list {
  position: absolute; top: 100%; left: 0; right: 0;
  width: 100%; max-height: 0; overflow: hidden;
  background: #fff; border: 1.5px solid #ccc; border-radius: 8px;
  margin-top: 4px; opacity: 0;
  transition: max-height 0.4s ease, opacity 0.4s ease;
  z-index: 2000; box-sizing: border-box;
}
.dropdown-list.show { max-height: 250px; opacity: 1; overflow-y: auto; }

.dropdown-top {
  display: flex; align-items: center; padding: 6px;
  border-bottom: 1px solid #ddd; gap: 6px;
  background: #fafafa; position: sticky; top: 0; z-index: 10;
}
.dropdown-top input {
  flex: 1; padding: 10px; font-size: 14px;
  border: 1px solid #ccc; border-radius: 6px; min-width: 0;
}
.dropdown-top button {
  height: 38px; padding: 0 14px; border: none; border-radius: 6px;
  background: #007bff; color: #fff; cursor: pointer; font-size: 14px;
  display: flex; align-items: center; justify-content: center;
  transition: background 0.3s ease;
}
.dropdown-top button:hover { background: #0056b3; }

.dropdown-list ul { list-style: none; padding: 0; margin: 0; }
.dropdown-list li {
  padding: 10px 14px; cursor: pointer;
  transition: background 0.2s; font-size: 14px;
}
.dropdown-list li:hover { background: #f0f0f0; }

.action-buttons { display: flex; margin-top: 18px; }
.action-buttons button {
  flex: 1; padding: 14px; border: none; border-radius: 8px;
  cursor: pointer; font-weight: bold; font-size: 15px; color: #fff;
  transition: 0.3s; background: #007bff;
}
.action-buttons button:hover { background: #0069d9; }

#message {
  position: fixed; top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  background: #fff; padding: 14px 24px;
  border-radius: 10px; box-shadow: 0 4px 16px rgba(0,0,0,0.25);
  font-size: 15px; font-weight: 600; display: none;
  z-index: 9999; max-width: 80%; text-align: center;
  animation: fadeIn 0.3s ease;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translate(-50%, -60%); }
  to { opacity: 1; transform: translate(-50%, -50%); }
}

.info-box {
  margin-top: 15px; padding: 12px 18px;
  border: 2px solid #28a745; border-radius: 10px;
  background: #f9fff9; color: #28a745;
  font-size: 14px; font-weight: 500; text-align: center;
  line-height: 1.4;
}

/*record.html ka code */
/* Record Section */
.records-section h2 {
  color: #28a745;
  margin-bottom: 15px;
  text-align: center;
}
.records-section .count-box {
  background: #fff;
  border: 2px solid #28a745;
  border-radius: 10px;
  padding: 10px 15px;
  margin-bottom: 20px;
  text-align: center;
  font-weight: 600;
}
.records-section .wallet-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.records-section .wallet-card {
  background: #fff;
  border: 1.5px solid #ddd;
  border-radius: 10px;
  padding: 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 4px 10px rgba(0,0,0,0.05);
}
.records-section .wallet-info {
  max-width: 65%;
}
.records-section .wallet-info b {
  color: #28a745;
  font-size: 14px;
}
.records-section .wallet-info p {
  margin: 4px 0 0;
  font-size: 13px;
  word-break: break-all;
  color: #444;
}
.records-section .wallet-actions {
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.records-section .wallet-actions button {
  border: none;
  padding: 6px 10px;
  font-size: 12px;
  font-weight: 600;
  border-radius: 6px;
  cursor: pointer;
  transition: 0.3s;
}
.records-section .primary-btn {
  background: #007bff;
  color: #fff;
}
.records-section .primary-btn:hover {
  background: #0056b3;
}
.records-section .delete-btn {
  background: #dc3545;
  color: #fff;
}
.records-section .delete-btn:hover {
  background: #a71d2a;
}
.records-section .primary-badge {
  background: #28a745;
  color: #fff;
  font-size: 11px;
  padding: 3px 6px;
  border-radius: 6px;
  margin-left: 6px;
}

/* requestwithrowal pop up */ 
.popup-withdraw {
  background: #fff;
  border-radius: 12px;
  padding: 20px;
  width: 90%;
  max-width: 360px;
  text-align: center;
  box-shadow: 0 6px 15px rgba(0,0,0,0.25);
  animation: fadeIn 0.3s ease;   /* ✅ ye smooth opening dega */
  display: flex;
  flex-direction: column;
  align-items: center;

  /* ✅ center alignment */
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}

/* Info Box for Min + Balance */
.popup-info-box {
  border: 1.5px solid #28a745;
  background: #f9fffa;
  border-radius: 10px;
  padding: 10px;
  margin-bottom: 15px;
  text-align: center;
  font-size: 14px;
  line-height: 1.5;
}

/* Buttons */
.action-buttons {
  display: flex;
  gap: 10px;
  margin-top: 14px;
  width: 100%;
}
.action-buttons button {
  flex: 1;
  padding: 10px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
  font-size: 14px;
  color: #fff;
}

/* ❌ Cancel Button */
.close-btn {
  background: #dc3545;
}
.close-btn:hover {
  background: #a71d2a;
}

/* ✅ Submit Button */
.submit-btn {
  background: #28a745;
}
.submit-btn:hover {
  background: #218838;
}


/* Refresh Loader */
#refreshLoader {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(255,255,255,0.95);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 5000;
  flex-direction: column;
}

.loader-wrapper {
  position: relative;
  width: 120px;
  height: 120px;
  display: flex;
  justify-content: center;
  align-items: center;
}

/* Circular rainbow ring */
.loader-ring {
  position: absolute;
  top: 0; left: 0;
  width: 100%;
  height: 100%;
  border-radius: 50%;
  border: 6px solid transparent;
  border-top: 6px solid #ff0000;
  border-right: 6px solid #00ff00;
  border-bottom: 6px solid #0000ff;
  border-left: 6px solid #ff00ff;
  animation: spin 1.2s linear infinite;
}

/* Logo inside */
.loader-logo img {
  width: 70px;
  height: 70px;
  border-radius: 50%;
  z-index: 10;
}

@keyframes spin {
  0%   { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

#withdrawLevel {
  display: inline-block;
  background: #fff;
  color: #28a745;
  font-weight: 600;
  padding: 6px 12px;
  border-radius: 10px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.1);
  margin-top: 8px;
  font-size: 14px;
}




</style>
</head>
<body>
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

  <div class="dashboard">


    <!-- ✅ Withdrawal Card -->
   <div class="balance-card">
    <div class="balance-icon">
      <i class='bx bx-up-arrow-circle'></i>
    </div>
    <div class="balance-info">
      <h3>Total Withdrawal (USDT)</h3>
      <p class="amount">$<span id="totalWithdraw">0.00</span></p>
      <small id="withdrawLevel">“Timing: / Not Ready”</small>
    </div>
  </div>


  <!-- ✅ Buttons Row -->
  <div class="clean-buttons">
    <div class="clean-btn" onclick="loadPage('primary.html')">
      <i class='bx bx-star'></i>
      <p>Primary </p>
    </div>
    <div class="clean-btn" onclick="loadPage('add-multiple.html')">
      <i class='bx bx-plus-circle'></i>
      <p> Multiple</p>
    </div>
    <div class="clean-btn" onclick="loadPage('records.html')">
      <i class='bx bx-book'></i>
      <p> Record</p>
    </div>
  </div>

  <!-- ✅ Content Area -->
  <div id="contentArea">📄 Select a menu above to load content</div>

  <!-- Withdrawal Info Card -->
  <div class="info-card">
    <h3>Withdrawal Section</h3>

    <!-- Green info box -->
    <div class="info-text-box">
      Click below to <b>Withdraw Funds</b> securely.
    </div>

    <!-- Withdraw Button -->
    <button class="btn-withdraw" onclick="openPopup()">
      <i class='bx bx-up-arrow-circle'></i> Request Withdrawal
    </button>
  </div>

  <!-- Withdrawal History -->
  <div class="history-section">
    <div class="history-header-box">
      <span class="title"> History</span>
      <button class="refresh-btn" onclick="manualRefresh()">🔄 Refresh</button>
    </div>
    <div id="withdrawHistoryList">
      <p style="text-align:center; color:#666;">Loading...</p>
    </div>
  </div>

</div>

<!-- Refresh Loader -->
<div id="refreshLoader">
  <div class="loader-wrapper">
    <div class="loader-ring"></div>
    <div class="loader-logo">
      <img src="myphoto/trustlogo.png" alt="Logo">
    </div>
  </div>
</div>

<!-- Popup -->
<div class="popup-overlay" id="popupOverlay">
  <div class="popup-withdraw">
    <h2>Withdraw Funds</h2>

    <!-- Info Box for Min + Balance -->
    <div class="popup-info-box">
      <p>Minimum withdrawal: <b style="color:#28a745;">$20</b></p>
      <p>Available balance: <b id="popupBalance" style="color:#007bff;">0.00</b></p>
    </div>

    <label>Amount ($)</label>
    <input type="number" id="withdrawAmount" class="amount-input" placeholder="Enter withdrawal amount">

    <label>Type</label>
    <input type="text" value="USDT (BEP20)" disabled class="address-input">

    <label>Your Wallet Address</label>
    <input type="text" id="withdrawAddress" class="address-input" placeholder="Set your primary address first" readonly>

    <!-- Buttons -->
    <div class="action-buttons">
      <button class="close-btn" onclick="cancelWithdraw()">Cancel</button>
      <button class="submit-btn" onclick="submitWithdraw()">Submit</button>
    </div>
  </div>
</div>


<div class="thankyou-popup" id="thankyouPopup">Withdrawal Requested</div>
<div class="error-popup" id="errorPopup">Enter valid details</div>

<!-- Bottom Navigation -->
<div class="bottom-nav">
  <a href="Dashboard.html" class="nav-item"><i class='bx bx-home'></i><span>Home</span></a>
  <a href="mining.html" class="nav-item"><i class='bx bx-wallet'></i><span>Invest</span></a>
  <a href="promotion.html" class="nav-item"><i class='bx bx-gift'></i><span>Refer</span></a>
  <a href="account.html" class="nav-item"><i class='bx bx-user'></i><span>Account</span></a>
</div>

<script>
    // Highlight active nav
  const links = document.querySelectorAll("nav a");
  links.forEach(link => {
    link.addEventListener("click", function() {
      links.forEach(l => l.classList.remove("active"));
      this.classList.add("active");
    });
  });
</script>

<!-- ✅ Firebase + Logic -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import { getFirestore, collection, addDoc, getDocs, serverTimestamp, query, orderBy, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDEQYPJFxQv8yFHptrTqoLHOn2L0PpgVhc",
    authDomain: "btcinvest-c0e25.firebaseapp.com",
    projectId: "btcinvest-c0e25",
    storageBucket: "btcinvest-c0e25.firebasestorage.app",
    messagingSenderId: "204937458487",
    appId: "1:204937458487:web:cc27ece1249999279f60b2",
    measurementId: "G-HG0Q8ZHT6G"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const popupOverlay = document.getElementById("popupOverlay");
  const thankyouPopup = document.getElementById("thankyouPopup");
  const errorPopup = document.getElementById("errorPopup");
  const popupBalance = document.getElementById("popupBalance");
  const addressInput = document.getElementById("withdrawAddress");

  let currentUserId = null;
  let userBalance = 0;
  let userWalletAddress = "";

  function showError(msg) {
    errorPopup.textContent = msg;
    errorPopup.style.display = "block";
    setTimeout(() => { errorPopup.style.display = "none"; }, 1500);
  }

  function showSuccess(msg) {
    thankyouPopup.textContent = msg;
    thankyouPopup.style.display = "block";
    setTimeout(() => { thankyouPopup.style.display = "none"; }, 2000);
  }

  function generateOrderId() {
    const randomNum = Math.floor(1000000000 + Math.random() * 9000000000);
    return "WDBHGR" + randomNum + "G";
  }

  async function loadUserProfile(uid) {
    const ref = doc(db, "users", uid);
    const snap = await getDoc(ref);
    if (snap.exists()) {
      const data = snap.data();
      userBalance = data.walletBalance || 0;
      userWalletAddress = data.primaryAddress || "";

      // ✅ Balance update
      if (popupBalance) popupBalance.textContent = userBalance.toFixed(2);

      // ✅ Address input logic
      if (userWalletAddress) {
        addressInput.value = userWalletAddress;
      } else {
        addressInput.value = "";
        addressInput.placeholder = "Set your primary address first";
      }

      // ✅ Lifetime withdrawal show
      if (data.lifetimeWithdrawal !== undefined) {
        document.getElementById("totalWithdraw").textContent = data.lifetimeWithdrawal.toFixed(2);
      } else {
        document.getElementById("totalWithdraw").textContent = "0.00";
      }
    }
  }

  window.openPopup = function () {
    popupOverlay.style.display = "flex";
    document.getElementById("withdrawAmount").value = "";
    addressInput.value = userWalletAddress || "";
  };

  window.cancelWithdraw = function () {
    popupOverlay.style.display = "none";
  };

// witrowal 
window.submitWithdraw = async function () {
  const amount = parseFloat(document.getElementById("withdrawAmount").value) || 0;
  const address = addressInput.value.trim();

  if (amount < 20) {
    showError("Minimum withdrawal is $20");
    return;
  }
  if (amount > userBalance) {
    showError("Insufficient balance");
    return;
  }
  if (!address || address.length < 20) {
    showError("Please set your primary address first");
    return;
  }

  const orderId = generateOrderId();

  if (currentUserId) {
    const ref = doc(db, "users", currentUserId);

    // 1️⃣ Add withdrawal record
    await addDoc(collection(db, "users", currentUserId, "withdrawals"), {
      amount: amount,
      type: "USDT (BEP20)",
      address: address,
      date: serverTimestamp(),
      status: "Pending",
      orderId: orderId
    });

    // ✅ Withdrawal Email Notification Function (unchanged)
    async function sendWithdrawalEmail(name, email, amount, currency, status, txid, note) {
  try {
    const TRUSTDOLLAR_API = "https://script.google.com/macros/s/AKfycbyLUJw5-SLD8IltsZrekLmHSyZM2Tj4QTanO6ZUq8cStV2WZCS1-lF-TJnEfzhHF5fO/exec";

    const payload = {
      name,
      email,
      amount,
      currency,
      status,
      txid,
      note,
      time: new Date().toLocaleString()
    };

    const iframe = document.createElement("iframe");
    iframe.style.display = "none";
    iframe.src = `${TRUSTDOLLAR_API}?data=${encodeURIComponent(JSON.stringify(payload))}`;
    document.body.appendChild(iframe);

    window.addEventListener("message", (event) => {
      console.log("✅ Response from Google Script:", event.data);
    });
  } catch (err) {
    console.error("❌ Email Error:", err);
  }
}

    // ✅ CALL EMAIL FUNCTION RIGHT HERE 🔥
    sendWithdrawalEmail(
      auth.currentUser.displayName || "User",
      auth.currentUser.email,
      amount,
      "USDT",
      "requested",
      orderId,
      "Withdrawal Request Initiated"
    );

    // 2️⃣ Deduct from balance
    await updateDoc(ref, { walletBalance: userBalance - amount });

    // 3️⃣ Ensure lifetimeWithdrawal exists
    const userSnap = await getDoc(ref);
    if (userSnap.exists()) {
      const data = userSnap.data();
      if (data.lifetimeWithdrawal === undefined) {
        await updateDoc(ref, { lifetimeWithdrawal: 0 });
      }
    }

    // 4️⃣ Refresh UI
    loadWithdrawHistory(currentUserId);
    loadUserProfile(currentUserId);
  }

  popupOverlay.style.display = "none";
  showSuccess("Withdrawal Requested!");
};


window.manualRefresh = function () {
  const historyList = document.getElementById("withdrawHistoryList");

  // 🔹 Show loader
  document.getElementById("refreshLoader").style.display = "flex";

  // Refresh logic
  historyList.innerHTML = "<p style='text-align:center; color:#666;'>Refreshing...</p>";
  if (currentUserId) {
    loadWithdrawHistory(currentUserId).then(() => {
      // 🔹 Hide loader after done
      document.getElementById("refreshLoader").style.display = "none";
    });
  } else {
    historyList.innerHTML = "<p style='text-align:center; color:red;'>User not logged in!</p>";
    document.getElementById("refreshLoader").style.display = "none";
  }
};


  async function loadWithdrawHistory(userId) {
    const historyList = document.getElementById("withdrawHistoryList");
    try {
      const q = query(collection(db, "users", userId, "withdrawals"), orderBy("date", "desc"));
      const querySnapshot = await getDocs(q);
      if (querySnapshot.empty) {
        historyList.innerHTML = "<p style='text-align:center; color:#666;'>No withdrawals yet.</p>";
        return;
      }
      historyList.innerHTML = "";

      querySnapshot.forEach(docSnap => {
        const data = docSnap.data();
        const dateStr = data.date ? new Date(data.date.seconds * 1000).toLocaleString() : "-";
        const statusClass = (data.status || "Pending").toLowerCase();

        historyList.innerHTML += `
        <div class="withdraw-card">
        <div class="withdraw-card-header">
        <span class="badge">Withdraw</span>
        <span class="withdraw-status ${statusClass}">${data.status || "Pending"}</span>
        </div>
        <div class="withdraw-row"><span class="label">Balance</span><span class="value">$${data.amount || 0}</span></div>
        <div class="withdraw-row"><span class="label">Type</span><small>${data.type || "USDT (BEP20)"}</small></div>
        <div class="withdraw-row"><span class="label">Time</span><small>${dateStr}</small></div>
        <div class="withdraw-row"><span class="label">OrderId</span>
        <span><small>${data.orderId || docSnap.id}</small>
        <button class="copy-btn" onclick="copyOrderId('${data.orderId || docSnap.id}')">Copy</button></span>
        </div>
        </div>`;
      });
    } catch (err) {
      console.error("Error:", err);
      historyList.innerHTML = "<p style='text-align:center; color:red;'>Error loading history</p>";
    }
  }

  window.copyOrderId = function (orderId) {
    navigator.clipboard.writeText(orderId);
    showError("Order ID copied!");
  };

  onAuthStateChanged(auth, (user) => {
    if (!user) window.location.href = "auth.html";
    else {
      currentUserId = user.uid;
      loadUserProfile(user.uid);
      loadWithdrawHistory(user.uid);
      loadWithdrawCard(user.uid);
    }
  });

  async function loadWithdrawCard(uid) {
    try {
      let totalFunds = 0;

      // 🔹 User wallet balance
      const ref = doc(db, "users", uid);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        const data = snap.data();
        totalFunds += parseFloat(data.walletBalance || 0);
      }

      // 🔹 Investments
      const investSnap = await getDocs(collection(db, "users", uid, "investments"));
      investSnap.forEach(docSnap => {
        const inv = docSnap.data();
        if (inv.amount) totalFunds += parseFloat(inv.amount);
      });

      // 🔹 Staking
      const stakingSnap = await getDocs(collection(db, "users", uid, "staking"));
      stakingSnap.forEach(docSnap => {
        const stk = docSnap.data();
        if (stk.amount) totalFunds += parseFloat(stk.amount);
      });

      // 🔹 Timing rules
      let timing = "Not Ready";
      if (totalFunds >= 50000) timing = "Same Day";
      else if (totalFunds >= 10000) timing = "1 Day";
      else if (totalFunds >= 5000) timing = "2 Days";
      else if (totalFunds >= 500) timing = "10 Days";
      else if (totalFunds >= 200) timing = "20 Days";

      document.getElementById("withdrawLevel").textContent =
      "Release In " + timing;


      // 🔹 Total completed withdrawals
      const q = query(collection(db, "users", uid, "withdrawals"));
      const querySnapshot = await getDocs(q);

      let totalWithdraw = 0;
      querySnapshot.forEach(docSnap => {
        const wd = docSnap.data();
        if ((wd.status || "").toLowerCase() === "completed" && wd.amount) {
          totalWithdraw += parseFloat(wd.amount);
        }
      });

      document.getElementById("totalWithdraw").textContent = totalWithdraw.toFixed(2);
    } catch (err) {
      console.error("Error loading withdraw card:", err);
    }
  }

// ✅ Load external pages aur scroll fix
window.loadPage = function (page) {
  const content = document.getElementById("contentArea");

  // 🔹 Jabhi button dabaye, turant scroll top
  window.scrollTo(0, 0);

  // 🔹 Loading placeholder
  content.innerHTML = "<p style='text-align:center; color:#28a745;'>⏳ Loading...</p>";

  fetch(page)
    .then(res => res.text())
    .then(data => {
      content.innerHTML = data;

      // 🔹 Dobara ensure scroll upar hi rahe
      setTimeout(() => {
        document.body.scrollTop = 0;        // Safari ke liye
        document.documentElement.scrollTop = 0; // Chrome/Firefox ke liye
      }, 30);

      // ✅ Agar page ke andar <script> tags hain to run karo
      const scripts = content.querySelectorAll("script");
      scripts.forEach(oldScript => {
        const newScript = document.createElement("script");
        if (oldScript.type) newScript.type = oldScript.type;
        if (oldScript.src) {
          newScript.src = oldScript.src;
        } else {
          newScript.textContent = oldScript.textContent;
        }
        document.body.appendChild(newScript);
        oldScript.remove();
      });
    })
    .catch(() => {
      content.innerHTML = "<p style='color:red; text-align:center;'>⚠ Error loading page</p>";
    });
};

// Pull-to-refresh detection
const loader = document.getElementById("refreshLoader");

// 🔹 Page load hone par loader dikhana (default refresh me)
window.addEventListener("load", () => {
  loader.style.display = "flex";
  setTimeout(() => {
    loader.style.display = "none";
  }, 1500); // 1.5 sec baad hide
});

// 🔹 Manual Refresh Trigger (button ke liye)
function triggerCustomRefresh() {
  if (!loader) return;

  loader.style.display = "flex";

  if (typeof manualRefresh === "function") {
    manualRefresh(); // ✅ tumhara function chalega
  }

  setTimeout(() => {
    loader.style.display = "none";
    isPulled = false;
  }, 2000);
}

// 🔹 Pull-to-refresh detection (mobile)
let startY = 0;
let isPulled = false;

window.addEventListener("touchstart", (e) => {
  if (window.scrollY === 0) {
    startY = e.touches[0].clientY;
  }
});

window.addEventListener("touchmove", (e) => {
  let currentY = e.touches[0].clientY;
  if (window.scrollY === 0 && currentY - startY > 70 && !isPulled) {
    isPulled = true;
    triggerCustomRefresh();
  }
});

window.addEventListener("touchend", () => {
  isPulled = false;
});



</script>
</body>
</html>
