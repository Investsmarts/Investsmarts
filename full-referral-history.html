<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Full Referral History</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

<style>
body {
  background:#f5f7fa;
  font-family: 'Segoe UI', sans-serif;
  padding:20px;
  max-width:450px;
  margin:auto;
}

h2 {
  text-align:center;
  color:#28a745;
  margin-bottom:20px;
}

.history-card {
  background:#fff;
  border:1px solid #e2e2e2;
  padding:14px;
  border-radius:10px;
  margin-bottom:12px;
  box-shadow:0 2px 8px rgba(0,0,0,0.08);
}

.user { font-size:15px; font-weight:600; color:#111; }
.level { color:#555; font-size:13px; margin-top:6px; }
.profit { color:#28a745; font-weight:600; margin-top:6px; }
.time { color:#666; font-size:12px; margin-top:4px; }
</style>
</head>

<body>

<h2>Full Referral History</h2>
<div id="fullReferralList"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, collection, query, where, orderBy, onSnapshot, getDoc, doc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDEQYPJFxQv8yFHptrTqoLHOn2L0PpgVhc",
  authDomain: "btcinvest-c0e25.firebaseapp.com",
  projectId: "btcinvest-c0e25",
  storageBucket: "btcinvest-c0e25.appspot.com",
  messagingSenderId: "204937458487",
  appId: "1:204937458487:web:cc27ece1249999279f60b2"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const list = document.getElementById("fullReferralList");

onAuthStateChanged(auth, (user) => {
  if (!user) return location.href="auth.html";

  const q = query(
    collection(db, "referral_income"),
    where("toUpline", "==", user.uid),
    orderBy("time", "desc")
  );

  onSnapshot(q, async (snap) => {
    list.innerHTML = "";

    if (snap.empty) {
      list.innerHTML = "<p>No referral history found.</p>";
      return;
    }

    for (const docSnap of snap.docs) {
      const d = docSnap.data();
      const date = new Date(d.time).toLocaleString();

      let downName = "User";
      try {
        const downRef = doc(db, "users", d.fromUser);
        const downSnap = await getDoc(downRef);
        if (downSnap.exists()) {
          const u = downSnap.data();
          downName = u.name || u.username || "User";
        }
      } catch {}

      const div = document.createElement("div");
      div.className = "history-card";
      div.innerHTML = `
        <div class="user">ðŸ‘¤ Downline: ${downName}</div>
        <div class="level">Level: ${d.level}</div>
        <div class="profit">Commission: $${d.amount.toFixed(4)}</div>
        <div class="time">ðŸ“… ${date}</div>
      `;
      list.appendChild(div);
    }
  });
});
</script>

</body>
</html>
