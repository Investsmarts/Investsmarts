<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Login</title>

<style>
  body {
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(135deg, #e3f2fd, #f9f9f9);
    margin: 0;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    min-height: 100vh;
  }

  .header {
    position: fixed;
    top: 0; left: 0; right: 0;
    text-align: center;
    padding: 14px;
    font-size: 20px;
    font-weight: bold;
    background: linear-gradient(90deg,#4CAF50,#2c7);
    color: white;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    z-index: 1000;
  }

  .wrapper {
    margin-top: 100px;
    width: 100%;
    max-width: 400px;
    padding: 10px;
  }

  .card {
    background: #fff;
    padding: 25px 30px;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    margin-bottom: 20px;
    text-align: center;
  }

  h2 {
    margin: 0 0 20px 0;
    font-size: 22px;
    font-weight: bold;
    color: #333;
  }

  .input-group {
    position: relative;
    margin: 18px 0;
    width: 100%;
  }

  .input-group input {
    width: 100%;
    padding: 14px 44px 14px 12px;
    font-size: 15px;
    border: 1.5px solid #ccc;
    border-radius: 10px;
    outline: none;
    background: #fff;
    transition: 0.3s;
    box-sizing: border-box;
  }

  .input-group input:focus {
    border-color: #4CAF50;
    box-shadow: 0 0 6px rgba(76,175,80,0.3);
  }

  .input-group label {
    position: absolute;
    left: 14px;
    top: 14px;
    font-size: 15px;
    color: #888;
    background: #fff;
    padding: 0 4px;
    transition: 0.3s;
    pointer-events: none;
  }

  .input-group input:focus + label,
  .input-group input:not(:placeholder-shown) + label {
    top: -8px;
    font-size: 12px;
    color: #4CAF50;
  }

  .password-container i {
    position: absolute;
    right: 14px;
    top: 50%;
    transform: translateY(-50%);
    cursor: pointer;
    font-size: 17px;
    color: #555;
    transition: 0.3s;
  }
  .password-container i:hover { color: #4CAF50; }

  /* âœ… Status Icon */
  .status-icon {
    position: absolute;
    right: 40px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 18px;
    opacity: 0;
    transition: all 0.25s ease;
  }
  .status-icon.active { opacity: 1; }
  .status-icon.green { color: #28a745; }
  .status-icon.red { color: #dc3545; }

  /* ğŸŒ€ Spinner while checking */
  .spinner {
    width: 16px;
    height: 16px;
    border: 2px solid #ccc;
    border-top-color: #4CAF50;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    display: inline-block;
    position: absolute;
    right: 40px;
    top: 50%;
    transform: translateY(-50%);
  }
  @keyframes spin { 100% { transform: translateY(-50%) rotate(360deg); } }

  button {
    width: 100%;
    padding: 12px;
    margin-top: 10px;
    border: none;
    border-radius: 6px;
    background: linear-gradient(90deg,#4CAF50,#2c7);
    color: white;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: 0.3s;
  }
  button:hover { background: #3a9440; }

  .forgot-btn {
    margin-top: 8px;
    background: none;
    border: none;
    color: #0066ff;
    font-size: 14px;
    cursor: pointer;
    text-decoration: underline;
  }

  .login-box {
    margin-top: 16px;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 6px;
    background: #f9f9f9;
    font-size: 14px;
    color: #333;
  }

  .login-box a {
    color: #0066ff;
    font-weight: bold;
    text-decoration: none;
  }

  /* Popup center */
  .popup-overlay {
    position: fixed;
    inset: 0;
    display: none;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(6px);
    background: rgba(0,0,0,0.35);
    z-index: 2000;
  }

  .popup {
    background: #fff;
    padding: 26px 34px;
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    text-align: center;
    font-size: 16px;
    font-weight: 600;
    color: #333;
    transform: scale(0.85);
    opacity: 0;
    transition: all 0.4s cubic-bezier(0.25, 1, 0.3, 1);
  }

  .popup.show {
    opacity: 1;
    transform: scale(1);
  }

  .popup.success { border-left: 6px solid #28a745; }
  .popup.error { border-left: 6px solid #dc3545; }

  /* ğŸŒŸ 3D Powered By Text */
.powered-by {
  margin-top: 18px;
  font-size: 15px;
  font-weight: 600;
  color: #333;
  letter-spacing: 0.6px;
  text-align: center;
  text-shadow: 0px 2px 4px rgba(0,0,0,0.15);
  transform: perspective(500px) translateZ(0);
  transition: all 0.4s ease;
}

.powered-by strong {
  color: #4CAF50;
  text-shadow: 0px 2px 6px rgba(76,175,80,0.4);
  font-weight: 700;
  font-size: 16px;
}

/* ğŸ’« Hover Animation (3D Depth Glow) */
.powered-by:hover {
  transform: perspective(500px) translateZ(10px);
  text-shadow: 0px 4px 8px rgba(76,175,80,0.5);
}

/* ğŸ”´ Locked Button Style */
button.locked {
  background: linear-gradient(90deg, #ff4b2b, #ff416c);
  color: #fff;
  font-weight: 700;
  cursor: not-allowed;
  opacity: 0.9;
  
  transition: all 0.4s ease-in-out;
}

/* Smooth text pulse for timer */
button.locked span {
  animation: pulseText 1s infinite;
}
@keyframes pulseText {
  0% { opacity: 1; }
  50% { opacity: 0.75; }
  100% { opacity: 1; }
}


/* ğŸ Gift Card Styling */
.gift-card {
  text-align: center;
  padding: 20px 18px 25px;
  border-radius: 14px;
  background: #ffffff;
  box-shadow: 0 6px 20px rgba(0,0,0,0.08);
  margin-top: 20px;
  transition: all 0.4s ease;
  transform-style: preserve-3d;
  perspective: 800px;
}

.gift-card:hover {
  transform: translateY(-6px) scale(1.02);
  box-shadow: 0 10px 25px rgba(0,0,0,0.12);
}

/* Title styling */
.gift-title {
  font-size: 18px;
  font-weight: 700;
  color: #333;
  margin-bottom: 12px;
  letter-spacing: 0.3px;
}
.gift-title .brand {
  background: linear-gradient(90deg, #4CAF50, #2c7);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

/* Image box */
.gift-wrapper {
  display: flex;
  justify-content: center;
  align-items: center;
  border-radius: 12px;
  overflow: hidden;
  background: linear-gradient(180deg, #f6fff9, #eef5ff);
  padding: 8px;
  box-shadow: inset 0 2px 6px rgba(0,0,0,0.05);
  transition: all 0.3s ease;
}

.gift-card:hover .gift-wrapper {
  background: linear-gradient(180deg, #e8fff1, #e6f0ff);
}

/* GIF Image */
.gift-image {
  width: 100%;
  max-width: 300px;
  border-radius: 10px;
  transform: scale(1);
  transition: all 0.6s ease;
}

.gift-card:hover .gift-image {
  transform: scale(1.05) rotateX(6deg);
}

/* Responsive */
@media (max-width: 480px) {
  .gift-image {
    max-width: 250px;
  }
  .gift-title {
    font-size: 16px;
  }
}


</style>
</head>

<body>

  <div class="header">ğ€ğœğœğğ¬ğ¬ ğ˜ğ¨ğ®ğ« ğ€ğœğœğ¨ğ®ğ§ğ­ ğ’ğšğŸğğ¥ğ²</div>

  <div id="popupOverlay" class="popup-overlay">
    <div id="popup" class="popup"></div>
  </div>

  <div class="wrapper">
    <div class="card">
      <h2>Login</h2>

      <div class="input-group">
        <input type="text" id="login-identifier" placeholder=" " required>
        <label for="login-identifier">Email / Mobile / Username</label>
        <span id="idStatus" class="status-icon"></span>
      </div>

      <div class="input-group password-container">
        <input type="password" id="login-password" placeholder=" " required>
        <label for="login-password">Password</label>
        <span id="passStatus" class="status-icon"></span>
        <i id="toggle-password">ğŸ‘ï¸</i>
      </div>

      <button id="loginBtn">Login</button>
      <button type="button" id="forgot-btn" class="forgot-btn">Forgot Password?</button>

      <div class="login-box">
        Donâ€™t have an account? <a href="register.html">Register here</a>
      </div>
    </div>

    <!-- ğŸ Gift Animation Card -->
<div class="card gift-card">
  <h3 class="gift-title">Powered by <span class="brand">TrustDollar</span></h3>
  <div class="gift-wrapper">
    <img 
      src="https://miro.medium.com/v2/resize:fit:996/1*V1hv3LGgo1W4wE3Az0mAnw.gif" 
      alt="TrustDollar Gift Animation" 
      class="gift-image"
      loading="lazy"
    />
  </div>
</div>
</div>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

/* ğŸ”¥ Firebase Config */
const firebaseConfig = {
  apiKey: "AIzaSyDEQYPJFxQv8yFHptrTqoLHOn2L0PpgVhc",
  authDomain: "btcinvest-c0e25.firebaseapp.com",
  projectId: "btcinvest-c0e25",
  storageBucket: "btcinvest-c0e25.firebasestorage.app",
  messagingSenderId: "204937458487",
  appId: "1:204937458487:web:cc27ece1249999279f60b2",
  measurementId: "G-HG0Q8ZHT6G"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* âœ… Popup system */
const popup = document.getElementById('popup');
const popupOverlay = document.getElementById('popupOverlay');
function showPopup(msg, type = 'success') {
  popup.textContent = msg;
  popup.className = "popup " + type + " show";
  popupOverlay.style.display = 'flex';
  setTimeout(() => {
    popupOverlay.style.display = 'none';
    popup.className = "popup";
  }, 2000);
}

/* ğŸ‘ï¸ Password Toggle */
document.getElementById("toggle-password").addEventListener("click", () => {
  const pass = document.getElementById("login-password");
  pass.type = pass.type === "password" ? "text" : "password";
});

/* ğŸŸ¢ Real-time User Check */
const idInput = document.getElementById("login-identifier");
const idStatus = document.getElementById("idStatus");
let checkTimer;

idInput.addEventListener("input", () => {
  clearTimeout(checkTimer);
  idStatus.innerHTML = '<span class="spinner"></span>';
  checkTimer = setTimeout(() => checkUser(idInput.value), 600);
});

async function checkUser(value) {
  if (!value.trim()) { idStatus.innerHTML = ""; return; }
  try {
    const ref = doc(db, "logins", value.trim().toLowerCase());
    const snap = await getDoc(ref);
    if (snap.exists()) {
      idStatus.textContent = "âœ…";
      idStatus.className = "status-icon green active";
    } else {
      idStatus.textContent = "âŒ";
      idStatus.className = "status-icon red active";
    }
  } catch (e) {
    idStatus.textContent = "âŒ";
    idStatus.className = "status-icon red active";
  }
}

/* ğŸ”´ Real-time Password Check */
const passInput = document.getElementById("login-password");
const passStatus = document.getElementById("passStatus");
passInput.addEventListener("input", async () => {
  const identifier = idInput.value.trim().toLowerCase();
  const password = passInput.value;
  if (!identifier || password.length < 6) { passStatus.innerHTML = ""; return; }

  passStatus.innerHTML = '<span class="spinner"></span>';
  const ref = doc(db, "logins", identifier);
  const snap = await getDoc(ref);
  if (!snap.exists()) { passStatus.innerHTML = "âŒ"; passStatus.className = "status-icon red active"; return; }

  const email = snap.data().email;
  try {
    await signInWithEmailAndPassword(auth, email, password);
    passStatus.textContent = "âœ…";
    passStatus.className = "status-icon green active";
  } catch {
    passStatus.textContent = "âŒ";
    passStatus.className = "status-icon red active";
  }
});

/* ğŸ§  Secure Login Function with Lock + Countdown Button + Instant Feedback */
document.getElementById("loginBtn").addEventListener("click", async () => {
  const identifier = idInput.value.trim().toLowerCase();
  const password = passInput.value;
  const loginBtn = document.getElementById("loginBtn");

  if (!identifier || !password) return showPopup("Please enter login details", "error");

  // ğŸ”¥ Instant visual feedback
  loginBtn.disabled = true;
  loginBtn.innerHTML = `<span class="spinner" style="margin-right:8px;"></span> Logging in...`;
  loginBtn.style.opacity = "0.8";

  try {
    const ref = doc(db, "logins", identifier);
    const snap = await getDoc(ref);
    if (!snap.exists()) {
      showPopup("Account not found", "error");
      return;
    }

    const email = snap.data().email;
    const userRef = doc(db, "users", email);
    const userSnap = await getDoc(userRef);
    const userData = userSnap.exists() ? userSnap.data() : {};

    const now = Date.now();
    const MAX_FAILED = 3;
    const LOCK_MINUTES = 15;

    if (userData.lockUntil && now < userData.lockUntil) {
      const remainingSeconds = Math.ceil((userData.lockUntil - now) / 1000);
      startButtonCountdown(loginBtn, remainingSeconds);
      return;
    }

    await signInWithEmailAndPassword(auth, email, password);
    await updateDoc(userRef, { failedAttempts: 0, lockUntil: 0 });
    showPopup("âœ… Login successful!", "success");
    setTimeout(() => window.location.href = "Dashboard.html", 1500);

  } catch (error) {
    console.error("Login error:", error);
    const ref = doc(db, "logins", identifier);
    const snap = await getDoc(ref);
    const email = snap.exists() ? snap.data().email : null;
    if (!email) return showPopup("User not found", "error");

    const userRef = doc(db, "users", email);
    const userSnap = await getDoc(userRef);
    const userData = userSnap.exists() ? userSnap.data() : {};
    let newAttempts = (userData.failedAttempts || 0) + 1;
    const updates = { failedAttempts: newAttempts };

    const MAX_FAILED = 3;
    const LOCK_MINUTES = 15;

    if (newAttempts >= MAX_FAILED) {
      updates.lockUntil = Date.now() + LOCK_MINUTES * 60 * 1000;
      showPopup(`âŒ Too many attempts! Account locked for ${LOCK_MINUTES} minutes.`, "error");
      startButtonCountdown(loginBtn, LOCK_MINUTES * 60);
    } else if (newAttempts === MAX_FAILED - 1) {
      showPopup(`âš ï¸ One more wrong attempt will lock your account!`, "error");
    } else {
      showPopup("Incorrect password.", "error");
    }

    await setDoc(userRef, updates, { merge: true });
  } finally {
    // âœ… Restore button to normal state
    loginBtn.disabled = false;
    loginBtn.innerHTML = "Login";
    loginBtn.style.opacity = "1";
  }
});

/* ğŸ•’ Button Countdown Function */
function startButtonCountdown(button, secondsLeft) {
  button.disabled = true;
  button.classList.add("locked");
  const originalHTML = button.innerHTML;

  function updateCountdown() {
    const minutes = Math.floor(secondsLeft / 60);
    const seconds = secondsLeft % 60;
    button.innerHTML = `<span>ğŸ”’ Locked (${minutes}:${seconds.toString().padStart(2, "0")})</span>`;
    secondsLeft--;

    if (secondsLeft < 0) {
      clearInterval(timer);
      button.disabled = false;
      button.classList.remove("locked");
      button.innerHTML = "Login";
      showPopup("ğŸ”“ Account unlocked. Try again.", "success");
    }
  }

  updateCountdown();
  const timer = setInterval(updateCountdown, 1000);
}

/* ğŸ” Forgot Password */
document.getElementById("forgot-btn").addEventListener("click", async () => {
  const email = idInput.value.trim();
  if (!email.includes("@")) return showPopup("Enter valid email", "error");
  try {
    await sendPasswordResetEmail(auth, email);
    showPopup("Password reset link sent", "success");
  } catch (e) {
    showPopup("Error sending link", "error");
  }
});
</script>
</body>
</html>
