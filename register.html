<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Register / Trustdollar</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f0f0;
      margin: 0;
      padding: 0;
    }

    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      width: 100%;
      text-align: center;
      padding: 12px;
      font-size: 18px;
      font-weight: bold;
      background: linear-gradient(90deg,#4CAF50,#2c7);
      color: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      z-index: 1000;
    }

    .wrapper {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      width: 100%;
      margin-top: 80px; 
      padding: 15px;
      box-sizing: border-box;
    }

    .container {
      background: #fff;
      padding: 25px 20px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0,0,0,0.15);
      width: 100%;
      max-width: 400px;
      text-align: center;
    }

    h2 { 
      margin: 0 0 20px 0; 
      font-size: 22px; 
      font-weight: bold; 
      color: #333; 
    }

    /* Floating input group */
    .input-group {
      position: relative;
      margin: 18px 0;
      width: 100%;
    }

    .input-group input {
      width: 100%;
      padding: 14px 12px;
      font-size: 15px;
      border: 1.5px solid #ccc;
      border-radius: 8px;
      outline: none;
      box-sizing: border-box;
      background: #fff;
      transition: 0.3s;
    }

    .input-group label {
      position: absolute;
      left: 14px;
      top: 14px;
      font-size: 15px;
      color: #888;
      pointer-events: none;
      transition: all 0.3s ease;
      background: #fff;
      padding: 0 4px;
    }

    .input-group input:focus {
      border-color: #4CAF50;
      box-shadow: 0 0 6px rgba(76,175,80,0.3);
    }

    .input-group input:focus + label,
    .input-group input:not(:placeholder-shown) + label {
      top: -8px;
      font-size: 12px;
      color: #4CAF50;
      font-weight: 600;
    }

    /* Password eye icon */
    .password-container i {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      font-size: 16px;
      color: #444;
    }

    button {
      width: 100%; 
      padding: 12px; 
      margin-top: 15px;
      border: none; 
      border-radius: 6px;
      background: linear-gradient(90deg,#4CAF50,#2c7);
      color: white;
      font-size: 16px; 
      font-weight: bold;
      cursor: pointer; 
      transition: 0.3s;
    }

    button:hover { background:#3a9440; }

    .login-box {
      margin-top: 16px; 
      padding: 10px;
      border: 1px solid #ddd; 
      border-radius: 6px;
      background: #f9f9f9; 
      font-size: 14px; 
      color: #333;
    }
    .login-box a { color: #0066ff; font-weight: bold; text-decoration: none; }
    .login-box a:hover { text-decoration: underline; }

    .popup {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      padding: 12px 22px;
      border-radius: 8px;
      box-shadow: 0 3px 12px rgba(0,0,0,0.3);
      display: none;
      font-size: 15px;
      z-index: 2000;
      opacity: 0;
      transition: opacity 0.4s ease-in-out;
    }
    .popup.show { display:block; opacity:1; }
    .popup.success { border-left: 5px solid green; }
    .popup.error { border-left: 5px solid red; }

    /* ✅ Mobile Responsive */
    @media (max-width: 480px) {
      .container {
        padding: 20px 15px;
        border-radius: 8px;
      }
      h2 { font-size: 20px; }
      .input-group input { font-size: 14px; padding: 12px 10px; }
      .input-group label { font-size: 14px; }
      button { font-size: 15px; padding: 10px; }
    }
  </style>
</head>
<body>
  <div class="header">𝐒𝐞𝐜𝐮𝐫𝐞 𝐘𝐨𝐮𝐫 𝐅𝐮𝐧𝐝𝐬 𝐰𝐢𝐭𝐡 𝐒𝐚𝐟𝐞</div>
  <div class="wrapper">
    <div class="container">
      <h2>Register</h2>

      <!-- Name -->
      <div class="input-group">
        <input type="text" id="name" placeholder=" " required>
        <label for="name">Enter your full name as per Aadhaar</label>
      </div>

      <!-- Email -->
      <div class="input-group">
        <input type="text" id="register-email" placeholder=" " required>
        <label for="register-email">Email</label>
      </div>

      <!-- Username -->
      <div class="input-group">
        <input type="text" id="username" placeholder=" " required>
        <label for="username">Username</label>
      </div>

      <!-- Mobile -->
      <div class="input-group">
        <input type="text" id="mobile" placeholder=" " required>
        <label for="mobile">Mobile Number</label>
      </div>

      <!-- Aadhaar -->
      <div class="input-group">
        <input type="text" id="aadhaar" placeholder=" " required>
        <label for="aadhaar">Aadhaar</label>
      </div>

      <!-- Cheque -->
      <div class="input-group">
        <input type="text" id="cheque" placeholder=" ">
        <label for="cheque">Upline Cheque (Optional)</label>
      </div>

      <!-- Password -->
      <div class="input-group password-container">
        <input type="password" id="password" placeholder=" " required>
        <label for="password">Password</label>
        <i id="toggle-password">👁️</i>
      </div>

      <!-- Confirm Password -->
      <div class="input-group password-container">
        <input type="password" id="confirm-password" placeholder=" " required>
        <label for="confirm-password">Confirm Password</label>
        <i id="toggle-confirm-password">👁️</i>
      </div>

      <!-- Referral -->
      <div class="input-group">
        <input type="text" id="referral" placeholder=" ">
        <label for="referral">Referral Code (Optional)</label>
      </div>

      <button id="registerBtn">Register</button>

      <div class="login-box">
        Already have an account? <a href="login.html">Login here</a>
      </div>
      <!-- ✅ Popup element -->
      <div id="popup" class="popup"></div>
    </div>
  </div>
<style>
  .popup {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: #fff;
    padding: 12px 22px;
    border-radius: 8px;
    box-shadow: 0 3px 12px rgba(0,0,0,0.3);
    display: none;
    font-size: 15px;
    z-index: 2000;
    opacity: 0;
    transition: opacity 0.4s ease-in-out;
  }
  .popup.show { display:block; opacity:1; }
  .popup.success { border-left: 5px solid green; }
  .popup.error { border-left: 5px solid red; }
</style>



<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
  import { getFirestore, collection, doc, setDoc, getDocs, query, where, addDoc, orderBy, limit } 
    from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDEQYPJFxQv8yFHptrTqoLHOn2L0PpgVhc",
    authDomain: "btcinvest-c0e25.firebaseapp.com",
    projectId: "btcinvest-c0e25",
    storageBucket: "btcinvest-c0e25.firebasestorage.app",
    messagingSenderId: "204937458487",
    appId: "1:204937458487:web:cc27ece1249999279f60b2",
    measurementId: "G-HG0Q8ZHT6G"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const popup = document.getElementById("popup");
  function showPopup(msg, type="success") {
    popup.textContent = msg;
    popup.className = `popup ${type} show`;
    setTimeout(() => { popup.classList.remove("show"); }, 2500);
  }

  function validateEmailFormat(email){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email); }

  // normalize email: lowercase, trim, for gmail remove dots and +tag
  function normalizeEmail(email) {
    if(!email) return "";
    email = email.trim().toLowerCase();
    const parts = email.split("@");
    if(parts.length !== 2) return email;
    let [local, domain] = parts;
    // remove trailing/leading dots in local
    local = local.replace(/^\.+|\.+$/g, "");
    // gmail / googlemail canonicalization
    if(domain === "gmail.com" || domain === "googlemail.com") {
      // remove everything after + and remove dots
      local = local.split("+")[0].replace(/\./g, "");
      domain = "gmail.com";
    } else {
      // for other providers, remove +tag but keep dots (optional)
      local = local.split("+")[0];
    }
    return `${local}@${domain}`;
  }

  // normalize simple text (name/username)
  function normalizeText(txt) {
    if(!txt) return "";
    // lowercase, trim, collapse multiple spaces
    return txt.trim().toLowerCase().replace(/\s+/g, " ");
  }

  // Levenshtein distance (for fuzzy)
  function levenshtein(a, b) {
    if(a === b) return 0;
    const al = a.length, bl = b.length;
    if(al === 0) return bl;
    if(bl === 0) return al;
    const v0 = new Array(bl + 1);
    const v1 = new Array(bl + 1);
    for (let i = 0; i <= bl; i++) v0[i] = i;
    for (let i = 0; i < al; i++) {
      v1[0] = i + 1;
      for (let j = 0; j < bl; j++) {
        const cost = a[i] === b[j] ? 0 : 1;
        v1[j + 1] = Math.min(v1[j] + 1, v0[j + 1] + 1, v0[j] + cost);
      }
      for (let k = 0; k <= bl; k++) v0[k] = v1[k];
    }
    return v1[bl];
  }

  // fuzzy check: query by prefix (first 3-4 chars) and compare levenshtein
  async function fuzzyCheck(field, normalizedValue) {
    if(!normalizedValue) return null;
    const prefix = normalizedValue.slice(0, 4); // first 4 chars
    if(prefix.length === 0) return null;
    const usersRef = collection(db, "users");
    // Firestore range query for prefix (field >= prefix and field <= prefix + '\uf8ff')
    // Note: ensure the field is stored normalized in Firestore (lowercase)
    const start = prefix;
    const end = prefix + '\uf8ff';
    const q = query(usersRef, where(field, ">=", start), where(field, "<=", end), limit(20));
    const snap = await getDocs(q);
    if(snap.empty) return null;
    let closest = null;
    snap.forEach(d => {
      const data = d.data();
      const val = (data[field] || "").toString().toLowerCase();
      const dist = levenshtein(val, normalizedValue);
      if(closest === null || dist < closest.dist) closest = { dist, val, id: d.id, data };
    });
    return closest; // object or null
  }


  document.getElementById("registerBtn").addEventListener("click", async () => {
    const btn = document.getElementById("registerBtn");
    btn.disabled = true;
    btn.textContent = "Please wait...";

    let name = document.getElementById("name").value;
    let regEmail = document.getElementById("register-email").value;
    let username = document.getElementById("username").value;
    const mobile = document.getElementById("mobile").value.trim();
    const aadhaar = document.getElementById("aadhaar").value.trim();
    const cheque = document.getElementById("cheque").value.trim();
    const password = document.getElementById("password").value;
    const confirmPassword = document.getElementById("confirm-password").value;
    const referral = document.getElementById("referral").value.trim();

    try {
      // basic presence checks
      if(!name || !regEmail || !username || !mobile || !aadhaar || !password || !confirmPassword)
        throw new Error("Please complete all required fields");

      // normalize
      const normEmail = normalizeEmail(regEmail);
      const normUsername = normalizeText(username);
      const normName = normalizeText(name);

      // validations
      if(!validateEmailFormat(regEmail)) throw new Error("Invalid Email format");
      if(password !== confirmPassword) throw new Error("Passwords do not match");
      if(password.length < 6) throw new Error("Password must be at least 6 chars");
      if(!/^\d{10}$/.test(mobile)) throw new Error("Mobile must be 10 digits");
      if(!/^\d{12}$/.test(aadhaar)) throw new Error("Aadhaar must be 12 digits");
      if(cheque !== "" && !/^\d{6,20}$/.test(cheque)) throw new Error("Cheque must be 6-20 digits");

      const usersRef = collection(db, "users");

      // 1) Exact duplicate checks (normalized)
      const exactChecks = [
        { field: "email", value: normEmail, msg: "Email already registered" },
        { field: "mobile", value: mobile, msg: "Mobile already registered" },
        { field: "username", value: normUsername, msg: "Username already taken" },
        { field: "aadhaar", value: aadhaar, msg: "Aadhaar already registered" }
      ];

      for(const c of exactChecks) {
        const q = query(usersRef, where(c.field, "==", c.value));
        const snap = await getDocs(q);
        if(!snap.empty) throw new Error(c.msg);
      }

      // 2) Fuzzy checks for name & username (catch typos like chaitanya/chaitnaya)
      // name fuzzy
      const nameCandidate = await fuzzyCheck("name", normName);
      if(nameCandidate && nameCandidate.dist <= 2) { // threshold: 2 edits
        throw new Error("Similar name already registered: " + nameCandidate.val);
      }
      // username fuzzy
      const usernameCandidate = await fuzzyCheck("username", normUsername);
      if(usernameCandidate && usernameCandidate.dist <= 1) { // stricter for username
        throw new Error("Similar username already exists: " + usernameCandidate.val);
      }

      // ✅ Create user
const userCredential = await createUserWithEmailAndPassword(auth, normEmail, password);
const user = userCredential.user;
const finalReferral = "REF" + Math.floor(Math.random()*900000+100000);

// ✅ Pehle object banao
let userDocData = {
  name: normName,
  email: normEmail,
  username: normUsername,
  mobile,
  aadhaar,
  chequeNumber: cheque !== "" ? cheque : null,
  referralCode: finalReferral,
  referredBy: referral !== "" ? referral : null,
  walletBalance: 0,
  totalInvested: 0,
  createdAt: new Date().toISOString()
};

// ✅ Agar referral diya gaya hai to uplines nikal lo
if(referral){
  const q = query(collection(db, "users"), where("referralCode", "==", referral));
  const snap = await getDocs(q);
  if(!snap.empty){
    const refUser = snap.docs[0].data();
    const refUserId = snap.docs[0].id;
    userDocData.upline1 = refUserId;

    if(refUser.referredBy){
      const q2 = query(collection(db, "users"), where("referralCode", "==", refUser.referredBy));
      const snap2 = await getDocs(q2);
      if(!snap2.empty){
        const refUser2 = snap2.docs[0].data();
        const refUser2Id = snap2.docs[0].id;
        userDocData.upline2 = refUser2Id;

        if(refUser2.referredBy){
          const q3 = query(collection(db, "users"), where("referralCode", "==", refUser2.referredBy));
          const snap3 = await getDocs(q3);
          if(!snap3.empty){
            const refUser3Id = snap3.docs[0].id;
            userDocData.upline3 = refUser3Id;
          }
        }
      }
    }
  }
}


// ✅ Bas ek hi baar Firestore me save karo
await setDoc(doc(db, "users", user.uid), userDocData);

// ✅ 3-way login lookup entries banao (email / username / mobile)
try {
  await setDoc(doc(db, "logins", normEmail), { email: normEmail });
  await setDoc(doc(db, "logins", normUsername), { email: normEmail });
  await setDoc(doc(db, "logins", mobile), { email: normEmail });
  console.log("✅ Login lookup entries created for:", normEmail);
} catch (e) {
  console.error("❌ Failed to create login lookup:", e);
}

showPopup("Registration Successful!");
setTimeout(()=> window.location.href="Dashboard.html", 1500);


    } catch(err) {
      console.error("❌ Register error:", err.message);
      showPopup(err.message, "error");
    } finally {
      btn.disabled = false;
      btn.textContent = "Register";
    }
  });

  // Auto set referral if present in URL
  const urlParams = new URLSearchParams(window.location.search);
  const refFromLink = urlParams.get("ref");
  if(refFromLink){
    const referralInput = document.getElementById("referral");
    referralInput.value = refFromLink;
    referralInput.readOnly = true;
  }
</script>
<script>
// ❌ Right-click disable
  document.addEventListener("contextmenu", function(e) {
    e.preventDefault();
    
  });

// ❌ Disable text selection
  document.addEventListener("selectstart", function(e) {
    e.preventDefault();
  });

// ❌ Disable copy (Ctrl+C), cut (Ctrl+X), paste (Ctrl+V), view-source (Ctrl+U)
  document.addEventListener("keydown", function(e) {
    if (
      (e.ctrlKey && (e.key === "c" || e.key === "C")) || 
      (e.ctrlKey && (e.key === "x" || e.key === "X")) || 
      (e.ctrlKey && (e.key === "v" || e.key === "V")) || 
      (e.ctrlKey && (e.key === "u" || e.key === "U")) || 
    (e.key === "F12") // DevTools
    ) {
      e.preventDefault();
    
  }
});
</script>

<script>
// ✅ Jab bhi input focus ho, usko visible karo
  const inputs = document.querySelectorAll("input");
  inputs.forEach(input => {
    input.addEventListener("focus", () => {
      setTimeout(() => {
        input.scrollIntoView({ behavior: "smooth", block: "center" });
      }, 300);
    });
  });
</script>

</body>
</html>
