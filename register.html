 <!DOCTYPE html>
 <html lang="en">
 <head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Register/ Trustdollar / with - very Safe your fund //////</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f0f0;
      margin:0;
    }
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;   /* âœ… dono side lock */
      width: 100%;
      text-align: center;
      padding: 12px;
      font-size: 18px;
      font-weight: bold;
      background: linear-gradient(90deg,#4CAF50,#2c7);
      color: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      z-index: 1000;

      /* ğŸ‘‡ Extra fix for stability */
      transform: translateZ(0);    
      will-change: transform;
      -webkit-backface-visibility: hidden;
      backface-visibility: hidden;
    }


    html, body {
      margin: 0;
      padding: 0;
      overflow-x: hidden;   /* âœ… Left-right scroll band */
      width: 100%;
    }

    .wrapper, .container, .info-box {
      max-width: 100%;     
      box-sizing: border-box;
    }

    .wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      margin-top: 70px; /* header ke neeche space */
      padding: 15px;
      padding-bottom: 80px;  /* âœ… extra safe space */
      box-sizing: border-box;
    }


    
    .container {
      background: #fff;
      padding: 20px 25px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      width: 100%;
      max-width: 400px;
      text-align: center;
    }

    h2 { margin:0 0 12px 0; font-size:22px; font-weight:bold; }
    input {
      width: 100%; padding: 10px; margin: 8px 0;
      border-radius: 5px; border: 1px solid #ccc;
      box-sizing: border-box; font-size:14px;
    }
    .password-container { position: relative; }
    .password-container i {
      position: absolute; right: 10px; top: 50%;
      transform: translateY(-50%); cursor: pointer; font-size:16px;
    }
    button {
      width: 100%; padding: 10px; margin-top: 10px;
      border: none; border-radius: 5px;
      background: #4CAF50; color: white;
      font-size: 16px; font-weight:bold;
      cursor: pointer; display:flex; align-items:center; justify-content:center;
      gap:8px; transition: background 0.3s;
    }
    button:hover { background:#3a9440; }
    .popup {
      position: fixed; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: #fff; padding: 15px 25px;
      border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.3);
      display: none; z-index: 2000; font-size: 15px;
    }
    .popup.success { border-left: 5px solid green; }
    .popup.error { border-left: 5px solid red; }

    .login-box {
      margin-top: 14px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      background: #f9f9f9;
      font-size: 14px;
      color: #333;
    }
    .login-box a {
      color: #0066ff;
      font-weight: bold;
      text-decoration: none;
    }
    .login-box a:hover {
      text-decoration: underline;
    }

  </style>
</head>
<body>
  <div class="header">ğ’ğğœğ®ğ«ğ ğ˜ğ¨ğ®ğ« ğ…ğ®ğ§ğğ¬ ğ°ğ¢ğ­ğ¡ ğ’ğšğŸğ</div>
  <div class="wrapper">
    <div class="container">
      <h2>Register</h2>
      <input type="text" id="name" placeholder="Name">
      <input type="text" id="register-email" placeholder="Email">
      <input type="text" id="username" placeholder="Username">
      <input type="text" id="mobile" placeholder="Mobile Number">
      <input type="text" id="aadhaar" placeholder="Aadhaar">
      <input type="text" id="cheque" placeholder="Upline Cheque (Optional)">
      <div class="password-container">
        <input type="password" id="password" placeholder="Password">
        <i id="toggle-password">ğŸ‘ï¸</i>
      </div>
      <div class="password-container">
        <input type="password" id="confirm-password" placeholder="Confirm Password">
        <i id="toggle-confirm-password">ğŸ‘ï¸</i>
      </div>
      <input type="text" id="referral" placeholder="Referral Code (Optional)">

      <button id="registerBtn">Register</button>

      <!-- âœ… Login redirect box -->
      <div class="login-box">
        Already have an account? 
        <a href="login.html">Login here</a>
      </div>

    </div>
<div id="popup" class="popup"></div>

<style>
  .popup {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: #fff;
    padding: 12px 22px;
    border-radius: 8px;
    box-shadow: 0 3px 12px rgba(0,0,0,0.3);
    display: none;
    font-size: 15px;
    z-index: 2000;
    opacity: 0;
    transition: opacity 0.4s ease-in-out;
  }
  .popup.show { display:block; opacity:1; }
  .popup.success { border-left: 5px solid green; }
  .popup.error { border-left: 5px solid red; }
</style>


<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
  import { getFirestore, collection, doc, setDoc, getDocs, query, where, addDoc, orderBy, limit } 
    from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDEQYPJFxQv8yFHptrTqoLHOn2L0PpgVhc",
    authDomain: "btcinvest-c0e25.firebaseapp.com",
    projectId: "btcinvest-c0e25",
    storageBucket: "btcinvest-c0e25.firebasestorage.app",
    messagingSenderId: "204937458487",
    appId: "1:204937458487:web:cc27ece1249999279f60b2",
    measurementId: "G-HG0Q8ZHT6G"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const popup = document.getElementById("popup");
  function showPopup(msg, type="success") {
    popup.textContent = msg;
    popup.className = `popup ${type} show`;
    setTimeout(() => { popup.classList.remove("show"); }, 2500);
  }

  function validateEmailFormat(email){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email); }

  // normalize email: lowercase, trim, for gmail remove dots and +tag
  function normalizeEmail(email) {
    if(!email) return "";
    email = email.trim().toLowerCase();
    const parts = email.split("@");
    if(parts.length !== 2) return email;
    let [local, domain] = parts;
    // remove trailing/leading dots in local
    local = local.replace(/^\.+|\.+$/g, "");
    // gmail / googlemail canonicalization
    if(domain === "gmail.com" || domain === "googlemail.com") {
      // remove everything after + and remove dots
      local = local.split("+")[0].replace(/\./g, "");
      domain = "gmail.com";
    } else {
      // for other providers, remove +tag but keep dots (optional)
      local = local.split("+")[0];
    }
    return `${local}@${domain}`;
  }

  // normalize simple text (name/username)
  function normalizeText(txt) {
    if(!txt) return "";
    // lowercase, trim, collapse multiple spaces
    return txt.trim().toLowerCase().replace(/\s+/g, " ");
  }

  // Levenshtein distance (for fuzzy)
  function levenshtein(a, b) {
    if(a === b) return 0;
    const al = a.length, bl = b.length;
    if(al === 0) return bl;
    if(bl === 0) return al;
    const v0 = new Array(bl + 1);
    const v1 = new Array(bl + 1);
    for (let i = 0; i <= bl; i++) v0[i] = i;
    for (let i = 0; i < al; i++) {
      v1[0] = i + 1;
      for (let j = 0; j < bl; j++) {
        const cost = a[i] === b[j] ? 0 : 1;
        v1[j + 1] = Math.min(v1[j] + 1, v0[j + 1] + 1, v0[j] + cost);
      }
      for (let k = 0; k <= bl; k++) v0[k] = v1[k];
    }
    return v1[bl];
  }

  // fuzzy check: query by prefix (first 3-4 chars) and compare levenshtein
  async function fuzzyCheck(field, normalizedValue) {
    if(!normalizedValue) return null;
    const prefix = normalizedValue.slice(0, 4); // first 4 chars
    if(prefix.length === 0) return null;
    const usersRef = collection(db, "users");
    // Firestore range query for prefix (field >= prefix and field <= prefix + '\uf8ff')
    // Note: ensure the field is stored normalized in Firestore (lowercase)
    const start = prefix;
    const end = prefix + '\uf8ff';
    const q = query(usersRef, where(field, ">=", start), where(field, "<=", end), limit(20));
    const snap = await getDocs(q);
    if(snap.empty) return null;
    let closest = null;
    snap.forEach(d => {
      const data = d.data();
      const val = (data[field] || "").toString().toLowerCase();
      const dist = levenshtein(val, normalizedValue);
      if(closest === null || dist < closest.dist) closest = { dist, val, id: d.id, data };
    });
    return closest; // object or null
  }


  document.getElementById("registerBtn").addEventListener("click", async () => {
    const btn = document.getElementById("registerBtn");
    btn.disabled = true;
    btn.textContent = "Please wait...";

    let name = document.getElementById("name").value;
    let regEmail = document.getElementById("register-email").value;
    let username = document.getElementById("username").value;
    const mobile = document.getElementById("mobile").value.trim();
    const aadhaar = document.getElementById("aadhaar").value.trim();
    const cheque = document.getElementById("cheque").value.trim();
    const password = document.getElementById("password").value;
    const confirmPassword = document.getElementById("confirm-password").value;
    const referral = document.getElementById("referral").value.trim();

    try {
      // basic presence checks
      if(!name || !regEmail || !username || !mobile || !aadhaar || !password || !confirmPassword)
        throw new Error("Please complete all required fields");

      // normalize
      const normEmail = normalizeEmail(regEmail);
      const normUsername = normalizeText(username);
      const normName = normalizeText(name);

      // validations
      if(!validateEmailFormat(regEmail)) throw new Error("Invalid Email format");
      if(password !== confirmPassword) throw new Error("Passwords do not match");
      if(password.length < 6) throw new Error("Password must be at least 6 chars");
      if(!/^\d{10}$/.test(mobile)) throw new Error("Mobile must be 10 digits");
      if(!/^\d{12}$/.test(aadhaar)) throw new Error("Aadhaar must be 12 digits");
      if(cheque !== "" && !/^\d{6,20}$/.test(cheque)) throw new Error("Cheque must be 6-20 digits");

      const usersRef = collection(db, "users");

      // 1) Exact duplicate checks (normalized)
      const exactChecks = [
        { field: "email", value: normEmail, msg: "Email already registered" },
        { field: "mobile", value: mobile, msg: "Mobile already registered" },
        { field: "username", value: normUsername, msg: "Username already taken" },
        { field: "aadhaar", value: aadhaar, msg: "Aadhaar already registered" }
      ];

      for(const c of exactChecks) {
        const q = query(usersRef, where(c.field, "==", c.value));
        const snap = await getDocs(q);
        if(!snap.empty) throw new Error(c.msg);
      }

      // 2) Fuzzy checks for name & username (catch typos like chaitanya/chaitnaya)
      // name fuzzy
      const nameCandidate = await fuzzyCheck("name", normName);
      if(nameCandidate && nameCandidate.dist <= 2) { // threshold: 2 edits
        throw new Error("Similar name already registered: " + nameCandidate.val);
      }
      // username fuzzy
      const usernameCandidate = await fuzzyCheck("username", normUsername);
      if(usernameCandidate && usernameCandidate.dist <= 1) { // stricter for username
        throw new Error("Similar username already exists: " + usernameCandidate.val);
      }

      // âœ… Create user
const userCredential = await createUserWithEmailAndPassword(auth, normEmail, password);
const user = userCredential.user;
const finalReferral = "REF" + Math.floor(Math.random()*900000+100000);

// âœ… Pehle object banao
let userDocData = {
  name: normName,
  email: normEmail,
  username: normUsername,
  mobile,
  aadhaar,
  chequeNumber: cheque !== "" ? cheque : null,
  referralCode: finalReferral,
  referredBy: referral !== "" ? referral : null,
  walletBalance: 0,
  totalInvested: 0,
  createdAt: new Date().toISOString()
};

// âœ… Agar referral diya gaya hai to uplines nikal lo
if(referral){
  const q = query(collection(db, "users"), where("referralCode", "==", referral));
  const snap = await getDocs(q);
  if(!snap.empty){
    const refUser = snap.docs[0].data();
    const refUserId = snap.docs[0].id;
    userDocData.upline1 = refUserId;

    if(refUser.referredBy){
      const q2 = query(collection(db, "users"), where("referralCode", "==", refUser.referredBy));
      const snap2 = await getDocs(q2);
      if(!snap2.empty){
        const refUser2 = snap2.docs[0].data();
        const refUser2Id = snap2.docs[0].id;
        userDocData.upline2 = refUser2Id;

        if(refUser2.referredBy){
          const q3 = query(collection(db, "users"), where("referralCode", "==", refUser2.referredBy));
          const snap3 = await getDocs(q3);
          if(!snap3.empty){
            const refUser3Id = snap3.docs[0].id;
            userDocData.upline3 = refUser3Id;
          }
        }
      }
    }
  }
}

// âœ… Bas ek hi baar Firestore me save karo
await setDoc(doc(db, "users", user.uid), userDocData);

      showPopup("Registration Successful!");
      setTimeout(()=> window.location.href="Dashboard.html", 1500);

    } catch(err) {
      console.error("âŒ Register error:", err.message);
      showPopup(err.message, "error");
    } finally {
      btn.disabled = false;
      btn.textContent = "Register";
    }
  });

  // Auto set referral if present in URL
  const urlParams = new URLSearchParams(window.location.search);
  const refFromLink = urlParams.get("ref");
  if(refFromLink){
    const referralInput = document.getElementById("referral");
    referralInput.value = refFromLink;
    referralInput.readOnly = true;
  }
</script>
<script>
// âŒ Right-click disable
  document.addEventListener("contextmenu", function(e) {
    e.preventDefault();
    
  });

// âŒ Disable text selection
  document.addEventListener("selectstart", function(e) {
    e.preventDefault();
  });

// âŒ Disable copy (Ctrl+C), cut (Ctrl+X), paste (Ctrl+V), view-source (Ctrl+U)
  document.addEventListener("keydown", function(e) {
    if (
      (e.ctrlKey && (e.key === "c" || e.key === "C")) || 
      (e.ctrlKey && (e.key === "x" || e.key === "X")) || 
      (e.ctrlKey && (e.key === "v" || e.key === "V")) || 
      (e.ctrlKey && (e.key === "u" || e.key === "U")) || 
    (e.key === "F12") // DevTools
    ) {
      e.preventDefault();
    
  }
});
</script>

<script>
// âœ… Jab bhi input focus ho, usko visible karo
  const inputs = document.querySelectorAll("input");
  inputs.forEach(input => {
    input.addEventListener("focus", () => {
      setTimeout(() => {
        input.scrollIntoView({ behavior: "smooth", block: "center" });
      }, 300);
    });
  });
</script>

</body>
</html>
