<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TrustDollar ‚Äî Cloud Mining</title>

<style>
:root {
  --green: #16a34a;
  --bg: #f8fafc;
  --text-dark: #0f172a;
}
body {
  font-family: "Poppins", sans-serif;
  background: var(--bg);
  color: var(--text-dark);
  padding: 20px;
  display: flex;
  justify-content: center;
}
.card {
  background: #fff;
  padding: 25px;
  border-radius: 20px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.1);
  width: 100%;
  max-width: 850px;
  transition: all 0.3s ease;
}
.wallet {
  display: flex;
  justify-content: space-between;
  background: #f0fdf4;
  border: 1px solid #bbf7d0;
  border-radius: 12px;
  padding: 12px 18px;
  margin-bottom: 20px;
  font-weight: 600;
  color: #14532d;
}
.plans {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 16px;
  margin-top: 25px;
}
.plan {
  background: #ffffff;
  border: 1.5px solid #e5e7eb;
  border-radius: 14px;
  text-align: center;
  padding: 18px;
  box-shadow: 0 3px 12px rgba(0,0,0,0.05);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.plan:hover {
  transform: translateY(-6px);
  box-shadow: 0 6px 18px rgba(22,163,74,0.2);
}
.plan h3 {
  color: var(--green);
  margin-bottom: 8px;
  font-weight: 700;
}
.plan p {
  font-size: 14px;
  color: #475569;
  margin: 5px 0;
}
.btn {
  background: linear-gradient(135deg,#16a34a,#22c55e);
  color: #fff;
  padding: 12px;
  border: none;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
  width: 100%;
  margin-top: 12px;
  transition: all 0.2s ease;
}
.btn:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(22,163,74,0.3);
}
.profit-box {
  background: #ecfdf5;
  border: 1px solid #bbf7d0;
  border-radius: 12px;
  padding: 14px;
  margin: 16px 0;
  font-size: 15px;
  color: #166534;
  line-height: 1.6;
}

/* ‚úÖ Modal Overlay */
/* ‚úÖ Smooth Modal (no flicker, with fade + zoom animation) */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.55);
  backdrop-filter: blur(10px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 5000;
  opacity: 0;
  transition: opacity 0.35s ease-in-out;
}

/* Show state ‚Äî smooth fade in */
.modal.show {
  display: flex;
  opacity: 1;
}

/* ‚úÖ Centered Card with Depth */
.modal-card {
  width: 90%;
  max-width: 420px;
  border-radius: 18px;
  overflow: hidden;
  background: #fff;
  box-shadow: 0 12px 50px rgba(0, 0, 0, 0.3);
  transform: scale(0.9) translateY(20px);
  opacity: 0;
  transition: all 0.35s ease-in-out;
}

/* When modal is visible ‚Äî card smoothly expands and fades in */
.modal.show .modal-card {
  transform: scale(1) translateY(0);
  opacity: 1;
}

/* Header */
.modal-head {
  background: linear-gradient(135deg, #16a34a, #22c55e);
  color: #fff;
  padding: 18px;
  text-align: center;
  position: relative;
  font-weight: 700;
  letter-spacing: 0.5px;
}
.modal-head h2 {
  margin: 0;
  font-size: 1.3rem;
}
.close-btn {
  position: absolute;
  top: 12px;
  right: 16px;
  border: none;
  background: none;
  font-size: 24px;
  color: #fff;
  cursor: pointer;
  opacity: 0.9;
  transition: 0.2s;
}
.close-btn:hover {
  opacity: 1;
  transform: scale(1.2);
}

/* Body */
.modal-body {
  background: #fff;
  padding: 22px;
  text-align: center;
}
.modal-body p {
  margin: 8px 0;
  color: #475569;
  font-size: 15px;
}
.wallet-line {
  margin-top: 10px;
  font-weight: 600;
  color: #0f172a;
}
.modal-error {
  display: none;
  color: #dc2626;
  font-weight: 600;
  margin: 8px 0;
}

/* Buttons */
.modal-actions {
  display: flex;
  gap: 10px;
  margin-top: 18px;
}
.confirm-btn {
  flex: 1;
  background: linear-gradient(135deg, #16a34a, #22c55e);
  color: #fff;
  border: none;
  border-radius: 10px;
  padding: 12px;
  font-weight: 600;
  font-size: 15px;
  cursor: pointer;
  transition: all 0.2s ease;
}
.confirm-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 0 14px rgba(22, 163, 74, 0.4);
}
.cancel-btn {
  flex: 1;
  background: #f1f5f9;
  color: #0f172a;
  border: none;
  border-radius: 10px;
  padding: 12px;
  font-weight: 600;
  font-size: 15px;
  cursor: pointer;
  transition: 0.2s;
}
.cancel-btn:hover {
  background: #e2e8f0;
}

/* ‚úÖ Responsive Fix */
@media (max-width: 480px) {
  .card { padding: 16px; }
  .plan { padding: 14px; }
  .modal-body { padding: 18px; }
}
/* allert sms pop up ke liye */
.center-alert {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.9);
  background: rgba(22, 163, 74, 0.95);
  color: #fff;
  padding: 14px 28px;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 600;
  text-align: center;
  box-shadow: 0 10px 30px rgba(22, 163, 74, 0.4);
  opacity: 0;
  z-index: 9999;
  transition: all 0.4s ease;
  pointer-events: none;
}
.center-alert.show {
  opacity: 1;
  transform: translate(-50%, -50%) scale(1);
}
@keyframes fadeOut {
  from { opacity: 1; transform: translate(-50%, -50%) scale(1); }
  to { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
}


/* üíé Plan Summary Box */
.plan-summary {
  border: 1.5px solid #d1fae5;
  background: #f0fdf4;
  border-radius: 12px;
  padding: 16px 18px;
  margin-bottom: 16px;
  box-shadow: 0 2px 8px rgba(22, 163, 74, 0.1);
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.summary-row {
  display: flex;
  justify-content: space-between;
  font-size: 15px;
  color: #064e3b;
  font-weight: 500;
  border-bottom: 1px dashed #bbf7d0;
  padding-bottom: 6px;
}

.summary-row:last-child {
  border-bottom: none;
}

.summary-row strong {
  color: #065f46;
  font-weight: 600;
}

.wallet-info {
  background: #dcfce7;
  border-radius: 8px;
  padding: 6px 10px;
  box-shadow: inset 0 0 5px rgba(22,163,74,0.15);
}

/* ‚ö†Ô∏è Animated Pro Alert */
.balance-alert {
  display: none;
  align-items: center;
  justify-content: center;
  gap: 8px;
  background: linear-gradient(90deg, #fef3c7, #fde68a);
  border: 1.5px solid #facc15;
  color: #92400e;
  font-weight: 600;
  padding: 10px 16px;
  border-radius: 12px;
  margin-top: 12px;
  font-size: 15px;
  box-shadow: 0 4px 14px rgba(250, 204, 21, 0.35);
  opacity: 0;
  transform: translateY(10px);
  transition: all 0.4s ease-in-out;
}

.balance-alert.show {
  display: flex;
  opacity: 1;
  transform: translateY(0);
}

.alert-icon {
  font-size: 18px;
  animation: pulseIcon 1.2s infinite;
}

@keyframes pulseIcon {
  0%, 100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.2); opacity: 0.7; }
}

#activeCountdown {
  font-weight: 700;
  color: #16a34a;
  letter-spacing: 0.5px;
}
/* üåÄ Circular Countdown Ring */
.progress-ring {
  position: relative;
  width: 80px;
  height: 80px;
  margin: 10px auto;
}

.ring {
  transform: rotate(-90deg);
}

.ring-bg,
.ring-fill {
  fill: none;
  stroke-width: 6;
  cx: 40;
  cy: 40;
  r: 35;
}

.ring-bg {
  stroke: #d1fae5;
}

.ring-fill {
  stroke: #16a34a;
  stroke-linecap: round;
  stroke-dasharray: 220;
  stroke-dashoffset: 220; /* ‚úÖ fixed default position */
  transition: stroke-dashoffset 1s linear;
}



.ring-time {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 14px;
  font-weight: 600;
  color: #065f46;
}
@keyframes fadeSlide {
  from {opacity: 0; transform: translateY(-3px);}
  to {opacity: 1; transform: translateY(0);}
}

.plan .buy-btn:disabled {
  background: linear-gradient(135deg, #9ca3af, #d1d5db);
  color: #1f2937;
  cursor: not-allowed;
  box-shadow: none;
}

#activePlanBox {
  display: grid;
  gap: 12px;
}

.status-badge {
  display: inline-block;
  background: #16a34a;
  color: #fff;
  font-size: 12px;
  padding: 4px 8px;
  border-radius: 8px;
  margin-bottom: 6px;
}
.status-badge.completed {
  background: #dc2626;
}

/* üïí Active Plan Countdown Box */
.countdown-box {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: linear-gradient(145deg, #ecfdf5, #ffffff);
  border: 1.5px solid #bbf7d0;
  border-radius: 14px;
  padding: 18px;
  margin-top: 10px;
  box-shadow: 0 4px 14px rgba(22, 163, 74, 0.15);
  transition: all 0.4s ease;
}

.countdown-box h4 {
  color: #065f46;
  font-weight: 700;
  font-size: 16px;
  margin-bottom: 10px;
}

.countdown-timer {
  font-size: 26px;
  font-weight: 700;
  letter-spacing: 2px;
  color: #16a34a;
  background: #dcfce7;
  padding: 8px 20px;
  border-radius: 10px;
  box-shadow: inset 0 0 5px rgba(22,163,74,0.25);
  transition: all 0.3s ease;
}

.countdown-timer.ready {
  background: #fee2e2;
  color: #dc2626;
  box-shadow: inset 0 0 5px rgba(220,38,38,0.25);
  animation: pulseReady 1.5s infinite;
}

@keyframes pulseReady {
  0%, 100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.08); opacity: 0.8; }
}

</style>
</head>

<body>
<div id="popupAlert" class="popup-alert"></div>

<div class="card">
  <div class="wallet">
    <div><strong>Wallet:</strong> <span id="walletBalance">$0.00</span></div>
    <div><strong>Locked:</strong> <span id="lockedBalance">$0.00</span></div>
  </div>
  <span class="status-badge">üî• Active</span>

  <!-- üíé Active Plan Box -->
  <div id="activePlanBox" style="display:none; margin-top:15px;">
    <div class="plan-summary" style="background:#dcfce7; border:1.5px solid #86efac;">
      <div class="summary-row">
        <span>Active Plan:</span>
        <strong id="activePlanName">‚Äî</strong>
      </div>
      <div class="summary-row">
        <span>Daily Profit:</span>
        <strong id="activePlanProfit">‚Äî</strong>
      </div>
      <div class="summary-row">
        <span>Next Profit In:</span>
        <strong id="activeCountdown">00:00:00</strong>
      </div>
    </div>

    <!-- üïí Stylish Countdown Box -->
    <div class="countdown-box" id="countdownBox" style="display:none;">
      <h4>‚è≥ Next Profit Countdown</h4>
      <div id="countdownTimer" class="countdown-timer">
        <span id="cdHours">24</span>h :
        <span id="cdMinutes">00</span>m :
        <span id="cdSeconds">00</span>s
      </div>
    </div>
  </div>

  <!-- üåÄ Circular Progress Ring -->
  <div class="progress-ring" id="progressRing" style="display:none;">
   <svg class="ring" width="80" height="80">
      <circle class="ring-bg" cx="40" cy="40" r="35"></circle>
      <circle class="ring-fill" cx="40" cy="40" r="35"></circle>
    </svg>
    <div class="ring-time" id="ringTime">24h</div>
  </div>

  <div style="text-align:center; margin-bottom:20px;">
    <button id="collectProfitBtn" class="btn" style="max-width:250px;">Collect Today‚Äôs Profit</button>
  </div>

  <h2 style="color:#16a34a; text-align:center;">üí† Cloud Mining Plans</h2>

  <div class="plans">
    <div class="plan" data-name="Mini Plan" data-cost="500" data-days="30" data-profit="2.1">
      <h3>Mini Plan</h3>
      <p>$500 / 30 days</p>
      <p>2.1% Daily</p>
      <button class="btn buy-btn">Buy</button>
    </div>

    <div class="plan" data-name="Starter Plan" data-cost="1500" data-days="45" data-profit="2.5">
      <h3>Starter Plan</h3>
      <p>$1500 / 45 days</p>
      <p>2.5% Daily</p>
      <button class="btn buy-btn">Buy</button>
    </div>

    <div class="plan" data-name="Advanced Plan" data-cost="3000" data-days="90" data-profit="3">
      <h3>Advanced Plan</h3>
      <p>$3000 / 90 days</p>
      <p>3% Daily</p>
      <button class="btn buy-btn">Buy</button>
    </div>

    <div class="plan" data-name="Premium Plan" data-cost="8000" data-days="160" data-profit="5">
      <h3>Premium Plan</h3>
      <p>$8000 / 160 days</p>
      <p>5% Daily</p>
      <button class="btn buy-btn">Buy</button>
    </div>
  </div>

  <!-- ‚ö° Center Alert Message -->
  <div id="centerAlert" class="center-alert"></div>

  <!-- üíé Centered Modal -->
  <div class="modal" id="planModal">
    <div class="modal-card">
      <div class="modal-head">
        <h2 id="mTitle">BUY PLAN</h2>
        <button class="close-btn" onclick="closeModal()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="plan-summary">
          <div class="summary-row">
            <span> Duration:</span>
            <strong id="mDays">45 days</strong>
          </div>
          <div class="summary-row">
            <span> Daily Profit:</span>
            <strong id="mProfit">2.5%</strong>
          </div>
          <div class="summary-row">
            <span> Plan Cost:</span>
            <strong id="mCost">$500</strong>
          </div>
          <div class="summary-row wallet-info">
            <span> Wallet:</span>
            <strong id="mWallet">$0.00</strong>
          </div>
        </div>

        <!-- ‚ö†Ô∏è Smart Animated Alert -->
        <div id="mError" class="balance-alert">
          <span class="alert-icon">‚ö†Ô∏è</span>
          <span class="alert-text">Insufficient Balance!</span>
        </div>

        <div class="modal-actions">
          <button class="confirm-btn" id="mConfirm">Confirm Purchase</button>
          <button class="cancel-btn" onclick="closeModal()">Cancel</button>
        </div>
      </div>
    </div>
  </div>
</div>
</body>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import {
  getFirestore, doc, getDoc, updateDoc, addDoc,
  collection, serverTimestamp, query, where, getDocs
} from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";

// üî• Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyDEQYPJFxQv8yFHptrTqoLHOn2L0PpgVhc",
  authDomain: "btcinvest-c0e25.firebaseapp.com",
  projectId: "btcinvest-c0e25",
  storageBucket: "btcinvest-c0e25.firebasestorage.app",
  messagingSenderId: "204937458487",
  appId: "1:204937458487:web:cc27ece1249999279f60b2"
};

// üîó Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let walletBalance = 0, lockedBalance = 0;

// üîê Auth state check
onAuthStateChanged(auth, async (user) => {
  if (!user) return (window.location.href = "login.html");

  const ref = doc(db, "users", user.uid);
  const snap = await getDoc(ref);
  if (snap.exists()) {
    const d = snap.data();
    walletBalance = d.walletBalance || 0;
    lockedBalance = d.lockedBalance || 0;
    document.getElementById("walletBalance").textContent = `$${walletBalance.toFixed(2)}`;
    document.getElementById("lockedBalance").textContent = `$${lockedBalance.toFixed(2)}`;
  }

  // üîç Active running plan check
// üîç Fetch all plans (active + completed)
const q = query(collection(db, "buyhashrate"), where("userId", "==", user.uid));
const res = await getDocs(q);

if (!res.empty) {
  const plansContainer = document.getElementById("activePlanBox");
  plansContainer.innerHTML = ""; // Clear old

    // üü¢ Safe hide progress ring & countdown initially
const ringSafe = document.getElementById("progressRing");
const countSafe = document.getElementById("countdownBox");

if (ringSafe) ringSafe.style.display = "none";
if (countSafe) countSafe.style.display = "none";

// Agar abhi tak element load nahi hua, wait karo
if (!ringSafe || !countSafe) {
  window.addEventListener("DOMContentLoaded", () => {
    const r2 = document.getElementById("progressRing");
    const c2 = document.getElementById("countdownBox");
    if (r2) r2.style.display = "none";
    if (c2) c2.style.display = "none";
  });
}



  res.forEach(docSnap => {
    const plan = docSnap.data();
    const planCard = document.createElement("div");
    const next = plan.nextPayout?.toDate ? plan.nextPayout.toDate() : new Date(plan.nextPayout);
    const end = plan.endTime?.toDate ? plan.endTime.toDate() : new Date(plan.endTime);

    // üßæ Card Design
    planCard.className = "plan-summary";
    planCard.style.background = plan.status === "running" ? "#dcfce7" : "#fef2f2";
    planCard.style.border = plan.status === "running" ? "1.5px solid #86efac" : "1.5px solid #fecaca";
    planCard.innerHTML = `
      <div class="summary-row">
        <span>Plan:</span>
        <strong>${plan.planName}</strong>
      </div>
      <div class="summary-row">
        <span>Daily Profit:</span>
        <strong>${plan.dailyProfitPercent}%</strong>
      </div>
      <div class="summary-row">
        <span>Status:</span>
        <strong style="color:${plan.status === "running" ? "#16a34a" : "#dc2626"}">
          ${plan.status.charAt(0).toUpperCase() + plan.status.slice(1)}
        </strong>
      </div>
      <div class="summary-row">
        <span>End Date:</span>
        <strong>${end.toLocaleDateString()}</strong>
      </div>
    `;

    plansContainer.appendChild(planCard);

    // üîÑ Disable button for running plan only
    disableSpecificPlan(plan.planName, plan.status === "running");


    // ‚è∞ Countdown start for active plan
if (plan.status === "running") {
  checkAndAddProfit(docSnap.ref, plan, user.uid);

  const ringEl = document.getElementById("progressRing");
  const countEl = document.getElementById("countdownBox");
  if (ringEl) ringEl.style.display = "block";
  if (countEl) countEl.style.display = "flex";

  let nextTime;
  if (plan.nextPayout?.toDate) {
    nextTime = plan.nextPayout.toDate();
  } else if (typeof plan.nextPayout === "string" || typeof plan.nextPayout === "number") {
    nextTime = new Date(plan.nextPayout);
  } else {
    nextTime = new Date();
  }

  startCountdown(nextTime);
}


  });

  // Make sure Active Plan box visible
  plansContainer.style.display = "block";
}


});

// üéØ Auto Bind Buttons (No manual onclick)
document.querySelectorAll(".buy-btn").forEach(btn => {
  btn.addEventListener("click", (e) => {
    const planDiv = e.target.closest(".plan");
    const name = planDiv.dataset.name;
    const cost = parseFloat(planDiv.dataset.cost);
    const days = parseInt(planDiv.dataset.days);
    const profit = parseFloat(planDiv.dataset.profit);
    openModal(name, cost, days, profit);
  });
});

// üü¢ OPEN MODAL ‚Äî smooth fade-in
window.openModal = function (name, cost, days, profit) {
  const modal = document.getElementById("planModal");
  document.getElementById("mTitle").textContent = `BUY ${name.toUpperCase()}`;
  document.getElementById("mDays").textContent = `${days} days`;
  document.getElementById("mProfit").textContent = `${profit}%`;
  document.getElementById("mCost").textContent = `$${cost}`;
  document.getElementById("mWallet").textContent = `$${walletBalance.toFixed(2)}`;
  document.getElementById("mError").style.display = "none";

  modal.style.display = "flex";
  modal.style.opacity = "0";
  requestAnimationFrame(() => {
    modal.classList.add("show");
    modal.style.opacity = "1";
  });

  // ‚úÖ Confirm button click
  document.getElementById("mConfirm").onclick = async () => {
    // üí∞ Check balance
    if (walletBalance < cost) {
      document.getElementById("mError").style.display = "flex";
      showBalanceAlert();
      return; // ‚úÖ stop if insufficient balance
    }

    const user = auth.currentUser;
    if (!user) return showCenterAlert(" Please login first!");

  // üö´ Check if user already has an active running plan
  const activeQuery = query(
    collection(db, "buyhashrate"),
    where("userId", "==", user.uid),
    where("status", "==", "running")
  );
  const activeSnap = await getDocs(activeQuery);
  if (!activeSnap.empty) {
    showCenterAlert("Your plan is running, please wait until it‚Äôs closed!");
    closeModal();
    return; // stop purchase
  }


    const now = new Date();
    const next = new Date(now.getTime() + 86400000);
    const end = new Date(now.getTime() + days * 86400000);

    try {
      // üßæ Save plan
      await addDoc(collection(db, "buyhashrate"), {
        userId: user.uid,
        planName: name,
        planCost: cost,
        dailyProfitPercent: profit,
        durationDays: days,
        startTime: serverTimestamp(),
        nextPayout: next,
        endTime: end,
        earnedProfit: 0,
        status: "running",
      });

      // üíµ Update wallet
      walletBalance -= cost;
      lockedBalance += cost;
      await updateDoc(doc(db, "users", user.uid), { walletBalance, lockedBalance });

      // üß© Update UI
      closeModal();
      showActivePlan({
        planName: name,
        dailyProfitPercent: profit,
        earnedProfit: 0,
        nextPayout: next,
        endTime: end,
      });
         
        console.log("‚è∞ Next profit countdown starting...", next);
        startCountdown(next);

      startCountdown(next);
      document.getElementById("walletBalance").textContent = `$${walletBalance.toFixed(2)}`;
      document.getElementById("lockedBalance").textContent = `$${lockedBalance.toFixed(2)}`;
      showCenterAlert(`‚úÖ ${name} purchased successfully!`);

    } catch (err) {
      console.error(err);
      showCenterAlert(" Something went wrong!");

    }
  };
};

// üî¥ CLOSE MODAL
window.closeModal = function () {
  const modal = document.getElementById("planModal");
  modal.classList.remove("show");
  modal.style.opacity = "0";
  setTimeout(() => (modal.style.display = "none"), 300);
};

// üßæ Active Plan Display
function showActivePlan(plan) {
  
  // üü¢ Active plan info box show karo
  const box = document.getElementById("activePlanBox");
  if (!box) return; // agar box nahi bana to skip
  box.style.display = "block";

  // üßæ Set values
  document.getElementById("activePlanName").textContent = plan.planName;
  document.getElementById("activePlanProfit").textContent = plan.dailyProfitPercent + "%";

  // ‚è∞ Countdown start
  const nextTime = plan.nextPayout.toDate ? plan.nextPayout.toDate() : new Date(plan.nextPayout);
  startCountdown(nextTime);
}

// üí∞ Profit Calculation
async function checkAndAddProfit(ref, plan, uid) {
  const now = new Date();
  const next = plan.nextPayout.toDate ? plan.nextPayout.toDate() : new Date(plan.nextPayout);
  const end = plan.endTime.toDate ? plan.endTime.toDate() : new Date(plan.endTime);
  if (now >= next && now <= end) {
    const profit = (plan.planCost * plan.dailyProfitPercent) / 100;
    const newProfit = (plan.earnedProfit || 0) + profit;
    const newNext = new Date(now.getTime() + 86400000);
    await updateDoc(ref, { earnedProfit: newProfit, nextPayout: newNext });
    document.getElementById("earnedProfit").textContent = newProfit.toFixed(2);
  }
  if (now > end) {
  const uRef = doc(db, "users", uid);
  const userSnap = await getDoc(uRef);
  if (userSnap.exists()) {
    const u = userSnap.data();
    const newWallet = (u.walletBalance || 0) + plan.planCost + (plan.earnedProfit || 0);
    const newLocked = (u.lockedBalance || 0) - plan.planCost;

    await updateDoc(uRef, { walletBalance: newWallet, lockedBalance: newLocked });
    await updateDoc(ref, { status: "completed" });

    // üí° Enable that specific plan again
    disableSpecificPlan(plan.planName, false);

    showCenterAlert("üéâ Plan completed! Funds released to wallet!");
  }
}

}

// üí∏ Manual Profit Collect
document.getElementById("collectProfitBtn").addEventListener("click", async () => {
  const user = auth.currentUser;
  if (!user) return showCenterAlert("üö´ Please login first!");

  // üîç Check active plan
  const q = query(
    collection(db, "buyhashrate"),
    where("userId", "==", user.uid),
    where("status", "==", "running")
  );

  const res = await getDocs(q);
  if (res.empty) return showCenterAlert("üö´ No active plan found.");

  const docRef = res.docs[0].ref;
  const plan = res.docs[0].data();
  const now = new Date();
  const next = plan.nextPayout.toDate ? plan.nextPayout.toDate() : new Date(plan.nextPayout);

  // ‚è≥ If not yet time
  if (now < next) {
    const remaining = Math.ceil((next - now) / (1000 * 60 * 60));
    return showCenterAlert(`‚è≥ You can collect profit after ${remaining} hours.`);
  }

  // üí∞ Calculate daily profit
  const dailyProfit = (plan.planCost * plan.dailyProfitPercent) / 100;
  const newProfit = (plan.earnedProfit || 0) + dailyProfit;
  const newNext = new Date(now.getTime() + 86400000);

  // üïí Update next payout & earned profit
  await updateDoc(docRef, { earnedProfit: newProfit, nextPayout: newNext });

  // üí∏ Split profit: 70% user, 30% uplines
  const userShare = dailyProfit * 0.7;
  const uplineShare = dailyProfit * 0.3;

  // üë§ Get user document
  const userRef = doc(db, "users", user.uid);
  const userSnap = await getDoc(userRef);
  const userData = userSnap.data();

  // üßæ Update user's wallet (only 70%)
  const updatedWallet = (userData.walletBalance || 0) + userShare;
  await updateDoc(userRef, { walletBalance: updatedWallet });

  // üß© Distribute 30% to uplines
  await distributeLevelIncome(userData, uplineShare);

  // üß† Update UI
  document.getElementById("earnedProfit").textContent = newProfit.toFixed(2);
  document.getElementById("walletBalance").textContent = `$${updatedWallet.toFixed(2)}`;

  // ‚úÖ Success alert
  showCenterAlert(`‚úÖ $${userShare.toFixed(2)} profit added to your wallet! (30% shared with uplines)`);
});

// üßÆ Level 3 Income Distribution (30% of user profit)
async function distributeLevelIncome(userData, totalShare) {
  try {
    const levelPercents = [17, 8, 5]; // 30% total
    const uplines = [userData.upline1, userData.upline2, userData.upline3];

    for (let i = 0; i < uplines.length; i++) {
      const uplineId = uplines[i];
      if (!uplineId) continue;

      const refRef = doc(db, "users", uplineId);
      const refSnap = await getDoc(refRef);
      if (!refSnap.exists()) continue;

      const refData = refSnap.data();
      const commission = (totalShare * levelPercents[i]) / 30;

      // üî• Update all balances
      const newWallet = (refData.walletBalance || 0) + commission;
      const newReferralLifetime = (refData.lifetimeReferralIncome || 0) + commission;

      await updateDoc(refRef, {
        walletBalance: newWallet,
        lifetimeReferralIncome: newReferralLifetime,
      });

      // üíæ Record in history
      await addDoc(collection(db, "levelIncomeHistory"), {
        referrerId: uplineId,
        fromUser: userData.username || userData.name || "Unknown",
        level: i + 1,
        amount: commission,
        createdAt: serverTimestamp(),
      });
    }
  } catch (err) {
    console.error("Level income distribution error:", err);
  }
}


   // ‚è≥ Countdown
// ‚úÖ FINAL LIVE COUNTDOWN (TRUSTDOLLAR FIXED VERSION)
function startCountdown(nextTime) {
  const countdownBox = document.getElementById("countdownBox");
  const timerEl = document.getElementById("countdownTimer");
  const ring = document.querySelector(".ring-fill");
  const ringTime = document.getElementById("ringTime");
  const label = document.getElementById("activeCountdown");

  if (!countdownBox || !timerEl || !ring) return;

  countdownBox.style.display = "flex";
  document.getElementById("progressRing").style.display = "block";

  // üïí Ensure nextTime is valid Date object
  let target;
  if (nextTime?.seconds) {
    target = new Date(nextTime.seconds * 1000);
  } else if (nextTime?.toDate) {
    target = nextTime.toDate();
  } else {
    target = new Date(nextTime);
  }

  // üß† If somehow invalid or already passed, reset 24h timer
  if (isNaN(target.getTime()) || target.getTime() <= Date.now()) {
    target = new Date(Date.now() + 86400000);
  }

  console.log("üïí Countdown started for:", target.toLocaleString()); // debug log

  const totalMs = 24 * 60 * 60 * 1000;
  if (window.activeCountdownTimer) clearInterval(window.activeCountdownTimer);

  window.activeCountdownTimer = setInterval(() => {
    const now = new Date().getTime();
    const remaining = target - now;

    // üü• When time is up
    if (remaining <= 0) {
      clearInterval(window.activeCountdownTimer);
      label.textContent = "Ready to Collect Profit";
      label.style.color = "#dc2626";

      timerEl.textContent = "READY";
      timerEl.classList.add("ready");
      ring.style.strokeDashoffset = 0;
      ringTime.textContent = "‚úî";
      console.log("‚úÖ Countdown complete!");
      return;
    }

    // ‚è± Convert remaining time to h:m:s
    const hours = Math.floor((remaining / (1000 * 60 * 60)) % 24);
    const minutes = Math.floor((remaining / (1000 * 60)) % 60);
    const seconds = Math.floor((remaining / 1000) % 60);

    const formatted = `${hours.toString().padStart(2, "0")}:${minutes
      .toString()
      .padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;

    label.textContent = formatted;
    timerEl.textContent = formatted;

    // üåÄ Animate progress ring
    const progress = 1 - remaining / totalMs;
    const offset = 220 - 220 * progress;
    ring.style.strokeDashoffset = offset;
    ringTime.textContent = `${hours}h`;

    // debug
    // console.log("‚è≥ Remaining:", remaining);
  }, 1000);
}



// üí¨ Popup Alerts
function showPopup(message, type = "success") {
  const popup = document.getElementById("popupAlert");
  popup.textContent = message;
  popup.className = "popup-alert " + (type === "error" ? "error" : "");
  popup.classList.add("show");
  setTimeout(() => popup.classList.remove("show"), 3000);
}

// ‚ö° Center Screen Alert
function showCenterAlert(message, duration = 3000) {
  const alertBox = document.getElementById("centerAlert");
  alertBox.textContent = message;
  alertBox.classList.add("show");
  setTimeout(() => {
    alertBox.style.animation = "fadeOut 0.5s forwards";
    setTimeout(() => {
      alertBox.classList.remove("show");
      alertBox.style.animation = "";
    }, 500);
  }, duration);
}

// ‚ö†Ô∏è Smart Balance Alert Animation
function showBalanceAlert() {
  const alertBox = document.getElementById("mError");
  alertBox.classList.add("show");
  setTimeout(() => {
    alertBox.classList.remove("show");
    setTimeout(() => (alertBox.style.display = "none"), 300);
  }, 3000);
}
// desble butun for palne kharrrdne ke bad 
function disableSpecificPlan(planName, state) {
  const plans = document.querySelectorAll(".plan");
  plans.forEach(p => {
    const name = p.dataset.name;
    const btn = p.querySelector(".buy-btn");
    if (name === planName) {
      btn.disabled = state;
      btn.style.opacity = state ? "0.5" : "1";
      btn.style.cursor = state ? "not-allowed" : "pointer";
      if (state) {
        btn.textContent = "Active Plan";
      } else {
        btn.textContent = "Buy";
      }
    }
  });
}

</script>

</body>
</html>
