<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TrustDollar ‚Äî Cloud Mining</title>

<style>
:root {
  --green: #16a34a;
  --bg: #f8fafc;
  --text-dark: #0f172a;
}
body {
  font-family: "Poppins", sans-serif;
  background: var(--bg);
  color: var(--text-dark);
  padding: 20px;
  display: flex;
  justify-content: center;
}
.card {
  background: #fff;
  padding: 25px;
  border-radius: 20px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.1);
  width: 100%;
  max-width: 850px;
  transition: all 0.3s ease;
}
.wallet {
  display: flex;
  justify-content: space-between;
  background: #f0fdf4;
  border: 1px solid #bbf7d0;
  border-radius: 12px;
  padding: 12px 18px;
  margin-bottom: 20px;
  font-weight: 600;
  color: #14532d;
}
.plans {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 16px;
  margin-top: 25px;
}
.plan {
  background: #ffffff;
  border: 1.5px solid #e5e7eb;
  border-radius: 14px;
  text-align: center;
  padding: 18px;
  box-shadow: 0 3px 12px rgba(0,0,0,0.05);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.plan:hover {
  transform: translateY(-6px);
  box-shadow: 0 6px 18px rgba(22,163,74,0.2);
}
.plan h3 {
  color: var(--green);
  margin-bottom: 8px;
  font-weight: 700;
}
.plan p {
  font-size: 14px;
  color: #475569;
  margin: 5px 0;
}
.btn {
  background: linear-gradient(135deg,#16a34a,#22c55e);
  color: #fff;
  padding: 12px;
  border: none;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
  width: 100%;
  margin-top: 12px;
  transition: all 0.2s ease;
}
.btn:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(22,163,74,0.3);
}
.profit-box {
  background: #ecfdf5;
  border: 1px solid #bbf7d0;
  border-radius: 12px;
  padding: 14px;
  margin: 16px 0;
  font-size: 15px;
  color: #166534;
  line-height: 1.6;
}

/* ‚úÖ Modal Overlay */
/* ‚úÖ Smooth Modal (no flicker, with fade + zoom animation) */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.55);
  backdrop-filter: blur(10px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 5000;
  opacity: 0;
  transition: opacity 0.35s ease-in-out;
}

/* Show state ‚Äî smooth fade in */
.modal.show {
  display: flex;
  opacity: 1;
}

/* ‚úÖ Centered Card with Depth */
.modal-card {
  width: 90%;
  max-width: 420px;
  border-radius: 18px;
  overflow: hidden;
  background: #fff;
  box-shadow: 0 12px 50px rgba(0, 0, 0, 0.3);
  transform: scale(0.9) translateY(20px);
  opacity: 0;
  transition: all 0.35s ease-in-out;
}

/* When modal is visible ‚Äî card smoothly expands and fades in */
.modal.show .modal-card {
  transform: scale(1) translateY(0);
  opacity: 1;
}

/* Header */
.modal-head {
  background: linear-gradient(135deg, #16a34a, #22c55e);
  color: #fff;
  padding: 18px;
  text-align: center;
  position: relative;
  font-weight: 700;
  letter-spacing: 0.5px;
}
.modal-head h2 {
  margin: 0;
  font-size: 1.3rem;
}
.close-btn {
  position: absolute;
  top: 12px;
  right: 16px;
  border: none;
  background: none;
  font-size: 24px;
  color: #fff;
  cursor: pointer;
  opacity: 0.9;
  transition: 0.2s;
}
.close-btn:hover {
  opacity: 1;
  transform: scale(1.2);
}

/* Body */
.modal-body {
  background: #fff;
  padding: 22px;
  text-align: center;
}
.modal-body p {
  margin: 8px 0;
  color: #475569;
  font-size: 15px;
}
.wallet-line {
  margin-top: 10px;
  font-weight: 600;
  color: #0f172a;
}
.modal-error {
  display: none;
  color: #dc2626;
  font-weight: 600;
  margin: 8px 0;
}

/* Buttons */
.modal-actions {
  display: flex;
  gap: 10px;
  margin-top: 18px;
}
.confirm-btn {
  flex: 1;
  background: linear-gradient(135deg, #16a34a, #22c55e);
  color: #fff;
  border: none;
  border-radius: 10px;
  padding: 12px;
  font-weight: 600;
  font-size: 15px;
  cursor: pointer;
  transition: all 0.2s ease;
}
.confirm-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 0 14px rgba(22, 163, 74, 0.4);
}
.cancel-btn {
  flex: 1;
  background: #f1f5f9;
  color: #0f172a;
  border: none;
  border-radius: 10px;
  padding: 12px;
  font-weight: 600;
  font-size: 15px;
  cursor: pointer;
  transition: 0.2s;
}
.cancel-btn:hover {
  background: #e2e8f0;
}

/* ‚úÖ Responsive Fix */
@media (max-width: 480px) {
  .card { padding: 16px; }
  .plan { padding: 14px; }
  .modal-body { padding: 18px; }
}
/* allert sms pop up ke liye */
.center-alert {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.9);
  background: rgba(22, 163, 74, 0.95);
  color: #fff;
  padding: 14px 28px;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 600;
  text-align: center;
  box-shadow: 0 10px 30px rgba(22, 163, 74, 0.4);
  opacity: 0;
  z-index: 9999;
  transition: all 0.4s ease;
  pointer-events: none;
}
.center-alert.show {
  opacity: 1;
  transform: translate(-50%, -50%) scale(1);
}
@keyframes fadeOut {
  from { opacity: 1; transform: translate(-50%, -50%) scale(1); }
  to { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
}


/* üíé Plan Summary Box */
.plan-summary {
  border: 1.5px solid #d1fae5;
  background: #f0fdf4;
  border-radius: 12px;
  padding: 16px 18px;
  margin-bottom: 16px;
  box-shadow: 0 2px 8px rgba(22, 163, 74, 0.1);
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.summary-row {
  display: flex;
  justify-content: space-between;
  font-size: 15px;
  color: #064e3b;
  font-weight: 500;
  border-bottom: 1px dashed #bbf7d0;
  padding-bottom: 6px;
}

.summary-row:last-child {
  border-bottom: none;
}

.summary-row strong {
  color: #065f46;
  font-weight: 600;
}

.wallet-info {
  background: #dcfce7;
  border-radius: 8px;
  padding: 6px 10px;
  box-shadow: inset 0 0 5px rgba(22,163,74,0.15);
}

/* ‚ö†Ô∏è Animated Pro Alert */
.balance-alert {
  display: none;
  align-items: center;
  justify-content: center;
  gap: 8px;
  background: linear-gradient(90deg, #fef3c7, #fde68a);
  border: 1.5px solid #facc15;
  color: #92400e;
  font-weight: 600;
  padding: 10px 16px;
  border-radius: 12px;
  margin-top: 12px;
  font-size: 15px;
  box-shadow: 0 4px 14px rgba(250, 204, 21, 0.35);
  opacity: 0;
  transform: translateY(10px);
  transition: all 0.4s ease-in-out;
}

.balance-alert.show {
  display: flex;
  opacity: 1;
  transform: translateY(0);
}

.alert-icon {
  font-size: 18px;
  animation: pulseIcon 1.2s infinite;
}

@keyframes pulseIcon {
  0%, 100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.2); opacity: 0.7; }
}


</style>
</head>

<body>
<div id="popupAlert" class="popup-alert"></div>

<div class="card">
  <div class="wallet">
    <div><strong>Wallet:</strong> <span id="walletBalance">$0.00</span></div>
    <div><strong>Locked:</strong> <span id="lockedBalance">$0.00</span></div>
  </div>

  <div style="text-align:center; margin-bottom:20px;">
    <button id="collectProfitBtn" class="btn" style="max-width:250px;">Collect Today‚Äôs Profit</button>
  </div>

  <h2 style="color:#16a34a; text-align:center;">üí† Cloud Mining Plans</h2>

  <div class="plans">
    <div class="plan">
      <h3>Starter Plan</h3>
      <p>$500 / 45 days</p>
      <p>2.5% Daily</p>
      <button class="btn" onclick="openModal('Starter Plan',500,45,2.5)">Buy</button>
    </div>

    <div class="plan">
      <h3>Advanced Plan</h3>
      <p>$1500 / 90 days</p>
      <p>5% Daily</p>
      <button class="btn" onclick="openModal('Advanced Plan',1500,90,5)">Buy</button>
    </div>

    <div class="plan">
      <h3>Premium Plan</h3>
      <p>$2000 / 160 days</p>
      <p>10% Daily</p>
      <button class="btn" onclick="openModal('Premium Plan',2000,160,10)">Buy</button>
    </div>
  </div>
</div>
<!-- ‚ö° Center Alert Message -->
<div id="centerAlert" class="center-alert"></div>


<!-- üíé Centered Modal -->
<div class="modal" id="planModal">
  <div class="modal-card">
    <div class="modal-head">
      <h2 id="mTitle">BUY PLAN</h2>
      <button class="close-btn" onclick="closeModal()">√ó</button>
    </div>
  <div class="modal-body">
  <div class="plan-summary">
    <div class="summary-row">
      <span> Duration:</span>
      <strong id="mDays">45 days</strong>
    </div>
    <div class="summary-row">
      <span> Daily Profit:</span>
      <strong id="mProfit">2.5%</strong>
    </div>
    <div class="summary-row">
      <span> Plan Cost:</span>
      <strong id="mCost">$500</strong>
    </div>
    <div class="summary-row wallet-info">
      <span> Wallet:</span>
      <strong id="mWallet">$0.00</strong>
    </div>
  </div>

  <!-- ‚ö†Ô∏è Smart Animated Alert -->
<div id="mError" class="balance-alert">
  <span class="alert-icon">‚ö†Ô∏è</span>
  <span class="alert-text">Insufficient Balance!</span>
</div>

  <div class="modal-actions">
    <button class="confirm-btn" id="mConfirm">Confirm Purchase</button>
    <button class="cancel-btn" onclick="closeModal()">Cancel</button>
  </div>
</div>

  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
import {
  getFirestore, doc, getDoc, updateDoc, addDoc,
  collection, serverTimestamp, query, where, getDocs
} from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";

// üî• Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyDEQYPJFxQv8yFHptrTqoLHOn2L0PpgVhc",
  authDomain: "btcinvest-c0e25.firebaseapp.com",
  projectId: "btcinvest-c0e25",
  storageBucket: "btcinvest-c0e25.firebasestorage.app",
  messagingSenderId: "204937458487",
  appId: "1:204937458487:web:cc27ece1249999279f60b2"
};

// üîó Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let walletBalance = 0, lockedBalance = 0;

// üîê Auth state check
onAuthStateChanged(auth, async (user) => {
  if (!user) return (window.location.href = "login.html");

  const ref = doc(db, "users", user.uid);
  const snap = await getDoc(ref);
  if (snap.exists()) {
    const d = snap.data();
    walletBalance = d.walletBalance || 0;
    lockedBalance = d.lockedBalance || 0;
    document.getElementById("walletBalance").textContent = `$${walletBalance.toFixed(2)}`;
    document.getElementById("lockedBalance").textContent = `$${lockedBalance.toFixed(2)}`;
  }

  // üîç Active running plan check
  const q = query(collection(db, "buyhashrate"),
    where("userId", "==", user.uid),
    where("status", "==", "running")
  );
  const res = await getDocs(q);
  if (!res.empty) {
    const plan = res.docs[0].data();
    checkAndAddProfit(res.docs[0].ref, plan, user.uid);
    showActivePlan(plan);
    const nextTime = plan.nextPayout?.toDate ? plan.nextPayout.toDate() : new Date(plan.nextPayout);
    startCountdown(nextTime);
  }
});

// üü¢ OPEN MODAL ‚Äî smooth fade-in
window.openModal = function (name, cost, days, profit) {
  const modal = document.getElementById("planModal");
  document.getElementById("mTitle").textContent = `BUY ${name.toUpperCase()}`;
  document.getElementById("mDays").textContent = `${days} days`;
  document.getElementById("mProfit").textContent = `${profit}%`;
  document.getElementById("mCost").textContent = `$${cost}`;
  document.getElementById("mWallet").textContent = `$${walletBalance.toFixed(2)}`;
  document.getElementById("mError").style.display = "none";

  modal.style.display = "flex";
  modal.style.opacity = "0";
  requestAnimationFrame(() => {
    modal.classList.add("show");
    modal.style.opacity = "1";
  });

  // ‚úÖ Confirm button click
  document.getElementById("mConfirm").onclick = async () => {
    // üí∞ Check balance
    if (walletBalance < cost) {
      document.getElementById("mError").style.display = "flex";
      showBalanceAlert();
      return; // ‚úÖ stop if insufficient balance
    }

    const user = auth.currentUser;
    if (!user) return showPopup("Please login first.", "error");

    const now = new Date();
    const next = new Date(now.getTime() + 86400000);
    const end = new Date(now.getTime() + days * 86400000);

    try {
      // üßæ Save plan
      await addDoc(collection(db, "buyhashrate"), {
        userId: user.uid,
        planName: name,
        planCost: cost,
        dailyProfitPercent: profit,
        durationDays: days,
        startTime: serverTimestamp(),
        nextPayout: next,
        endTime: end,
        earnedProfit: 0,
        status: "running",
      });

      // üíµ Update wallet
      walletBalance -= cost;
      lockedBalance += cost;
      await updateDoc(doc(db, "users", user.uid), { walletBalance, lockedBalance });

      // üß© Update UI
      closeModal();
      showActivePlan({
        planName: name,
        dailyProfitPercent: profit,
        earnedProfit: 0,
        nextPayout: next,
        endTime: end,
      });

      startCountdown(next);
      document.getElementById("walletBalance").textContent = `$${walletBalance.toFixed(2)}`;
      document.getElementById("lockedBalance").textContent = `$${lockedBalance.toFixed(2)}`;
      showPopup(`‚úÖ ${name} purchased successfully!`);
    } catch (err) {
      console.error(err);
      showPopup("‚ùå Something went wrong.", "error");
    }
  };
};

// üî¥ CLOSE MODAL
window.closeModal = function () {
  const modal = document.getElementById("planModal");
  modal.classList.remove("show");
  modal.style.opacity = "0";
  setTimeout(() => (modal.style.display = "none"), 300);
};

// üßæ Active Plan Display
function showActivePlan(plan) {
  const section = document.getElementById("activeMining");
  if (section) section.style.display = "block";
  if (document.getElementById("planName")) document.getElementById("planName").textContent = plan.planName;
  if (document.getElementById("dailyPercent")) document.getElementById("dailyPercent").textContent = plan.dailyProfitPercent;
  if (document.getElementById("earnedProfit")) document.getElementById("earnedProfit").textContent = plan.earnedProfit.toFixed(2);
  startCountdown(new Date(plan.nextPayout));
}

// üí∞ Profit Calculation
async function checkAndAddProfit(ref, plan, uid) {
  const now = new Date();
  const next = plan.nextPayout.toDate ? plan.nextPayout.toDate() : new Date(plan.nextPayout);
  const end = plan.endTime.toDate ? plan.endTime.toDate() : new Date(plan.endTime);
  if (now >= next && now <= end) {
    const profit = (plan.planCost * plan.dailyProfitPercent) / 100;
    const newProfit = (plan.earnedProfit || 0) + profit;
    const newNext = new Date(now.getTime() + 86400000);
    await updateDoc(ref, { earnedProfit: newProfit, nextPayout: newNext });
    document.getElementById("earnedProfit").textContent = newProfit.toFixed(2);
  }
  if (now > end) {
    const uRef = doc(db, "users", uid);
    const userSnap = await getDoc(uRef);
    if (userSnap.exists()) {
      const u = userSnap.data();
      const newWallet = (u.walletBalance || 0) + plan.planCost + (plan.earnedProfit || 0);
      const newLocked = (u.lockedBalance || 0) - plan.planCost;
      await updateDoc(uRef, { walletBalance: newWallet, lockedBalance: newLocked });
      await updateDoc(ref, { status: "completed" });
      showPopup("üéâ Plan completed! Funds released to wallet.");
    }
  }
}

// üí∏ Manual Profit Collect
document.getElementById("collectProfitBtn").addEventListener("click", async () => {
  const user = auth.currentUser;
  if (!user) return showPopup("Please login first.", "error");

  const q = query(collection(db, "buyhashrate"),
    where("userId", "==", user.uid),
    where("status", "==", "running")
  );
  const res = await getDocs(q);
  if (res.empty) return showCenterAlert("üö´ No active plan found.");

  const docRef = res.docs[0].ref;
  const plan = res.docs[0].data();
  const now = new Date();
  const next = plan.nextPayout.toDate ? plan.nextPayout.toDate() : new Date(plan.nextPayout);

  if (now < next) {
    const remaining = Math.ceil((next - now) / (1000 * 60 * 60));
    return showPopup(`‚è≥ You can collect profit after ${remaining} hours.`);
  }

  const dailyProfit = (plan.planCost * plan.dailyProfitPercent) / 100;
  const newProfit = (plan.earnedProfit || 0) + dailyProfit;
  const newNext = new Date(now.getTime() + 86400000);

  await updateDoc(docRef, { earnedProfit: newProfit, nextPayout: newNext });

  const userRef = doc(db, "users", user.uid);
  const userSnap = await getDoc(userRef);
  const userData = userSnap.data();
  const updatedWallet = (userData.walletBalance || 0) + dailyProfit;
  await updateDoc(userRef, { walletBalance: updatedWallet });

  await distributeLevelIncome(user.uid, dailyProfit);

  document.getElementById("earnedProfit").textContent = newProfit.toFixed(2);
  document.getElementById("walletBalance").textContent = `$${updatedWallet.toFixed(2)}`;
  showPopup(`‚úÖ $${dailyProfit.toFixed(2)} profit added to your wallet!`);
});

// ‚è≥ Countdown
function startCountdown(nextTime) {
  const totalTime = 24 * 60 * 60 * 1000;
  const timer = setInterval(() => {
    const now = new Date().getTime();
    const dist = nextTime - now;
    if (dist <= 0) {
      clearInterval(timer);
      return;
    }
  }, 1000);
}

// üí¨ Popup Alerts
function showPopup(message, type = "success") {
  const popup = document.getElementById("popupAlert");
  popup.textContent = message;
  popup.className = "popup-alert " + (type === "error" ? "error" : "");
  popup.classList.add("show");
  setTimeout(() => popup.classList.remove("show"), 3000);
}

// ‚ö° Center Screen Alert
function showCenterAlert(message, duration = 3000) {
  const alertBox = document.getElementById("centerAlert");
  alertBox.textContent = message;
  alertBox.classList.add("show");
  setTimeout(() => {
    alertBox.style.animation = "fadeOut 0.5s forwards";
    setTimeout(() => {
      alertBox.classList.remove("show");
      alertBox.style.animation = "";
    }, 500);
  }, duration);
}

// ‚ö†Ô∏è Smart Balance Alert Animation
function showBalanceAlert() {
  const alertBox = document.getElementById("mError");
  alertBox.classList.add("show");
  setTimeout(() => {
    alertBox.classList.remove("show");
    setTimeout(() => (alertBox.style.display = "none"), 300);
  }, 3000);
}
</script>

</body>
</html>

