<meta 
  name="viewport" 
  content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<link href="https://cdn.jsdelivr.net/npm/remixicon@4.1.0/fonts/remixicon.css" rel="stylesheet">


<div class="team-page">

<div class="team-header">
  <button class="back-btn" onclick="history.back()">
    <i class="ri-arrow-left-line"></i>
  </button>

  <span class="team-title">My Team</span>
</div>


<div class="team-sticky">
  <div class="team-filters">
   <button onclick="filterLevel('all', this)" class="active">All</button>
<button onclick="filterLevel(1, this)">Level 1</button>
<button onclick="filterLevel(2, this)">Level 2</button>
<button onclick="filterLevel(3, this)">Level 3</button>
  </div>

<div class="sticky-actions">
  <button id="refreshTeam" class="refresh-btn">üîÑ</button>

  <div class="team-search">
    <input
      type="text"
      id="teamSearch"
      placeholder="Search by name‚Ä¶"
      autocomplete="off"
    />
  </div>

  <!-- ‚úÖ COUNT -->
  <div class="team-count" id="teamCount">0</div>
</div>

</div>


<div id="teamList" class="team-list">
  <p style="padding:16px; text-align:center; color:#64748b;">
    Loading‚Ä¶ please wait
  </p>
</div>

</div>

<div id="videoLoader" class="video-loader hidden">
<video id="loaderVideo" preload="auto" muted playsinline>
    <source src="Promotion/WhatsApp Video 2025-12-23 at 5.11.03 PM.mp4" type="video/mp4">
  </video>
</div>

</div>

<style>
/* ================= BASE ================= */
html,body{
  margin:0;
  overflow-x:hidden;
  font-family:Inter,system-ui,sans-serif;
  background:#f5f7fb;
}

.team-page{
  max-width:420px;
  margin:0 auto;
  padding:0 12px;
}

/* ================= HEADER ================= */
.team-header{
  position:sticky;
  top:0;
  z-index:100;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:10px 12px;
  background:#f5f7fb;
}

.back-btn{
  border:none;
  background:transparent;
  font-size:20px;
  color:#0f172a;
  cursor:pointer;
}

.team-title{
  font-size:16px;
  font-weight:600;
  color:#0f172a;
}

/* ================= STICKY FILTER BAR ================= */
.team-sticky{
  position:sticky;
  top:52px; /* header height */
  z-index:90;
  background:#f5f7fb;
  padding-bottom:8px;
}

/* ================= FILTER BUTTONS ================= */
.team-filters{
  display:flex;
  gap:8px;
  margin-bottom:10px;
}

.team-filters button{
  flex:1;
  padding:6px;
  font-size:12px;
  border:none;
  border-radius:6px;
  background:#e5e7eb;
  cursor:pointer;
}

.team-filters button.active{
  background:#16a34a;
  color:#fff;
}

/* ================= SEARCH + REFRESH + COUNT ================= */
.sticky-actions{
  display:flex;
  align-items:center;
  gap:10px;
}

.refresh-btn{
  width:40px;
  height:40px;
  display:flex;
  align-items:center;
  justify-content:center;
  border:none;
  background:#16a34a;
  color:#fff;
  border-radius:5px;
  font-size:18px;
  cursor:pointer;
  flex-shrink:0;
}

.team-search{
  flex:1;
}

.team-search input{
  width:100%;
  height:40px;
  padding:0 12px;
  font-size:14px;
  border:1px solid #e5e7eb;
  border-radius:5px;
  outline:none;
}

.team-count{
  min-width:42px;
  height:40px;
  padding:0 10px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:14px;
  font-weight:600;
  background:#e5e7eb;
  color:#0f172a;
  border-radius:5px;
}

/* ================= LIST ================= */
.team-list{
  padding-top:10px;
}

.team-card{
  background:#fff;
  border-radius:10px;
  padding:10px;
  margin-bottom:10px;
  box-shadow:0 4px 12px rgba(0,0,0,.05);
  font-size:13px;
}

.team-row{
  display:flex;
  justify-content:space-between;
  margin:4px 0;
}

/* ================= BADGES ================= */
.badge{
  font-size:11px;
  padding:2px 6px;
  border-radius:4px;
}

.badge.active{
  background:#dcfce7;
  color:#166534;
}

.badge.inactive{
  background:#fee2e2;
  color:#991b1b;
}

/* ================= EMPTY STATE ================= */
.empty-state{
  text-align:center;
  padding:32px 16px;
  color:#475569;
}

.empty-state img{
  width:160px;
  max-width:75%;
  margin-bottom:18px;
}

.empty-state h3{
  font-size:16px;
  font-weight:600;
  margin-bottom:6px;
  color:#0f172a;
}

.empty-state p{
  font-size:13px;
  line-height:1.6;
  color:#64748b;
}

/* ================= INVITE BUTTON ================= */
.invite-btn{
  margin-top:20px;
  width:100%;
  padding:14px 22px;

  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;

  font-size:15px;
  font-weight:600;
  border:none;
  border-radius:10px;

  background:linear-gradient(135deg,#22c55e,#16a34a);
  color:#fff;

  box-shadow:0 10px 22px rgba(22,163,74,.28);
  cursor:pointer;
  transition:all .2s ease;
}

.invite-btn:active{
  transform:scale(.97);
  box-shadow:0 6px 14px rgba(22,163,74,.25);
}

/* ================= VIDEO LOADER ================= */
.video-loader{
  position:fixed;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:99999;
}

.video-loader video{
  width:180px;
  max-width:60%;
  height:auto;
  object-fit:contain;
}

.hidden{
  display:none;
}

.fade-in{
  animation:fadeIn .25s ease-out;
}

@keyframes fadeIn{
  from{
    opacity:0;
    transform:translateY(6px);
  }
  to{
    opacity:1;
    transform:translateY(0);
  }
}
.team-count{
  transition:transform .15s ease, background .15s ease;
}

.team-count.bump{
  transform:scale(1.08);
  background:#dcfce7;
}
.empty-state img{
  filter:
    grayscale(1)
    sepia(.35)
    hue-rotate(85deg)
    brightness(1.08)
    contrast(.9);
}
.invite-btn{
  position:relative;
  overflow:hidden;
}

.invite-btn .typing-cursor::after{
  content:"|";
  margin-left:2px;
  animation:blink 1s infinite;
}

@keyframes blink{
  0%,50%{opacity:1}
  51%,100%{opacity:0}
}

</style>


<script type="module">

/* ================= CACHE ================= */
const CACHE_KEY = "team_cache_v1";

function saveCache(data){
  localStorage.setItem(CACHE_KEY, JSON.stringify(data));
}

function loadCache(){
  const raw = localStorage.getItem(CACHE_KEY);
  if(!raw) return null;
  try{
    return JSON.parse(raw);
  }catch(e){
    return null;
  }
}

/* ================= FIREBASE ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import {
  getFirestore,
  collection,
  query,
  where,
  getDocs,
  doc,
  getDoc,
  limit
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* üî• FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyDEQYPJFxQv8yFHptrTqoLHOn2L0PpgVhc",
  authDomain: "btcinvest-c0e25.firebaseapp.com",
  projectId: "btcinvest-c0e25"
};

const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

/* ================= GLOBAL STATE ================= */
let allMembers     = [];
let currentLevel   = "all";
let emptyRendered  = false;   // ‚úÖ FIXED: defined globally

const teamList   = document.getElementById("teamList");
const searchInput = document.getElementById("teamSearch");
const refreshBtn  = document.getElementById("refreshTeam");

/* ================= AUTH + DATA LOAD ================= */
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    teamList.innerHTML = "<p>‚ö†Ô∏è Login required</p>";
    return;
  }

  // ‚ö° instant cache render
  const cached = loadCache();
if(cached){
  allMembers = cached;
  renderByCurrentLevel();
}else{
  updateCount([]); // üëà safety
}


  // üîÑ silent fresh fetch
  await fetchTeamData(user);
});

/* ================= FETCH TEAM DATA ================= */
async function fetchTeamData(user) {

  const meSnap = await getDoc(doc(db, "users", user.uid));
  if (!meSnap.exists()) {
    teamList.innerHTML = "<p>User data not found</p>";
    return;
  }

  const myCode = meSnap.data().referralCode;

const q1 = query(
  collection(db,"users"),
  where("referredBy","==",myCode)
);

const q2 = query(
  collection(db,"users"),
  where("upline2","==",user.uid)
);

const q3 = query(
  collection(db,"users"),
  where("upline3","==",user.uid)
);

  const [s1, s2, s3] = await Promise.all([
    getDocs(q1),
    getDocs(q2),
    getDocs(q3)
  ]);

  allMembers = [];

  s1.forEach(d => pushUser(d.data(), 1));
  s2.forEach(d => pushUser(d.data(), 2));
  s3.forEach(d => pushUser(d.data(), 3));

  allMembers.sort((a, b) => b.joinedTime - a.joinedTime);

  emptyRendered = false;     // ‚úÖ reset empty flag
  renderByCurrentLevel();
  saveCache(allMembers);
}

/* ================= NORMALIZE USER ================= */
function pushUser(u, level) {
  const lifetime   = Number(u.lifetimeDeposit || 0);
  const commission = Number(u.commissionToUpline || 0);

  allMembers.push({
    name: u.name || "No Name",
    level,
    lifetimeDeposit: lifetime,
    commission,
    status: lifetime > 0 ? "active" : "inactive",
    joined: parseJoinedDate(u),
    joinedTime: getJoinedTime(u)
  });
}

/* ================= RENDER ================= */
function renderTeam(list){

  // ‚úÖ COUNT YAHIN SE
  updateCount(list);

  if(list.length === 0){

    if(emptyRendered) return;
    emptyRendered = true;

    teamList.innerHTML = `
      <div class="empty-state fade-in">
        <img src="Promotion/WhatsApp Image 2025-12-23 at 9.24.13 PM.jpeg">
        <h3>Your Team Awaits</h3>
        <p>
          No members have joined your team yet.<br>
          Share your referral link to start building a strong and active network.
        </p>
        <button class="invite-btn" onclick="goToInvite()">
          <i class="ri-user-add-line"></i>
          Invite & Earn Rewards
        </button>
      </div>
    `;
    setTimeout(startInviteTyping, 100);
    return;

  }

  emptyRendered = false;

  let html = "";
  list.forEach(u => {
    html += `
      <div class="team-card">
        <div class="team-row">
          <strong>${u.name}</strong>
          <span>Level ${u.level}</span>
        </div>
        <div class="team-row">
          <span>Lifetime Deposit</span>
          <span>${u.lifetimeDeposit}</span>
        </div>
        <div class="team-row">
          <span>Your Commission</span>
          <span>${u.commission}</span>
        </div>
        <div class="team-row">
          <span>Status</span>
          <span class="badge ${u.status}">${u.status}</span>
        </div>
        <div class="team-row">
          <span>Joined</span>
          <span>${u.joined}</span>
        </div>
      </div>
    `;
  });

  teamList.innerHTML = html;
}

/* ================= FILTER ================= */
window.filterLevel = function(level, btn){
  currentLevel = level;
  document.querySelectorAll(".team-filters button")
    .forEach(b => b.classList.remove("active"));

  btn.classList.add("active");
  renderByCurrentLevel();
};

function renderByCurrentLevel(){
  const list = currentLevel === "all"
    ? allMembers
    : allMembers.filter(u => u.level === currentLevel);

  renderTeam(list); // üëà count automatic
}



/* ================= SEARCH ================= */
searchInput.addEventListener("input", () => {
  const keyword = searchInput.value.toLowerCase().trim();

  const base = currentLevel === "all"
    ? allMembers
    : allMembers.filter(u => u.level === currentLevel);

  const filtered = keyword
    ? base.filter(u => u.name.toLowerCase().includes(keyword))
    : base;

  renderTeam(filtered); // üëà count automatic
});



/* ================= REFRESH ================= */
refreshBtn.addEventListener("click", async () => {
    
  showVideoLoader();
});


/* ================= VIDEO LOADER ================= */

function hideVideoLoader(){
  document.getElementById("videoLoader").classList.add("hidden");
}

document.getElementById("loaderVideo")
  .addEventListener("ended", async () => {
    const user = auth.currentUser;
    if(user) await fetchTeamData(user);
    hideVideoLoader();
  });

/* ================= HELPERS ================= */
function parseJoinedDate(u){
  if(u.createdAt?.toDate) return u.createdAt.toDate().toLocaleDateString();
  if(typeof u.createdAt === "string"){
    const d = new Date(u.createdAt);
    if(!isNaN(d)) return d.toLocaleDateString();
  }
  return "N/A";
}

function getJoinedTime(u){
  if(u.createdAt?.toDate) return u.createdAt.toDate().getTime();
  if(typeof u.createdAt === "string"){
    const t = new Date(u.createdAt).getTime();
    if(!isNaN(t)) return t;
  }
  return 0;
}

window.goToInvite = () => {
  window.location.href = "promote.html";
};
async function showVideoLoader(){
  const wrap = document.getElementById("videoLoader");
  const vid  = document.getElementById("loaderVideo");

  wrap.classList.remove("hidden");
  vid.currentTime = 0;

  try{
    await vid.play();   // mobile + desktop dono me chalega
  }catch(e){
    console.log("Video play blocked:", e);
  }
}


function updateCount(list){
  const el = document.getElementById("teamCount");
  el.textContent = list.length;
  el.classList.add("bump");
  setTimeout(()=>el.classList.remove("bump"),150);
}


function startInviteTyping(){
  const inviteBtn = document.querySelector(".invite-btn");
  if(!inviteBtn) return;

  const fullText = "Invite & Earn Rewards";
  let i = 0;

  inviteBtn.innerHTML = `
    <i class="ri-user-add-line"></i>
    <span class="typing-cursor"></span>
  `;

  const span = inviteBtn.querySelector(".typing-cursor");

  function type(){
    if(i <= fullText.length){
      span.textContent = fullText.slice(0, i);
      i++;
      setTimeout(type, 80);
    }
  }

  type();
}

</script>
