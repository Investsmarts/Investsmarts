<meta 
  name="viewport" 
  content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<link href="https://cdn.jsdelivr.net/npm/remixicon@4.1.0/fonts/remixicon.css" rel="stylesheet">

<script>
if (!location.hash) {
  location.replace(location.pathname + "#team#myteam");
}
</script>

<div class="team-page">

<div class="team-header">
  <button class="back-btn" onclick="history.back()">
    <i class="ri-arrow-left-line"></i>
  </button>

  <span class="team-title">My Team</span>
</div>


<div class="team-sticky">
  <div class="team-filters">
   <button onclick="filterLevel('all', this)" class="active">All</button>
<button onclick="filterLevel(1, this)">Level 1</button>
<button onclick="filterLevel(2, this)">Level 2</button>
<button onclick="filterLevel(3, this)">Level 3</button>
  </div>

<div class="sticky-actions">
  <button id="refreshTeam" class="refresh-btn">ðŸ”„</button>

  <div class="team-search">
    <input
      type="text"
      id="teamSearch"
      placeholder="Search by nameâ€¦"
      autocomplete="off"
    />
  </div>

  <!-- âœ… COUNT -->
  <div class="team-count" id="teamCount">0</div>
</div>

</div>


<div id="teamList" class="team-list">
  <p style="padding:16px; text-align:center; color:#64748b;">
    Loadingâ€¦ please wait
  </p>
</div>

</div>

<div id="videoLoader" class="video-loader hidden">
<video id="loaderVideo" preload="auto" muted playsinline>
    <source src="Promotion/WhatsApp Video 2025-12-23 at 5.11.03 PM.mp4" type="video/mp4">
  </video>
</div>

</div>

<style>
/* ================= BASE ================= */
html,body{
  margin:0;
  overflow-x:hidden;
  font-family:Inter,system-ui,sans-serif;
  
}

.team-page{
  max-width:420px;
  margin:0 auto;
  padding:0 12px;
}

/* ================= HEADER ================= */
.team-header{
  position:sticky;
  top:0;
  z-index:100;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:10px 12px;
  background:#f5f7fb;
}

.back-btn{
  border:none;
  background:transparent;
  font-size:20px;
  color:#0f172a;
  cursor:pointer;
}

.team-title{
  font-size:16px;
  font-weight:600;
  color:#0f172a;
}

/* ================= STICKY FILTER BAR ================= */
.team-sticky{
  position:sticky;
  top:52px; /* header height */
  z-index:90;
  background:#f5f7fb;
  padding-bottom:8px;
}

/* ================= FILTER BUTTONS ================= */
.team-filters{
  display:flex;
  gap:8px;
  margin-bottom:10px;
}

.team-filters button{
  flex:1;
  padding:6px;
  font-size:12px;
  border:none;
  border-radius:6px;
  background:#e5e7eb;
  cursor:pointer;
}

.team-filters button.active{
  background:#16a34a;
  color:#fff;
}

/* ================= SEARCH + REFRESH + COUNT ================= */
.sticky-actions{
  display:flex;
  align-items:center;
  gap:10px;
}

.refresh-btn{
  width:40px;
  height:40px;
  display:flex;
  align-items:center;
  justify-content:center;
  border:none;
  background:#16a34a;
  color:#fff;
  border-radius:5px;
  font-size:18px;
  cursor:pointer;
  flex-shrink:0;
}

.team-search{
  flex:1;
}

.team-search input{
  width:100%;
  height:40px;
  padding:0 12px;
  font-size:14px;
  border:1px solid #e5e7eb;
  border-radius:5px;
  outline:none;
}

.team-count{
  min-width:42px;
  height:40px;
  padding:0 10px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:14px;
  font-weight:600;
  background:#e5e7eb;
  color:#0f172a;
  border-radius:5px;
}

/* ================= LIST ================= */
.team-list{
  padding-top:10px;
}

.team-card{
  background:#fff;
  border-radius:10px;
  padding:10px;
  margin-bottom:10px;
  box-shadow:0 4px 12px rgba(0,0,0,.05);
  font-size:13px;
}

.team-row{
  display:flex;
  justify-content:space-between;
  margin:4px 0;
}

/* ================= BADGES ================= */
.badge{
  font-size:11px;
  padding:2px 6px;
  border-radius:4px;
}

.badge.active{
  background:#dcfce7;
  color:#166534;
}

.badge.inactive{
  background:#fee2e2;
  color:#991b1b;
}

/* ================= EMPTY STATE ================= */
.empty-state{
  text-align:center;
  padding:32px 16px;
  color:#475569;
}

.empty-state img{
  width:160px;
  max-width:75%;
  margin-bottom:18px;
}

.empty-state h3{
  font-size:16px;
  font-weight:600;
  margin-bottom:6px;
  color:#0f172a;
}

.empty-state p{
  font-size:13px;
  line-height:1.6;
  color:#64748b;
}

/* ================= INVITE BUTTON ================= */
.invite-btn{
  margin-top:20px;
  width:100%;
  padding:14px 22px;

  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;

  font-size:15px;
  font-weight:600;
  border:none;
  border-radius:10px;

  background:linear-gradient(135deg,#22c55e,#16a34a);
  color:#fff;

  box-shadow:0 10px 22px rgba(22,163,74,.28);
  cursor:pointer;
  transition:all .2s ease;
}

.invite-btn:active{
  transform:scale(.97);
  box-shadow:0 6px 14px rgba(22,163,74,.25);
}

/* ================= VIDEO LOADER ================= */
.video-loader{
  position:fixed;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:99999;
}

.video-loader video{
  width:180px;
  max-width:60%;
  height:auto;
  object-fit:contain;
}

.hidden{
  display:none;
}

.fade-in{
  animation:fadeIn .25s ease-out;
}

@keyframes fadeIn{
  from{
    opacity:0;
    transform:translateY(6px);
  }
  to{
    opacity:1;
    transform:translateY(0);
  }
}
.team-count{
  transition:transform .15s ease, background .15s ease;
}

.team-count.bump{
  transform:scale(1.08);
  background:#dcfce7;
}

.invite-btn{
  position:relative;
  overflow:hidden;
}

.invite-btn .typing-cursor::after{
  content:"|";
  margin-left:2px;
  animation:blink 1s infinite;
}

@keyframes blink{
  0%,50%{opacity:1}
  51%,100%{opacity:0}
}

</style>


<script type="module">

/* ================= CACHE ================= */
const CACHE_KEY = "team_cache_v1";
function saveCache(data){ localStorage.setItem(CACHE_KEY, JSON.stringify(data)); }
function loadCache(){
  const raw = localStorage.getItem(CACHE_KEY);
  if(!raw) return null;
  try{ return JSON.parse(raw); }catch{ return null; }
}

/* ================= FIREBASE ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import {
  getFirestore, collection, query, where,
  getDocs, doc, getDoc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDEQYPJFxQv8yFHptrTqoLHOn2L0PpgVhc",
  authDomain: "btcinvest-c0e25.firebaseapp.com",
  projectId: "btcinvest-c0e25"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

/* ================= GLOBAL ================= */
let allMembers = [];
let currentLevel = "all";
let emptyRendered = false;

const teamList   = document.getElementById("teamList");
const searchInput = document.getElementById("teamSearch");
const refreshBtn  = document.getElementById("refreshTeam");

/* ================= AUTH ================= */
onAuthStateChanged(auth, async (user)=>{
  if(!user){
    teamList.innerHTML = "<p>Login required</p>";
    return;
  }

  const cached = loadCache();
  if(cached){
    allMembers = cached;
    renderByCurrentLevel();
  }

  await fetchTeamData(user);
});

/* ================= FETCH TEAM ================= */
async function fetchTeamData(user){

  const meSnap = await getDoc(doc(db,"users",user.uid));
  if(!meSnap.exists()) return;

  /* ðŸ”¥ COMMISSION MAP (fromUid â†’ amount) */
  const commissionMap = await buildCommissionMap(user.uid);

  const myCode = meSnap.data().referralCode;

  const q1 = query(collection(db,"users"), where("referredBy","==",myCode));
  const q2 = query(collection(db,"users"), where("upline2","==",user.uid));
  const q3 = query(collection(db,"users"), where("upline3","==",user.uid));

  const [s1,s2,s3] = await Promise.all([getDocs(q1),getDocs(q2),getDocs(q3)]);

  allMembers = [];

  s1.forEach(d=> pushUser(d.id, d.data(), 1, commissionMap));
  s2.forEach(d=> pushUser(d.id, d.data(), 2, commissionMap));
  s3.forEach(d=> pushUser(d.id, d.data(), 3, commissionMap));

  allMembers.sort((a,b)=> b.joinedTime - a.joinedTime);
  renderByCurrentLevel();
  saveCache(allMembers);
}

/* ================= COMMISSION MAP ================= */
async function buildCommissionMap(myUid){
  const snap = await getDocs(
    query(
      collection(db, "users", myUid, "commissions"),
      orderBy("createdAt", "desc") // latest first
    )
  );

  const map = {}; // userId â†’ total commission

  snap.forEach(d => {
    const c = d.data();

    // ðŸ”¥ yahan apne REAL field names use karo
    const fromUid =
      c.fromUid ||
      c.userId ||
      c.referralUserId;   // ðŸ‘ˆ jo bhi tumhare data me hai

    const amount =
      Number(c.amount) ||
      Number(c.referralAmount) ||
      Number(c.commission) ||
      0;

    if(!fromUid || !amount) return;

    map[fromUid] = (map[fromUid] || 0) + amount;
  });

  return map;
}

/* ================= PUSH USER ================= */
function pushUser(uid, u, level, commissionMap){

  const lifetime = Number(u.lifetimeDeposit||0);

  allMembers.push({
    uid,
    name: u.name || "No Name",
    level,
    lifetimeDeposit: lifetime,
    commission: commissionMap[uid] || 0, // ðŸ”¥ REAL FIX
    status: lifetime>0 ? "active":"inactive",
    joined: parseJoinedDate(u),
    joinedTime: getJoinedTime(u)
  });
}

/* ================= RENDER ================= */
function renderTeam(list){

  updateCount(list);

  if(list.length===0){
    if(emptyRendered) return;
    emptyRendered = true;
    teamList.innerHTML = `<p>No team members</p>`;
    return;
  }

  emptyRendered=false;
  let html="";

  list.forEach(u=>{
    html+=`
      <div class="team-card">
        <div class="team-row"><strong>${u.name}</strong><span>Level ${u.level}</span></div>
        <div class="team-row"><span>Lifetime Deposit</span><span>${u.lifetimeDeposit}</span></div>
        <div class="team-row"><span>Your Commission</span><span>${u.commission}</span></div>
        <div class="team-row"><span>Status</span><span class="badge ${u.status}">${u.status}</span></div>
        <div class="team-row"><span>Joined</span><span>${u.joined}</span></div>
      </div>
    `;
  });

  teamList.innerHTML = html;
}

/* ================= FILTER ================= */
window.filterLevel=(lvl,btn)=>{
  currentLevel=lvl;
  document.querySelectorAll(".team-filters button").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
  renderByCurrentLevel();
};
function renderByCurrentLevel(){
  const list = currentLevel==="all"? allMembers : allMembers.filter(u=>u.level===currentLevel);
  renderTeam(list);
}

/* ================= HELPERS ================= */
function parseJoinedDate(u){
  if(u.createdAt?.toDate) return u.createdAt.toDate().toLocaleDateString();
  return "N/A";
}
function getJoinedTime(u){
  if(u.createdAt?.toDate) return u.createdAt.toDate().getTime();
  return 0;
}
function updateCount(list){
  document.getElementById("teamCount").textContent = list.length;
}

</script>
