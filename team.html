<meta 
  name="viewport" 
  content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<link href="https://cdn.jsdelivr.net/npm/remixicon@4.1.0/fonts/remixicon.css" rel="stylesheet">


<div class="team-page">

<div class="team-header">
  <button class="back-btn" onclick="history.back()">
    <i class="ri-arrow-left-line"></i>
  </button>

  <span class="team-title">My Team</span>
</div>


<div class="team-sticky">
  <div class="team-filters">
    <button onclick="filterLevel('all')" class="active">All</button>
    <button onclick="filterLevel(1)">Level 1</button>
    <button onclick="filterLevel(2)">Level 2</button>
    <button onclick="filterLevel(3)">Level 3</button>
  </div>

  <div class="sticky-actions">
    <button id="refreshTeam" class="refresh-btn">üîÑ</button>

    <div class="team-search">
      <input
        type="text"
        id="teamSearch"
        placeholder="Search by name‚Ä¶"
        autocomplete="off"
      />
    </div>
  </div>
</div>


<div id="teamList" class="team-list">
  <p style="padding:16px; text-align:center; color:#64748b;">
    Loading‚Ä¶ please wait
  </p>
</div>

</div>

<div id="videoLoader" class="video-loader hidden">
<video id="loaderVideo" preload="auto" autoplay muted playsinline>
    <source src="Promotion/WhatsApp Video 2025-12-23 at 5.11.03 PM.mp4" type="video/mp4">
  </video>
</div>

</div>

<style>
  body{
  margin:0;
  font-family:Inter,system-ui,sans-serif;
  background:#f5f7fb;
}

.team-page{
  max-width:420px;     /* üì± mobile + laptop same feel */
  margin:0 auto;
  padding:0 12px;
}

/* header */
.team-header{
  top:0;
}


/* prevent horizontal scroll */
html,body{
  overflow-x:hidden;
}

  .team-header{
  position: sticky;
  top: 0;
  z-index: 60;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:10px 12px;
  background:#f5f7fb;
}

.back-btn{
  border:none;
  background:transparent;
  font-size:20px;
  color:#0f172a;
  cursor:pointer;
}

.team-title{
  font-size:16px;
  font-weight:600;
  color:#0f172a;
}

.team-page h2{
  font-size:18px;
  margin:10px 0 14px;
}

.team-filters{
  display:flex;
  gap:8px;
  margin-bottom:12px;
}

.team-filters button{
  flex:1;
  padding:6px;
  font-size:12px;
  border:none;
  border-radius:6px;
  background:#e5e7eb;
  cursor:pointer;
}

.team-filters button.active{
  background:#16a34a;
  color:#fff;
}

.team-card{
  background:#fff;
  border-radius:8px;
  padding:10px;
  margin-bottom:10px;
  box-shadow:0 4px 12px rgba(0,0,0,.05);
  font-size:13px;
}

.team-row{
  display:flex;
  justify-content:space-between;
  margin:4px 0;
}

.badge{
  font-size:11px;
  padding:2px 6px;
  border-radius:4px;
}

.badge.active{background:#dcfce7;color:#166534}
.badge.inactive{background:#fee2e2;color:#991b1b}

.team-card i{
  color:#16a34a;
  font-size:15px;
  vertical-align:middle;
  margin-right:4px;
}

.team-search{
  margin-bottom:10px;
}

.team-search input{
  width:100%;
  padding:8px 10px;
  font-size:13px;
  border:1px solid #e5e7eb;
  border-radius:6px;
  outline:none;
}

.video-loader{
  position:fixed;
  inset:0;

 
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:99999;
}

.video-loader video{
  width:180px;          /* üëà size bada */
  max-width:60%;
  height:auto;
  object-fit:contain;
}

.hidden{
  display:none;
}
.team-sticky{
  position: sticky;
  top: 0;
  z-index: 50;
  background:#f5f7fb;
  padding-bottom:8px;
}

/* refresh + search row */
.sticky-actions{
  display:flex;
  gap:8px;
  align-items:center;
}

.refresh-btn{
  border:none;
  background:#16a34a;
  color:#fff;
  border-radius:6px;
  padding:6px 10px;
  font-size:14px;
  cursor:pointer;
}
.empty-state{
  text-align:center;
  padding:32px 16px;
  color:#475569;
}

.empty-state img{
  width:160px;        /* üëà image badi */
  max-width:75%;
  margin-bottom:18px;
}


.empty-state h3{
  font-size:16px;
  font-weight:600;
  margin-bottom:6px;
  color:#0f172a;
}

.empty-state p{
  font-size:13px;
  line-height:1.6;
  color:#64748b;
}
.invite-btn{
  margin-top:14px;
  padding:8px 16px;
  font-size:13px;
  font-weight:500;
  border:none;
  border-radius:8px;
  background:#16a34a;
  color:#fff;
  cursor:pointer;
}

.invite-btn:active{
  transform:scale(.97);
}

.fade-in{
  animation:fadeIn .25s ease-out;
}

@keyframes fadeIn{
  from{
    opacity:0;
    transform:translateY(6px);
  }
  to{
    opacity:1;
    transform:translateY(0);
  }
}

</style>

<script type="module">

/* ================= CACHE ================= */
const CACHE_KEY = "team_cache_v1";

function saveCache(data){
  localStorage.setItem(CACHE_KEY, JSON.stringify(data));
}

function loadCache(){
  const raw = localStorage.getItem(CACHE_KEY);
  if(!raw) return null;
  try{
    return JSON.parse(raw);
  }catch(e){
    return null;
  }
}

/* ================= FIREBASE ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import {
  getFirestore,
  collection,
  query,
  where,
  getDocs,
  doc,
  getDoc,
  limit
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* üî• FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyDEQYPJFxQv8yFHptrTqoLHOn2L0PpgVhc",
  authDomain: "btcinvest-c0e25.firebaseapp.com",
  projectId: "btcinvest-c0e25"
};

const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

/* ================= GLOBAL STATE ================= */
let allMembers     = [];
let currentLevel   = "all";
let emptyRendered  = false;   // ‚úÖ FIXED: defined globally

const teamList   = document.getElementById("teamList");
const searchInput = document.getElementById("teamSearch");
const refreshBtn  = document.getElementById("refreshTeam");

/* ================= AUTH + DATA LOAD ================= */
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    teamList.innerHTML = "<p>‚ö†Ô∏è Login required</p>";
    return;
  }

  // ‚ö° instant cache render
  const cached = loadCache();
  if(cached){
    allMembers = cached;
    renderByCurrentLevel();
  }

  // üîÑ silent fresh fetch
  await fetchTeamData(user);
});

/* ================= FETCH TEAM DATA ================= */
async function fetchTeamData(user) {

  const meSnap = await getDoc(doc(db, "users", user.uid));
  if (!meSnap.exists()) {
    teamList.innerHTML = "<p>User data not found</p>";
    return;
  }

  const myCode = meSnap.data().referralCode;

  const q1 = query(collection(db,"users"), where("referredBy","==",myCode), limit(30));
  const q2 = query(collection(db,"users"), where("upline2","==",user.uid), limit(30));
  const q3 = query(collection(db,"users"), where("upline3","==",user.uid), limit(30));

  const [s1, s2, s3] = await Promise.all([
    getDocs(q1),
    getDocs(q2),
    getDocs(q3)
  ]);

  allMembers = [];

  s1.forEach(d => pushUser(d.data(), 1));
  s2.forEach(d => pushUser(d.data(), 2));
  s3.forEach(d => pushUser(d.data(), 3));

  allMembers.sort((a, b) => b.joinedTime - a.joinedTime);

  emptyRendered = false;     // ‚úÖ reset empty flag
  renderByCurrentLevel();
  saveCache(allMembers);
}

/* ================= NORMALIZE USER ================= */
function pushUser(u, level) {
  const lifetime   = Number(u.lifetimeDeposit || 0);
  const commission = Number(u.commissionToUpline || 0);

  allMembers.push({
    name: u.name || "No Name",
    level,
    lifetimeDeposit: lifetime,
    commission,
    status: lifetime > 0 ? "active" : "inactive",
    joined: parseJoinedDate(u),
    joinedTime: getJoinedTime(u)
  });
}

/* ================= RENDER ================= */
function renderTeam(list) {

  if (list.length === 0) {

    if (emptyRendered) return;   // ‚úÖ FIXED: prevent re-render blink
    emptyRendered = true;

    teamList.innerHTML = `
      <div class="empty-state fade-in">
        <img src="Promotion/WhatsApp Image 2025-12-23 at 9.24.13 PM.jpeg" alt="Team Illustration">
        <h3>Your Team Awaits</h3>
        <p>
          No members have joined your team yet.<br>
          Share your referral link to start building a strong and active network.
        </p>
        <button class="invite-btn" onclick="goToInvite()">Invite Now</button>
      </div>
    `;
    return;
  }

  let html = "";
  list.forEach(u => {
    html += `
      <div class="team-card">
        <div class="team-row">
          <strong>${u.name}</strong>
          <span>Level ${u.level}</span>
        </div>
        <div class="team-row">
          <span>Lifetime Deposit</span>
          <span>${u.lifetimeDeposit}</span>
        </div>
        <div class="team-row">
          <span>Your Commission</span>
          <span>${u.commission}</span>
        </div>
        <div class="team-row">
          <span>Status</span>
          <span class="badge ${u.status}">${u.status}</span>
        </div>
        <div class="team-row">
          <span>Joined</span>
          <span>${u.joined}</span>
        </div>
      </div>
    `;
  });

  teamList.innerHTML = html;
}

/* ================= FILTER ================= */
window.filterLevel = function(level){
  currentLevel = level;
  document.querySelectorAll(".team-filters button")
    .forEach(b => b.classList.remove("active"));
  event.target.classList.add("active");
  renderByCurrentLevel();
};

function renderByCurrentLevel(){
  if(currentLevel === "all"){
    renderTeam(allMembers);
  }else{
    renderTeam(allMembers.filter(u => u.level === currentLevel));
  }
}

/* ================= SEARCH ================= */
searchInput.addEventListener("input", () => {
  const keyword = searchInput.value.toLowerCase().trim();
  const base = currentLevel === "all"
    ? allMembers
    : allMembers.filter(u => u.level === currentLevel);

  renderTeam(
    keyword ? base.filter(u => u.name.toLowerCase().includes(keyword)) : base
  );
});

/* ================= REFRESH ================= */
refreshBtn.addEventListener("click", async () => {
  showVideoLoader();
});


/* ================= VIDEO LOADER ================= */

function hideVideoLoader(){
  document.getElementById("videoLoader").classList.add("hidden");
}

document.getElementById("loaderVideo")
  .addEventListener("ended", async () => {
    const user = auth.currentUser;
    if(user) await fetchTeamData(user);
    hideVideoLoader();
  });

/* ================= HELPERS ================= */
function parseJoinedDate(u){
  if(u.createdAt?.toDate) return u.createdAt.toDate().toLocaleDateString();
  if(typeof u.createdAt === "string"){
    const d = new Date(u.createdAt);
    if(!isNaN(d)) return d.toLocaleDateString();
  }
  return "N/A";
}

function getJoinedTime(u){
  if(u.createdAt?.toDate) return u.createdAt.toDate().getTime();
  if(typeof u.createdAt === "string"){
    const t = new Date(u.createdAt).getTime();
    if(!isNaN(t)) return t;
  }
  return 0;
}

window.goToInvite = () => {
  window.location.href = "invite.html";
};
async function showVideoLoader(){
  const wrap = document.getElementById("videoLoader");
  const vid  = document.getElementById("loaderVideo");

  wrap.classList.remove("hidden");
  vid.currentTime = 0;

  try{
    await vid.play();   // mobile + desktop dono me chalega
  }catch(e){
    console.log("Video play blocked:", e);
  }
}

</script>
