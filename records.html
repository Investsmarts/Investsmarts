<!-- ✅ Records Section -->
<div class="records-section">
  <h2>My Wallet Records</h2>
  <div class="count-box">Total Wallets: <span id="walletCount">0</span></div>
  <div class="wallet-list" id="walletList">
    <p style="text-align:center;color:#666;">Loading...</p>
  </div>
</div>

<script type="module">
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import { getFirestore, collection, getDocs, deleteDoc, doc, updateDoc, getDoc } 
  from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  const auth = getAuth();
  const db = getFirestore();

  const walletList = document.getElementById("walletList");
  const walletCount = document.getElementById("walletCount");

  let currentUserId = null;
  let primaryAddress = null;

  async function loadWallets(userId) {
    const snapshot = await getDocs(collection(db, "users", userId, "wallets"));
    walletList.innerHTML = "";
    if (snapshot.empty) {
      walletList.innerHTML = "<p style='text-align:center;color:#666;'>No wallets added yet.</p>";
      walletCount.textContent = "0";
      return;
    }

    let count = 0;
    snapshot.forEach(docSnap => {
      count++;
      const data = docSnap.data();
      const walletId = docSnap.id;

      const card = document.createElement("div");
      card.className = "wallet-card";

      const info = document.createElement("div");
      info.className = "wallet-info";
      info.innerHTML = `
        <b>${data.walletApp}</b> 
        ${data.address === primaryAddress ? '<span class="primary-badge">Primary</span>' : ""}
        <p>${data.address}</p>
      `;

      const actions = document.createElement("div");
      actions.className = "wallet-actions";

      // ✅ Set Primary Button
      const primaryBtn = document.createElement("button");
      primaryBtn.className = "primary-btn";
      primaryBtn.textContent = "Set Primary";
      primaryBtn.onclick = async () => {
        await updateDoc(doc(db, "users", userId), {
          primaryAddress: data.address,
          primaryWallet: data.walletApp
        });
        primaryAddress = data.address;
        loadWallets(userId);
      };

      // ❌ Delete Button
      const deleteBtn = document.createElement("button");
      deleteBtn.className = "delete-btn";
      deleteBtn.textContent = "Delete";
      deleteBtn.onclick = async () => {
        await deleteDoc(doc(db, "users", userId, "wallets", walletId));
        loadWallets(userId);
      };

      actions.appendChild(primaryBtn);
      actions.appendChild(deleteBtn);

      card.appendChild(info);
      card.appendChild(actions);

      walletList.appendChild(card);
    });

    walletCount.textContent = count;
  }

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUserId = user.uid;
      // load current primary from user doc
      const userRef = doc(db, "users", user.uid);
      const userSnap = await getDoc(userRef);
      if (userSnap.exists()) {
        primaryAddress = userSnap.data().primaryAddress || null;
      }
      loadWallets(user.uid);
    } else {
      walletList.innerHTML = "<p style='text-align:center;color:red;'>Please log in.</p>";
    }
  });
</script>
