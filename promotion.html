<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Promotion</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #f1f5f9;
      margin: 0;
      padding-bottom: 100px;
      color: #333;
    }
    .container { max-width: 950px; margin: auto; padding: 20px; }
    h1 { text-align: center; margin-bottom: 20px; color: #1e293b; }

    .card {
      background: #fff;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      margin-bottom: 20px;
      text-align: center;
    }

    /* Referral Link */
    .referral-link { 
      font-size: 14px; 
      background: #f9fafb; 
      padding: 12px; 
      border-radius: 10px; 
      margin: 15px auto; 
      border: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }

    .referral-link span {
      display: block;
      max-width: 100%;      /* ‚úÖ parent ke width ke andar hi rahe */
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: #2563eb;
      font-weight: bold;
      word-break: break-all;
    }

    #qrcode {
      margin: 15px auto;
    }
    .btn-row { display: flex; justify-content: center; gap: 10px; margin-top: 15px; }
    .btn { padding: 10px 18px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: #fff; transition: 0.3s; }
    .btn-copy { background: #00aaff; }
    .btn-share { background: #ff9800; }
    .btn:hover { opacity: 0.9; }

    /* Level Buttons */
    .level-buttons {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin: 15px 0;
    }
    .level-btn {
      flex: 1;
      min-width: 0;
      padding: 10px 8px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      background: #e5e7eb;
      color: #333;
      transition: 0.3s;
      text-align: center;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .level-btn.active {
      background: #2563eb;
      color: #fff;
    }

    /* Level Content */
    .level-content {
      display: none;
      text-align: left;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 12px;
      background: #fff;
    }
    .level-content.active { display: block; }

    /* Loader */
    .loader {
      text-align: center;
      padding: 10px;
      font-size: 14px;
      color: #2563eb;
      display: none;
    }

    /* Bottom Navbar */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 70px;
      background: #fff;
      display: flex;
      justify-content: space-around;
      align-items: center;
      border-top: 2px solid #28a745;
      z-index: 100;
    }
    .nav-item {
      flex: 1;
      text-align: center;
      font-size: 12px;
      color: #333;
      text-decoration: none;
      transition: 0.3s;
      position: relative;
      padding: 10px 0;
    }
    .nav-item i {
      font-size: 22px;
      display: block;
      margin-bottom: 3px;
      color: #28a745;
    }
    .nav-item:hover { color: #28a745; }
    .nav-item:hover i { color: #218838; }

    /* Popup Notification */
    .popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #2563eb;
      color: #fff;
      padding: 15px 25px;
      border-radius: 8px;
      font-size: 14px;
      display: none;
      z-index: 200;
      animation: fadeInOut 3s forwards;
    }
    @keyframes fadeInOut {
      0% { opacity: 0; transform: translate(-50%, -60%); }
      10% { opacity: 1; transform: translate(-50%, -50%); }
      90% { opacity: 1; }
      100% { opacity: 0; transform: translate(-50%, -40%); }
    }
  </style>
</head>
<body>
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

  <div class="container">
    <h1>Promote & Earn</h1>

    <!-- Referral -->
    <div class="card referral-card">
      <p>Invite your friends and earn commissions (3 Levels).</p>
      <div class="referral-link" id="refLink">Loading...</div>
      <canvas id="qrcode"></canvas>
      <div class="btn-row">
        <button class="btn btn-copy" onclick="copyReferral()">Copy Link</button>
        <button class="btn btn-share" onclick="shareReferral()">Share Link</button>
      </div>
    </div>

    <!-- Level Buttons -->
    <div class="level-buttons">
      <button class="level-btn active" onclick="showLevel(1)">1 (<span id="level1Users">0</span>)</button>
      <button class="level-btn" onclick="showLevel(2)">2 (<span id="level2Users">0</span>)</button>
      <button class="level-btn" onclick="showLevel(3)">3 (<span id="level3Users">0</span>)</button>
    </div>

    <!-- Content Sections -->
    <div id="level1" class="level-content active">
      <h3>Earning: <b id="level1Earning">$0</b></h3>
      <div id="loader1" class="loader"> Loading...</div>
      <div id="level1List"></div>
    </div>

    <div id="level2" class="level-content">
      <h3>Earning: <b id="level2Earning">$0</b></h3>
      <div id="loader2" class="loader"> Loading...</div>
      <div id="level2List"></div>
    </div>

    <div id="level3" class="level-content">
      <h3>Earning: <b id="level3Earning">$0</b></h3>
      <div id="loader3" class="loader"> Loading...</div>
      <div id="level3List"></div>
    </div>
  </div>

  <!-- Popup -->
  <div id="popup" class="popup"></div>

  <!-- Bottom Navbar -->
  <div class="bottom-nav">
    <a href="Dashboard.html" class="nav-item"><i class='bx bx-home'></i><span>Home</span></a>
    <a href="invest.html" class="nav-item"><i class='bx bx-wallet'></i><span>Invest</span></a>
    <a href="promotion.html" class="nav-item"><i class='bx bx-gift'></i><span>Refer</span></a>
    <a href="account.html" class="nav-item"><i class='bx bx-user'></i><span>Account</span></a>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDEQYPJFxQv8yFHptrTqoLHOn2L0PpgVhc",
      authDomain: "btcinvest-c0e25.firebaseapp.com",
      projectId: "btcinvest-c0e25",
      storageBucket: "btcinvest-c0e25.firebasestorage.app",
      messagingSenderId: "204937458487",
      appId: "1:204937458487:web:cc27ece1249999279f60b2",
      measurementId: "G-HG0Q8ZHT6G"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let finalRefLink = "";

    function showPopup(msg) {
      const popup = document.getElementById("popup");
      popup.innerText = msg;
      popup.style.display = "block";
      setTimeout(() => popup.style.display = "none", 3000);
    }

    window.showLevel = function(level) {
      document.querySelectorAll(".level-btn").forEach(btn => btn.classList.remove("active"));
      document.querySelectorAll(".level-content").forEach(content => content.classList.remove("active"));
      document.querySelector(`.level-btn:nth-child(${level})`).classList.add("active");
      document.getElementById(`level${level}`).classList.add("active");

      document.getElementById(`loader${level}`).style.display = "block";
      document.getElementById(`level${level}List`).innerHTML = "";
      setTimeout(() => document.getElementById(`loader${level}`).style.display = "none", 1500);
    };

    window.copyReferral = function () {
      if (!finalRefLink) return showPopup("‚ö†Ô∏è Please log in first.");
      navigator.clipboard.writeText(finalRefLink);
      showPopup(" Referral link copied!");
    };

    window.shareReferral = function () {
      if (!finalRefLink) return showPopup("‚ö†Ô∏è Please log in first.");
      if (navigator.share) {
        navigator.share({
          title: "üî• TrustDollar Invitation",
          text: `üéÅ Join TrustDollar & start earning!\nüëâ ${finalRefLink}`,
          url: finalRefLink
        });
      } else {
        showPopup("‚ö†Ô∏è Sharing not supported. Link copied!");
        navigator.clipboard.writeText(finalRefLink);
      }
    };

    function renderLevelList(listId, users, levelNum) {
      document.getElementById(`loader${levelNum}`).style.display = "none";
      const container = document.getElementById(listId);
      if (users.length === 0) {
        container.innerHTML = "<em>No users yet</em>";
        return;
      }
      container.innerHTML = users.map(u => `
        <div class="user-item">
        <strong>${u.name || "Unnamed"}</strong> (${u.email || "No email"})
        <span class="deposit">$${u.lifetimeDeposit || 0}</span>
        </div>
        `).join("");
    }

    async function loadStats(currentUser) {
      let levels = [
        {num:1, field:"referredBy", val: currentUser.referralCode, rate:0.10},
        {num:2, field:"upline2", val: currentUser.uid, rate:0.05},
        {num:3, field:"upline3", val: currentUser.uid, rate:0.02},
        ];
      for (let l of levels) {
        let members = [];
        let earning = 0;
        const qSnap = await getDocs(query(collection(db,"users"), where(l.field,"==",l.val)));
        qSnap.forEach(d=>{
          const u = d.data();
          members.push(u);
          earning += (u.lifetimeDeposit||0)*l.rate;
        });
        document.getElementById(`level${l.num}Users`).textContent = members.length;
        document.getElementById(`level${l.num}Earning`).textContent = `$${earning.toFixed(2)}`;
        renderLevelList(`level${l.num}List`, members, l.num);
      }
    }

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        const userDoc = await getDoc(doc(db,"users",user.uid));
        if (userDoc.exists()) {
          const currentUser = userDoc.data();
          currentUser.uid = user.uid;

          finalRefLink = `https://smartfundad.com/index.html?ref=${currentUser.referralCode || user.uid}`;
          document.getElementById("refLink").innerHTML = `
          <strong>üéÅ Your Invitation Link:</strong><br>
          <span>${finalRefLink}</span>
          `;
        // ‚úÖ Generate QR
          QRCode.toCanvas(document.getElementById("qrcode"), finalRefLink, { width: 150 });
          loadStats(currentUser);
        }
      } else {
        document.getElementById("refLink").innerHTML = `<strong>‚ö†Ô∏è Please log in to get your referral link.</strong>`;
      }
    });
  </script>
</body>
</html>
