<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Promotion</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #f1f5f9;
      margin: 0;
      padding-bottom: 100px;
      color: #333;
    }
    .container { max-width: 950px; margin: auto; padding: 20px; }
    h1 { text-align: center; margin-bottom: 20px; color: #1e293b; }

    .card {
      background: #fff;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      margin-bottom: 20px;
      text-align: center;
    }

    /* Referral Link */
    .referral-link { 
      word-break: break-all; 
      font-size: 14px; 
      background: #f9fafb; 
      padding: 12px; 
      border-radius: 10px; 
      margin: 15px auto; 
      border: 1px solid #e5e7eb;
    }
    .btn-row { display: flex; justify-content: center; gap: 10px; margin-top: 15px; }
    .btn { padding: 10px 18px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: #fff; transition: 0.3s; }
    .btn-copy { background: #00aaff; }
    .btn-share { background: #ff9800; }
    .btn:hover { opacity: 0.9; }

    /* Tab style header */
    .tabs {
      display: flex;
      justify-content: space-around;
      border-bottom: 2px solid #e5e7eb;
      margin-bottom: 15px;
    }
    .tab {
      flex: 1;
      text-align: center;
      padding: 12px 0;
      font-weight: 600;
      color: #666;
      cursor: pointer;
      transition: 0.3s;
      position: relative;
    }
    .tab.active {
      color: #2563eb;
    }
    .tab.active::after {
      content: "";
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg,#22c55e,#2563eb);
      border-radius: 3px;
    }

    /* Level content */
    .level-content {
      display: none;
      text-align: left;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 12px;
      background: #fff;
    }
    .level-content.active {
      display: block;
    }
    .user-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      font-size: 14px;
    }
    .user-item:last-child { border: none; }
    .user-name { font-weight: 600; }
    .deposit { color: #2563eb; font-weight: 600; }

    /* Bottom Nav */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 70px;
      background: #fff;
      display: flex;
      justify-content: space-around;
      align-items: center;
      border-top: 2px solid #28a745;
      z-index: 100;
    }
    .nav-item {
      flex: 1;
      text-align: center;
      font-size: 12px;
      color: #333;
      text-decoration: none;
      transition: 0.3s;
      position: relative;
      padding: 10px 0;
    }
    .nav-item i {
      font-size: 22px;
      display: block;
      margin-bottom: 3px;
      color: #28a745;
    }
    .nav-item:hover { color: #28a745; }
    .nav-item:hover i { color: #218838; }
  </style>
</head>
<body>
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

  <div class="container">
    <h1>Promote & Earn</h1>

    <!-- Referral -->
    <div class="card referral-card">
      <p>Invite your friends and earn commissions (3 Levels).</p>
      <div class="referral-link" id="refLink">Loading...</div>
      <div class="btn-row">
        <button class="btn btn-copy" onclick="copyReferral()">Copy Link</button>
        <button class="btn btn-share" onclick="shareReferral()">Share Link</button>
      </div>
    </div>

    <!-- Tabs for Levels -->
    <div class="card">
      <div class="tabs">
        <div class="tab active" onclick="showLevel(1)">Level 1 (<span id="level1Users">0</span>)</div>
        <div class="tab" onclick="showLevel(2)">Level 2 (<span id="level2Users">0</span>)</div>
        <div class="tab" onclick="showLevel(3)">Level 3 (<span id="level3Users">0</span>)</div>
      </div>

      <!-- Content -->
      <div id="level1" class="level-content active">
        <h3>Earning: <b id="level1Earning">$0</b></h3>
        <div id="level1List"></div>
      </div>
      <div id="level2" class="level-content">
        <h3>Earning: <b id="level2Earning">$0</b></h3>
        <div id="level2List"></div>
      </div>
      <div id="level3" class="level-content">
        <h3>Earning: <b id="level3Earning">$0</b></h3>
        <div id="level3List"></div>
      </div>
    </div>
  </div>

  <!-- Navbar -->
  <div class="bottom-nav">
    <a href="Dashboard.html" class="nav-item"><i class='bx bx-home'></i><span>Home</span></a>
    <a href="invest.html" class="nav-item"><i class='bx bx-wallet'></i><span>Invest</span></a>
    <a href="promotion.html" class="nav-item"><i class='bx bx-gift'></i><span>Refer</span></a>
    <a href="account.html" class="nav-item"><i class='bx bx-user'></i><span>Account</span></a>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, query, where, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  // ‚úÖ Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyDEQYPJFxQv8yFHptrTqoLHOn2L0PpgVhc",
    authDomain: "btcinvest-c0e25.firebaseapp.com",
    projectId: "btcinvest-c0e25",
    storageBucket: "btcinvest-c0e25.firebasestorage.app",
    messagingSenderId: "204937458487",
    appId: "1:204937458487:web:cc27ece1249999279f60b2",
    measurementId: "G-HG0Q8ZHT6G"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  let finalRefLink = "";

  // ‚úÖ Show tab function (Fix for your error)
  window.showLevel = function(level) {
    document.querySelectorAll(".tab").forEach(tab => tab.classList.remove("active"));
    document.querySelectorAll(".level-content").forEach(content => content.classList.remove("active"));
    
    // activate clicked tab & its content
    document.querySelector(`.tab:nth-child(${level})`).classList.add("active");
    document.getElementById(`level${level}`).classList.add("active");
  };

  // ‚úÖ Copy & Share
  window.copyReferral = function () {
    if (!finalRefLink) return alert("Please log in first.");
    navigator.clipboard.writeText(finalRefLink);
    alert("‚úÖ Referral link copied!");
  };
  window.shareReferral = function () {
    if (!finalRefLink) return alert("Please log in first.");
    if (navigator.share) {
      navigator.share({
        title: "üî• TrustDollar Invitation",
        text: `üéÅ Join TrustDollar & start earning!\n\nHere‚Äôs my exclusive link:\n${finalRefLink}`,
        url: finalRefLink
      });
    } else {
      alert("‚ö†Ô∏è Sharing not supported in this browser.");
    }
  };

  // ‚úÖ Render users list
  function renderLevelList(listId, users) {
    const container = document.getElementById(listId);
    if (users.length === 0) {
      container.innerHTML = "<em>No users yet</em>";
      return;
    }
    container.innerHTML = users.map(u => `
      <div style="padding:8px; border-bottom:1px solid #eee; text-align:left;">
        <strong>${u.name || "Unnamed"}</strong> (${u.email || "No email"})<br>
        Deposit: <b>$${u.lifetimeDeposit || 0}</b>
      </div>
    `).join("");
  }

  // ‚úÖ Load Stats
  async function loadStats(currentUser) {
    let levels = [
      {num:1, field:"referredBy", val: currentUser.referralCode, rate:0.10},
      {num:2, field:"upline2", val: currentUser.uid, rate:0.05},
      {num:3, field:"upline3", val: currentUser.uid, rate:0.02},
    ];

    for (let l of levels) {
      let members = [];
      let earning = 0;
      const qSnap = await getDocs(query(collection(db,"users"), where(l.field,"==",l.val)));
      qSnap.forEach(d=>{
        const u = d.data();
        members.push(u);
        earning += (u.lifetimeDeposit||0)*l.rate;
      });
      document.getElementById(`level${l.num}Users`).textContent = members.length;
      document.getElementById(`level${l.num}Earning`).textContent = `$${earning.toFixed(2)}`;
      renderLevelList(`level${l.num}List`, members);
    }
  }

  // ‚úÖ Auth listener
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      const userDoc = await getDoc(doc(db,"users",user.uid));
      if (userDoc.exists()) {
        const currentUser = userDoc.data();
        currentUser.uid = user.uid;

        // referral link
        finalRefLink = `https://smartfundad.com/index.html?ref=${currentUser.referralCode || user.uid}`;
        document.getElementById("refLink").innerHTML = `
          <strong>üéÅ Your Invitation Link:</strong><br>
          <span style="color:#2563eb; font-weight:bold;">${finalRefLink}</span>
        `;
        // load stats
        loadStats(currentUser);
      }
    } else {
      document.getElementById("refLink").innerHTML = `<strong>‚ö†Ô∏è Please log in to get your referral link.</strong>`;
    }
  });
</script>


</body>
</html>
