<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TrustDollar Staking</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Poppins',sans-serif;background:#f8fafc;color:#111}

    /* ‚úÖ Navbar */
    .nav{
      display:flex;justify-content:center;gap:18px;
      background:#fff;padding:12px 0;
      position:fixed;top:0;left:0;width:100%;z-index:1000;
      border-bottom:2px solid #e5e7eb
    }
    .nav a{
      padding:10px 14px;text-decoration:none;color:#333;
      font-weight:600;transition:all 0.3s ease;
      border-bottom:3px solid transparent;cursor:pointer
    }
    .nav a.active{color:#0b7a4f;border-bottom:3px solid #0b7a4f}

    /* ‚úÖ Sections */
    .section{
      max-width:1200px;margin:0 auto;padding:20px;margin-top:70px;
      display:none;transition:opacity 0.3s ease,transform 0.3s ease
    }
    .section.active{display:block;opacity:1;transform:translateY(0)}
    h2{text-align:center;margin:18px 0 22px;font-size:20px}

    /* ‚úÖ Staking cards */
    .staking-container{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:18px;max-width:1100px;margin:0 auto
    }
    .staking-box{
      background:#fff;border-radius:14px;
      box-shadow:0 6px 20px rgba(16,24,40,0.06);
      padding:16px;transition:all .22s;
      display:flex;flex-direction:column
    }
    .staking-box:hover{transform:translateY(-6px)}
    .staking-header{display:flex;justify-content:space-between;color:#168b65;font-weight:600;margin-bottom:10px}
    .staking-img{
      display:flex;justify-content:center;align-items:center;
      height:200px;background:#fff;border-radius:12px;
      border:1px solid #e6edf0;overflow:hidden;padding:8px;margin-bottom:12px
    }
    .staking-img img{width:100%;height:100%;object-fit:contain}
    .staking-title{text-align:center;font-weight:700;font-size:16px;margin-bottom:8px}
    .staking-info{color:#555;font-size:14px;margin-bottom:12px;text-align:center}
    .staking-info p{margin:4px 0}
    .staking-info span{font-weight:700;color:#1f7f63}
    .stake-btn{
      margin-top:auto;width:100%;padding:12px;border:0;border-radius:10px;
      background:linear-gradient(135deg,#22c55e,#16a34a);
      color:#fff;font-weight:700;cursor:pointer;font-size:15px;transition:all .3s
    }
    .stake-btn:hover{background:linear-gradient(135deg,#15803d,#16a34a)}

    /* ‚úÖ History */
    .history-wrap{max-width:1100px;margin:18px auto;display:none}
    .history-item{
      display:flex;justify-content:space-between;align-items:center;
      padding:12px;border-radius:10px;background:#fff;
      margin-bottom:10px;border:1px solid #eef2f4
    }
    .countdown{font-size:13px;color:#666;margin-top:6px}
    .center-msg{text-align:center;color:#666;padding:14px;background:#fff;border-radius:8px}

    /* ‚úÖ Popup */
    #popup{display:none;position:fixed;inset:0;align-items:center;justify-content:center;z-index:12000}
    #popup .pbox{
      background:#111;color:#fff;padding:12px 16px;border-radius:8px;
      animation:fadeIn 0.3s ease
    }
    @keyframes fadeIn{from{opacity:0;transform:scale(.9)}to{opacity:1;transform:scale(1)}}

    /* ‚úÖ Modal */
    .modal{
      display:none;position:fixed;inset:0;background:rgba(0,0,0,0.55);
      z-index:9999;align-items:center;justify-content:center;padding:20px
    }
    .modal-content{
      width:100%;max-width:420px;background:#fff;border-radius:12px;
      padding:18px;box-shadow:0 20px 50px rgba(2,6,23,0.2);animation:fadeIn 0.3s ease
    }
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .modal-header h3{font-size:18px}
    .close-btn{cursor:pointer;font-size:20px}
    .modal-img{
      display:flex;justify-content:center;align-items:center;
      height:220px;background:#fff;border-radius:12px;
      border:1px solid #e6edf0;overflow:hidden;margin-bottom:12px
    }
    .modal-img img{width:100%;height:100%;object-fit:contain}
    .info-box{margin:8px 0}
    .info-box label{display:block;font-size:13px;font-weight:600;margin-bottom:6px}
    .info-box input{
      width:100%;padding:10px;border:1px solid #d6dbe0;
      border-radius:10px;background:#fbfdff
    }
    .stake-action{margin-top:12px}
    .stake-action input[type="number"]{
      width:100%;padding:10px;border-radius:10px;
      border:1px solid #d6dbe0;margin-bottom:10px
    }
    .stake-action button{
      width:100%;padding:12px;border-radius:10px;border:0;
      background:linear-gradient(135deg,#16a34a,#22c55e);
      color:#fff;font-weight:700;cursor:pointer;transition:all .3s
    }
    .stake-action button:hover{background:linear-gradient(135deg,#15803d,#16a34a)}

    /* ‚úÖ Investment History Cards */
    #historyList{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
      gap:18px
    }
    .invest-card{
      background:#fff;border-radius:16px;
      box-shadow:0 6px 20px rgba(16,24,40,0.08);
      padding:18px;margin-bottom:20px;
      display:flex;flex-direction:column;align-items:center
    }
    .invest-card img{
      width:100%;max-height:220px;object-fit:contain;
      border-radius:12px;margin-bottom:14px
    }
    .invest-title{font-weight:700;font-size:18px;margin-bottom:12px;text-align:center}
    .invest-info{width:100%;font-size:14px;color:#444;margin-top:12px}
    .invest-info p{
      margin:8px 0;display:flex;justify-content:space-between;align-items:center;
      border-bottom:1px solid #f1f1f1;padding-bottom:6px
    }
    .invest-info p:last-child{border-bottom:none}
    .invest-label{flex:1;font-weight:600;color:#555}
    .invest-value{flex:1;text-align:right;font-weight:700;color:#111}

    .status-badge{
      display:inline-block;padding:4px 12px;border-radius:8px;
      font-size:13px;font-weight:600
    }
    .status-active{background:#dcfce7;color:#166534}
    .status-complete{background:#dbeafe;color:#1e40af}
    .status-cancel{background:#fee2e2;color:#b91c1c}

    .countdown-box{
      width:100%;text-align:center;padding:12px;margin-top:16px;
      border-radius:12px;background:linear-gradient(135deg,#dbeafe,#e0f7f4);
      font-weight:600;font-size:14px
    }

    /* ‚úÖ Responsive Fix */
@media(max-width:768px){
  .invest-card{padding:14px}
  .invest-title{font-size:16px}

  /* ‚úÖ left-right fix */
  .invest-info p{
    font-size:13px;
    flex-direction:row;   /* column ‚ùå -> row ‚úÖ */
    align-items:center;   /* vertically center */
  }
  .invest-info span{margin-top:0} /* extra gap hata diya */
  
  .countdown-box{font-size:13px;padding:8px}
}

@media(max-width:600px){
  .staking-img{height:160px}
  .staking-title{font-size:15px}
  .nav{gap:12px;font-size:14px}
}

@media(max-width:480px){
  .invest-card{padding:12px}
  .invest-title{font-size:15px}
  .invest-info{font-size:12px}
}

  
    /* Floating label wrapper */
.input-box {
  position: relative;
  margin: 14px 0;
}

.input-box input {
  width: 100%;
  padding: 12px 10px;
  border: 1px solid #d6dbe0;
  border-radius: 10px;
  background: #fbfdff;
  font-size: 14px;
  outline: none;
}

.input-box label {
  position: absolute;
  left: 12px;
  top: 12px;
  color: #666;
  font-size: 14px;
  font-weight: 500;
  pointer-events: none;
  transition: all 0.2s ease;
}

/* ‚úÖ Jab input focus ho ya value ho tab label upar chala jaye */
.input-box input:focus + label,
.input-box input:not(:placeholder-shown) + label {
  top: -6px;
  left: 8px;
  font-size: 12px;
  color: #0b7a4f;
  background: #fff;
  padding: 0 4px;
  border-radius: 4px;
}


  </style>

</head>
<body>

  <!-- Top Navigation -->
  <div class="nav">
    <a class="active" onclick="showSection('staking')">Staking</a>
    <a href="buy-hashrate.html">Stack Long</a>
    <a onclick="showSection('record')">Record</a>
  </div>

  <!-- Sections -->
  <div id="staking" class="section active">
    <h2>TrustDollar Amount Staking</h2>
    <div class="staking-container">
      <div class="staking-box">
        <div class="staking-header"><span>Plan = 1</span><span>Per Day</span></div>
        <div class="staking-img"><img src="myphoto/1414.png" alt="vault"></div>
        <div class="staking-title">TrustDollar Amount Staking</div>
        <div class="staking-info"><p>Amount: <span>200 - 10,000 USDT</span></p><p>Daily Return: <span>1%</span></p></div>
        <button class="stake-btn" onclick="openModal('Per Day',200,10000,1,'myphoto/1414.png')">Stake Now</button>
      </div>
      <div class="staking-box">
        <div class="staking-header"><span>Plan = 2</span><span>15 Days</span></div>
        <div class="staking-img"><img src="myphoto/star.png" alt="vault"></div>
        <div class="staking-title">TrustDollar Amount Staking</div>
        <div class="staking-info"><p>Amount: <span>500 - 20,000 USDT</span></p><p>Daily Return: <span>1.2%</span></p></div>
        <button class="stake-btn" onclick="openModal('15 Days',500,20000,1.2,'myphoto/star.png')">Stake Now</button>
      </div>
      <div class="staking-box">
        <div class="staking-header"><span>Plan = 3</span><span>30 days</span></div>
        <div class="staking-img"><img src="myphoto/112211.png" alt="vault"></div>
        <div class="staking-title">TrustDollar Amount Staking</div>
        <div class="staking-info"><p>Amount: <span>1500 - 150,000 USDT</span></p><p>Daily Return: <span>1.4%</span></p></div>
        <button class="stake-btn" onclick="openModal('30 Days',1500,150000,1.3,'myphoto/112211.png')">Stake Now</button>
      </div>
    </div>
  </div>

  <div id="record" class="section">
    <h2>Your Investments</h2>
    <div id="historyList"></div>
  </div>

  <!-- Modal -->
  <div class="modal" id="stakeModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalPlan">Staking</h3>
        <div class="close-btn" onclick="closeModal()">‚úï</div>
      </div>
      <div class="modal-img"><img id="modalImg" src="" alt="vault"></div>
      <div class="modal-info">
        <div class="info-box"><label>Balance</label><input type="text" id="userBalance" readonly value="Loading..."></div>
        <div class="info-box"><label>Amount (min - max)</label><input type="text" id="modalAmount" readonly></div>
        <div class="info-box"><label>Daily Return</label><input type="text" id="modalReturn" readonly></div>
      </div>
    <div class="stake-action">
  <div class="input-box">
    <input type="number" id="stakeInput" placeholder=" " required>
    <label for="stakeInput">Enter amount to stake (USDT)</label>
  </div>
  <button onclick="confirmStake()">Confirm Stake</button>
</div>

    </div>
  </div>
  <div id="record" class="section">
    <h2>Your Investments</h2>
    
    <!-- ‚úÖ Summary Section -->
    <div id="recordSummary" style="
    background:#fff;
    border-radius:12px;
    box-shadow:0 6px 20px rgba(16,24,40,0.08);
    padding:16px;
    margin-bottom:20px;
    display:flex;
    justify-content:space-between;
    text-align:center;
    ">
    <div>
      <div style="font-size:14px;color:#666;">Total Invested</div>
      <div id="totalInvested" style="font-weight:700;font-size:18px;color:#0b7a4f;">0 USDT</div>
    </div>
    <div>
      <div style="font-size:14px;color:#666;">Total Income</div>
      <div id="totalIncome" style="font-weight:700;font-size:18px;color:#0b6be0;">0 USDT</div>
    </div>
  </div>

  <div id="historyList"></div>
</div>


<!-- small popup -->
<div id="popup"><div class="pbox" id="popupMessage"></div></div>

<!-- Firebase + App logic -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import {
    getFirestore, doc, setDoc, addDoc, collection, serverTimestamp,
    getDoc, onSnapshot, runTransaction, query, orderBy, where, getDocs, updateDoc, Timestamp
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  // ====== CONFIG ======
  const firebaseConfig = {
    apiKey: "AIzaSyDEQYPJFxQv8yFHptrTqoLHOn2L0PpgVhc",
    authDomain: "btcinvest-c0e25.firebaseapp.com",
    projectId: "btcinvest-c0e25",
    storageBucket: "btcinvest-c0e25.firebasestorage.app",
    messagingSenderId: "204937458487",
    appId: "1:204937458487:web:cc27ece1249999279f60b2",
    measurementId: "G-HG0Q8ZHT6G"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // UI elements
  const historyList = document.getElementById("historyList");
  const walletBalanceEl = document.getElementById("userBalance");
  const stakeInput = document.getElementById("stakeInput");

  let currentUserId = null;
  let currentPlanObj = null;

  // ‚úÖ small popup
  window.showPopup = (msg) => {
    document.getElementById("popupMessage").textContent = msg;
    document.getElementById("popup").style.display = "flex";
    setTimeout(()=>{ document.getElementById("popup").style.display = "none"; }, 2500);
  };

  // ‚úÖ Countdown
  function startCountdown(elId, endTime){
    const el = document.getElementById(elId);
    if(!el) return;
    function tick(){
      const now = Date.now();
      const diff = endTime - now;
      if(diff <= 0){
        el.textContent = " Crediting... please wait";
        return;
      }
      const hrs = Math.floor(diff / (1000*60*60));
      const mins = Math.floor((diff % (1000*60*60)) / (1000*60));
      const secs = Math.floor((diff % (1000*60)) / 1000);
      el.textContent = `${hrs}h ${mins}m ${secs}s`;
      setTimeout(tick, 1000);
    }
    tick();
  }

  // ‚úÖ Wallet listener
  function listenWallet(){
    const uRef = doc(db, "users", currentUserId);
    onSnapshot(uRef, snap => {
      if(!snap.exists()){ 
        walletBalanceEl.value = "0.00 USDT"; 
        return; 
      }
      const bal = snap.data().walletBalance || 0;
      walletBalanceEl.value = Number(bal).toFixed(2) + " USDT";
    });
  }

  // ‚úÖ Investment history listener
  function listenInvestments(){
    const invCol = collection(db, "users", currentUserId, "investments");
    const q = query(invCol, orderBy("startTime","desc"));

    onSnapshot(q, snap => {
      historyList.innerHTML = "";

      if(snap.empty){
        historyList.innerHTML = `
        <div style="text-align:center;color:#666;padding:20px;
        background:#fff;border-radius:10px;
        border:1px solid #eee;">
        No record found
        </div>`;
        return;
      }

      snap.forEach(docSnap => {
        const d = docSnap.data();
        const id = docSnap.id;

        const cls = d.status==="Completed" ? "status-complete" : 
                    d.status==="Active" ? "status-active" : "status-cancel";

        let countdownHtml = "";
        if(d.status==="Active" && d.endTime){
          countdownHtml = `<div class="countdown-box">
          <div class="countdown" id="cd_${id}">Loading...</div>
          </div>`;
          setTimeout(()=>startCountdown("cd_"+id, d.endTime.seconds*1000), 200);
        }

        historyList.innerHTML += `
        <div class="invest-card">
        <img src="${d.imgSrc || 'https://via.placeholder.com/150'}" alt="plan"/>
        <div class="invest-title">${d.planName || "TrustDollar Staking"}</div>
        <div class="invest-info">
        <p><span class="invest-label">Order Status</span>
        <span class="invest-value"><span class="status-badge ${cls}">${d.status}</span></span></p>
        <p><span class="invest-label">Investment Amount</span>
        <span class="invest-value">${Number(d.amount||0).toFixed(2)} USDT</span></p>
        <p><span class="invest-label">Accrued Income</span>
        <span class="invest-value">${Number(d.accruedIncome||0).toFixed(2)} USDT</span></p>
        <p><span class="invest-label">Possible Income</span>
        <span class="invest-value">${Number(d.possibleIncome||0).toFixed(2)} USDT</span></p>
        <p><span class="invest-label">Expiry Time</span>
        <span class="invest-value">${d.endTime ? new Date(d.endTime.seconds*1000).toLocaleString() : "-"}</span></p>
        </div>
        ${countdownHtml}
        </div>`;
      });
    });
  }

  // ‚úÖ User summary
  function listenUserSummary(){
    const uRef = doc(db, "users", currentUserId);
    onSnapshot(uRef, snap => {
      if(!snap.exists()) return;
      const d = snap.data();
      document.getElementById("totalInvested").textContent = (d.totalStack || 0) + " USDT";
      document.getElementById("totalIncome").textContent = (d.totalIncome || 0) + " USDT";
    });
  }

  // ‚úÖ Auth listener
  onAuthStateChanged(auth, user => {
    if(!user){
      showPopup("Not signed in. Redirect to login.");
      return;
    }
    currentUserId = user.uid;
    listenWallet();
    listenInvestments();
    listenUserSummary();

    setInterval(()=>processMatured(currentUserId), 60000);
    processMatured(currentUserId).catch(e=>console.error(e));

    setInterval(()=>processAccrual(currentUserId), 5*60*1000);
  });

 window.openModal = function(planName, minAmount, maxAmount, dailyRate, imgSrc){
  // modal me choose kiya gaya plan object me store karenge
  currentPlanObj = { planName, minAmount, maxAmount, dailyRate, imgSrc };

  // ‚úÖ Debug ke liye print karenge (console me dikhai dega)
  console.log("Plan Selected:", currentPlanObj);

  // modal UI fill karna
  document.getElementById("modalPlan").textContent = planName;
  document.getElementById("modalAmount").value = `${minAmount} - ${maxAmount} USDT`;
  document.getElementById("modalReturn").value = dailyRate + "% per day";
  document.getElementById("modalImg").src = imgSrc;
  document.getElementById("stakeModal").style.display = "flex";
};

window.closeModal = function(){
  document.getElementById("stakeModal").style.display = "none";
};


  // ‚úÖ Confirm Stake (possibleIncome add kiya)
// ‚úÖ Confirm Stake (with 0.5% fee + no upline income)
window.confirmStake = async function() {
  if (!currentUserId) {
    showPopup("User not authenticated");
    return;
  }

  if (!currentPlanObj || !currentPlanObj.planName || !currentPlanObj.dailyRate) {
    showPopup("Plan not selected properly ‚ùå");
    return;
  }

  const amount = parseFloat(stakeInput.value);
  if (isNaN(amount) || amount <= 0) {
    showPopup("Enter valid amount");
    return;
  }

  if (amount < currentPlanObj.minAmount || amount > currentPlanObj.maxAmount) {
    showPopup(
      `Amount must be between ${currentPlanObj.minAmount} and ${currentPlanObj.maxAmount}`
    );
    return;
  }

  // ‚úÖ 0.5% cut calculation
  const feePercent = 0.5;
  const feeAmount = +(amount * (feePercent / 100)).toFixed(2);
  const stakeAmount = +(amount - feeAmount).toFixed(2);

  closeModal();

  const userRef = doc(db, "users", currentUserId);

  try {
    await runTransaction(db, async (tx) => {
      const uSnap = await tx.get(userRef);
      if (!uSnap.exists()) throw "User data missing";

      const balance = uSnap.data().walletBalance || 0;
      if (balance < amount) throw "Insufficient balance";

      // ‚úÖ Cut total amount (including fee)
      tx.update(userRef, {
        walletBalance: balance - amount,
        totalStack: (uSnap.data().totalStack || 0) + stakeAmount
      });

      // ‚úÖ Plan duration
      const dailyRate = Number(currentPlanObj.dailyRate) || 0;
      let days = 1;
      const planName = (currentPlanObj.planName || "").toLowerCase();
      if (planName.includes("15")) days = 15;
      else if (planName.includes("30")) days = 30;

      const expiryDate = new Date(Date.now() + days * 24 * 60 * 60 * 1000);

      // ‚úÖ possible income calc (user gets 100%)
      const dailyProfit = stakeAmount * (dailyRate / 100);
      const possibleIncome = +(dailyProfit * days).toFixed(2);

      const stakeDoc = {
        amount: stakeAmount,         // ‚úÖ after 0.5% cut
        feeDeducted: feeAmount,
        feePercent: feePercent,
        startTime: serverTimestamp(),
        endTime: Timestamp.fromDate(expiryDate),
        status: "Active",
        dailyRate: dailyRate,
        planName: currentPlanObj.planName,
        imgSrc: currentPlanObj.imgSrc || "default.png",
        possibleIncome: possibleIncome,
        accruedIncome: 0,
        lastAccrual: serverTimestamp(),
        userPercent: 1.0,            // ‚úÖ 100% user ko hi milega
        upline1Percent: 0.0,
        upline2Percent: 0.0,
        upline3Percent: 0.0
      };

      const invCol = collection(db, "users", currentUserId, "investments");
      await addDoc(invCol, stakeDoc);

      // ‚úÖ Optional: agar chaahe fee admin UID me jaye
      // const adminRef = doc(db, "users", "ADMIN_UID_YAHAN_DAL");
      // const adminSnap = await tx.get(adminRef);
      // if (adminSnap.exists()) {
      //   tx.update(adminRef, {
      //     walletBalance: (adminSnap.data().walletBalance || 0) + feeAmount
      //   });
      // }
    });

    showPopup(`0.5% fee (${feeAmount} USDT) deducted. Stake created ‚úÖ`);
  } catch (err) {
    console.error(err);
    showPopup(typeof err === "string" ? err : "Error creating stake");
  }
};

// ‚úÖ process matured (3-level distribution logic) FIXED
async function processMatured(uid) {
  if (!uid) return;
  const invCol = collection(db, "users", uid, "investments");
  const q = query(invCol, where("status", "==", "Active"));
  const snap = await getDocs(q);
  if (snap.empty) return;
  const now = Date.now();

  for (const docSnap of snap.docs) {
    const d = docSnap.data();
    const id = docSnap.id;
    if (!d.startTime || !d.endTime) continue;

    const endMs = d.endTime.seconds * 1000;
    if (now < endMs) continue;

    // income dena sabhi ko user ko yanaha se diya jata hai 
    const invRef = doc(db, "users", uid, "investments", id);
    const userRef = doc(db, "users", uid);

    try {
      // ‚úÖ pehle sab reads kar liye
      const [invSnap, userSnap, up1Snap, up2Snap, up3Snap] = await Promise.all([
        getDoc(invRef),
        getDoc(userRef),
        d.upline1 ? getDoc(doc(db, "users", d.upline1)) : null,
        d.upline2 ? getDoc(doc(db, "users", d.upline2)) : null,
        d.upline3 ? getDoc(doc(db, "users", d.upline3)) : null,
      ]);

      if (!invSnap.exists()) continue;
      const invData = invSnap.data();
      if (invData.status !== "Active") continue;

      const uData = userSnap.exists() ? userSnap.data() : {};
      const amount = invData.amount || 0;
      const dailyRate = Number(invData.dailyRate) || 0;
      const durationDays = Math.round(
        (invData.endTime.seconds - invData.startTime.seconds) / (24 * 60 * 60)
      );

      const profit = (amount * dailyRate / 100) * durationDays;
      const possibleIncome = Number(profit.toFixed(6));

      // Percentages
      const userPercent = invData.userPercent ?? 0.70;
      const u1Percent = invData.upline1Percent ?? 0.17;
      const u2Percent = invData.upline2Percent ?? 0.08;
      const u3Percent = invData.upline3Percent ?? 0.05;

      // Shares
      const userShare = +(profit * userPercent).toFixed(6);
      const u1Share = +(profit * u1Percent).toFixed(6);
      const u2Share = +(profit * u2Percent).toFixed(6);
      const u3Share = +(profit * u3Percent).toFixed(6);

      // ‚úÖ Ab transaction me sirf updates
      await runTransaction(db, async (tx) => {
        tx.update(invRef, {
          status: "Completed",
          possibleIncome,
          accruedIncome: 0,
          endTime: serverTimestamp()
        });

        const userBal = uData.walletBalance || 0;
        tx.update(userRef, {
          walletBalance: userBal + amount + userShare,
          stakingIncome: (uData.stakingIncome || 0) + userShare,
          totalIncome: (uData.totalIncome || 0) + profit
        });

        if (up1Snap?.exists()) {
          const up1 = up1Snap.data();
          tx.update(up1Snap.ref, {
            walletBalance: (up1.walletBalance || 0) + u1Share,
            referralIncome: (up1.referralIncome || 0) + u1Share,
            totalIncome: (up1.totalIncome || 0) + u1Share
          });
        }
        if (up2Snap?.exists()) {
          const up2 = up2Snap.data();
          tx.update(up2Snap.ref, {
            walletBalance: (up2.walletBalance || 0) + u2Share,
            referralIncome: (up2.referralIncome || 0) + u2Share,
            totalIncome: (up2.totalIncome || 0) + u2Share
          });
        }
        if (up3Snap?.exists()) {
          const up3 = up3Snap.data();
          tx.update(up3Snap.ref, {
            walletBalance: (up3.walletBalance || 0) + u3Share,
            referralIncome: (up3.referralIncome || 0) + u3Share,
            totalIncome: (up3.totalIncome || 0) + u3Share
          });
        }
      });

      showPopup("Stake matured & income distributed ‚úÖ");

    } catch (err) {
      console.error("Error processing matured", err);
    }
  }
}


// ‚úÖ Section switch function
window.showSection = function(sectionId){
  // sab sections hide
  document.querySelectorAll(".section").forEach(sec => sec.style.display="none");

  // selected section show
  const target = document.getElementById(sectionId);
  if(target) target.style.display = "block";

  // nav active class
  document.querySelectorAll(".nav a").forEach(a=>a.classList.remove("active"));
  const navLink = [...document.querySelectorAll(".nav a")]
    .find(a=>a.getAttribute("onclick")?.includes(sectionId));
  if(navLink) navLink.classList.add("active");

  // ‚úÖ Save current section
  localStorage.setItem("lastSection", sectionId);
};

// ‚úÖ Restore last section on page load
document.addEventListener("DOMContentLoaded", () => {
  const last = localStorage.getItem("lastSection");
  if(last){
    showSection(last);   // last section khol do
  } else {
    showSection("staking"); // default
  }
});


</script>
<script>
  // üö´ Disable right click, select, drag
  document.addEventListener("contextmenu", e => e.preventDefault());
  document.addEventListener("selectstart", e => e.preventDefault());
  document.addEventListener("dragstart", e => e.preventDefault());

  // üö´ Disable keyboard shortcuts (copy, paste, inspect, etc.)
  document.addEventListener("keydown", e => {
    if (
      e.key === "F12" ||
      (e.ctrlKey && e.shiftKey && (e.key === "I" || e.key === "J")) ||
      (e.ctrlKey && (e.key === "U" || e.key === "C" || e.key === "X" || e.key === "V" || e.key === "S"))
    ) {
      e.preventDefault();
      return false;
    }
  });

  // üîí Silent DevTools detection (no popup)
  (function() {
    const devtools = /./;
    devtools.toString = function() {
      return ""; // no alert or console log
    };
    console.log("%c", devtools);
  })();

  // üîê Detect DevTools using resize trick (no popup)
  setInterval(() => {
    const threshold = 160;
    const widthDiff = window.outerWidth - window.innerWidth > threshold;
    const heightDiff = window.outerHeight - window.innerHeight > threshold;
    if (widthDiff || heightDiff) {
      // Optional: silently redirect or blank the page
      document.body.innerHTML = "";
    }
  }, 1000);

  // üß± Disable copy/paste/cut
  ["copy", "paste", "cut"].forEach(evt =>
    document.addEventListener(evt, e => e.preventDefault())
  );

  // üîÅ Freeze console methods silently
  Object.freeze(console);
  Object.freeze(window.console);
</script>

</body>
</html>

